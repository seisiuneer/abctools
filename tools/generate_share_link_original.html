<html>
  
  <head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <link rel="profile" href="http://gmpg.org/xfn/11">
    <title>Generate ABC Transcription Tools Share Link</title>

    <!--
      This page is a *developer example*: it shows how to generate a URL ("Share Link")
      that opens ABC Transcription Tools with ABC already loaded + optional settings.

      If you're embedding this in your own app/site, the ONLY essential parts are:
        - lz-string.min.js (for LZW mode)   OR
        - pako.min.js + TextEncoder (for Deflate mode)
        - the generateShareLink() function (and whatever UI you want around it)
    -->

    <link rel='dns-prefetch' href='//fonts.googleapis.com' />
    <link rel='dns-prefetch' href='//s.w.org' />
    <link rel='preconnect' href='https://secureservercdn.net' crossorigin />
    <meta property="og:type" content="website" />
    <meta property="og:title" content="Generate ABC Transcription Tools Share Link" />
    <meta property="og:description" content="Sample code for generating ABC Transcription Tool share links." />
    <meta property="og:url" content="https://michaeleskin.com/tools/create_share_link.html" />
    <meta property="og:site_name" content="Generate ABC Transcription Tools Share Link" />
    <meta property="og:image" content="https://michaeleskin.com/abctools/img/abc-icon.png" />
    <meta name="msapplication-TileColor" content="#ffffff">
    <meta name="msapplication-TileImage" content="https://michaeleskin.com/abctools/img/abc-ms-icon-144x144.png">
    <meta name="viewport" content="width=860">
    <link rel="apple-touch-icon" sizes="57x57" href="https://michaeleskin.com/abctools/img/abc-apple-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="60x60" href="https://michaeleskin.com/abctools/img/abc-apple-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="72x72" href="https://michaeleskin.com/abctools/img/abc-apple-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="76x76" href="https://michaeleskin.com/abctools/img/abc-apple-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="114x114" href="https://michaeleskin.com/abctools/img/abc-apple-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="120x120" href="https://michaeleskin.com/abctools/img/abc-apple-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="144x144" href="https://michaeleskin.com/abctools/img/abc-apple-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="https://michaeleskin.com/abctools/img/abc-apple-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="https://michaeleskin.com/abctools/img/abc-apple-icon-180x180.png">
    <link rel="icon" type="image/png" sizes="192x192" href="https://michaeleskin.com/abctools/img/abc-android-icon-192x192.png">
    <link rel="icon" type="image/png" sizes="32x32" href="https://michaeleskin.com/abctools/img/abc-favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="96x96" href="https://michaeleskin.com/abctools/img/abc-favicon-96x96.png">
    <link rel="icon" type="image/png" sizes="16x16" href="https://michaeleskin.com/abctools/img/abc-favicon-16x16.png">
    <link rel="manifest" href="https://michaeleskin.com/abctools/img/abc-manifest.json">

    <!--
      Analytics is unrelated to share-link generation.
      Remove if you are copying this into your own project.
    -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-VM0N9HL3MK"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-VM0N9HL3MK');
    </script>

    <style>
      /* (UI styling below is just for the demo page; not required for share link generation.) */

      textarea { width:600px;height:200px }
      body { background-color: #ffffff; padding:20px; }

      select{ margin-left:24px; }

      textarea#input { width: 100%; margin-bottom: 0px; }
      textarea#output { width: 100%; }

      p { font-size:12pt; font-family:"Helvetica"; line-height: 24px; margin-bottom:0px; }
      h1 { font-size:18pt; font-family:"Helvetica"; margin-bottom:0px; }
      h2 { font-size:14pt; font-family:"Helvetica"; margin-bottom:18px; }
      h4 { font-size:14pt; font-family:"Helvetica"; margin-bottom:8px; }
      hr { margin-top:24px; margin-bottom:24px; }

      .image_holder{ text-align: center; width:240px; height:240px; margin-left:auto; margin-right:auto; }

      #maindiv{
        position: absolute;
        left: 50%;
        margin-right: -50%;
        transform: translate(-50%, 0%);
        text-align: left;
        width: 800px;
        background-color: white;
      }

      .inputbox{ position:absolute; left:170px; }
      .recommended{ position:absolute; left:300px; }

      select {
        -webkit-appearance: none;
        -moz-appearance: none;
        appearance: none;
        background: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='100' height='100' fill='%238C98F2'><polygon points='0,0 100,0 50,50'/></svg>") no-repeat;
        background-size: 12px;
        background-position: calc(100% - 10px) center;
        background-repeat: no-repeat;
        background-color: #efefef;
        color:black;
      }

      #tablature_options{
        font-size:11pt;
        font-family:"Helvetica";
        height:32px;
        width:205px;
        margin-left:0px;
      }

      #layout{
        font-size:11pt;
        font-family:"Helvetica";
        height:32px;
        width:85px;
        margin-left:0px;
        margin-right:24px;
      }

      #root_scale{
        font-size:11pt;
        font-family:"Helvetica";
        height:32px;
        width:80px;
        margin-left:0px;
      }

      .btn {
        --color: #000000;
        --background-color: #d8d8d8;
        --border-color: darken(#d8d8d8, 7.5%);
        color: var(--color);
        font-family: helvetica !important;
        font-size: 11pt !important;
        background-color: var(--background-color);
        padding: 0.7rem 0.7rem;
        padding-top: 0.8rem;
        border: solid 1px var(--border-color);
        outline: none;
        position: relative;
        border-radius: 0.5rem;
        user-select: none;
        box-shadow: 0 0.1rem 0.1rem rgba(0, 0, 0, 0.25), 0 -0.1rem 0.5rem rgba(0, 0, 0, 0.1) inset;
        transition: box-shadow 64ms ease-out;
        -webkit-appearance:none;
      }

      .btn:after {
        content: "";
        background-color: #ffffff;
        width: 75%;
        height: 12.5%;
        position: absolute;
        top: 0.15rem;
        left: 12.5%;
        border-radius: 50%;
        filter: blur(0.15rem);
        transition: opacity 64ms ease-out;
      }

      .btn:active {
        box-shadow: 0 0 0 rgba(0, 0, 0, 0.4), 0 0.4rem 1rem rgba(0, 0, 0, 0.3) inset;
      }
      .btn:active:after { opacity: 0; }

      .btn-info { --color: #ffffff; --background-color: #0091ea; --border-color: #0079c4; }
      .btn-info:active { --color: #ececec; }
      .btn-success { --color: #ffffff; --background-color: #00c853; --border-color: #00a243; }
      .btn-success:active { --color: #ececec; }
      .btn-warning { --color: #3e2723; --background-color: #ffc400; --border-color: #d9a700; }
      .btn-warning:active { --color: #261815; }
      .btn-error { --color: #ffffff; --background-color: #d50000; --border-color: #af0000; }
      .btn-error:active { --color: #ececec; }
      .btn-dark { --color: #ffffff; --background-color: #303030; --border-color: #1d1d1d; }
      .btn-dark:active { --color: #ececec; }

      .btn-controls{ --color: black; --background-color: lavender; }
      .btn-generate{ --color: black; --background-color: #BBFFBB; }

      /* For modal dialog prompt replacement */
      .modal_flat_background { background-color: #000; opacity: 0.4; }
      .modal_flat_main { border: 1px solid #333; box-shadow: 0px 0px 15px -2px rgba(0,0,0,0.75);  }
      .modal_flat_main, .modal_flat_main input, .modal_flat_main button {  font-size: 16px; }
      .modal_flat_main input, .modal_flat_main button {  padding: 5px; box-sizing: border-box; }
      .modal_flat_inner { padding: 30px; background: #fff; color: #000; }
      .modal_flat_content { font-family:"Helvetica"; margin: 20px 0px;}
      .modal_flat_input { margin: 20px 0px;}
      .modal_flat_buttons { text-align:center;margin-top: 40px; }
      .modal_flat_main button { background-color: #ccc; color: #000; padding: 10px 20px; border: 0px; cursor: pointer; outline: none; width: 100px;  }
      .modal_flat_cancel {margin-left: 5px;}
    </style>
  </head>

  <body>
    <div id="maindiv">
      <div>
        <div style="text-align: center;">
          <h1>Generate ABC Transcription Tools Share Link</h1>
          <h2>Sample Code for 3rd Party Developers</h2>
        </div>
        
        <h4 style="margin-top:32px;">Instructions:&nbsp;&nbsp;<a href="#abcinput">Jump to Tool</a></h4>
        
        <p>1)&nbsp;Click "Open an existing .ABC file" to open a file or paste one or more ABC tunes into the box below.</p>
        <p>2)&nbsp;Choose your desired tablature display option from the "Tablature options" dropdown menu.
        <p>3)&nbsp;If you want to have the Player in the tool automatically open when a user opens the Share Link, check the "Add Auto-Play to Share Link" checkbox.
        <p>4)&nbsp;Select your desired compression algorithm (LZW or Deflate) from the Compression options.</p>
        <p>5)&nbsp;Click "Generate Share Link".</p>
        <p>The generated share link will appear in the "Generated Share Link" box.</p>
        <p>6)&nbsp;Save, Copy or Test the results:</p>
        <p>Click "Save Output to a file" to save the results to a file.</p>
        <p>Click "Copy Output to the clipboard" to copy the results to the system clipboard for pasting into other applications.</p>
        <p>Click "Test Output in the ABC Transcription Tools" to open and test the Share Link in my <a href="https://michaeleskin.com/abctools/abctools.html" target="_blank">ABC Transcription Tools</a></p>
      </div>
      
      <hr id="abcinput">
      
      <div style="text-align:left">
        <h4>ABC Input:</h4>
        
        <div style="margin-top:28px;margin-bottom:36px;">
          <p>
            <input type="file" id="selectabcfile" accept=".abc,.txt,.ABC,.TXT"  hidden/>
            <label class="abcupload btn btn-controls" for="selectabcfile" title="Opens an existing ABC file">Open an existing .ABC file</label>
          </p>
        </div>

        <p>
          <textarea id="input" placeholder="Enter ABC notation here" spellcheck="false" autocorrect="off" autocapitalize="none">
          </textarea>
        </p>
      
        <p>
          <span style="">Tablature options:&nbsp;&nbsp;</span>
          <select id="tablature_options">
            <option value="noten">&nbsp;&nbsp;Standard notation only</option>
            <option value="notenames">&nbsp;&nbsp;Note names</option>
            <option value="mandolin">&nbsp;&nbsp;Mandolin</option>
            <option value="gdad">&nbsp;&nbsp;GDAD Bouzouki</option>
            <option value="cgda">&nbsp;&nbsp;CGDA Mandola</option>
            <option value="cgdae">&nbsp;&nbsp;CGDAE Bouzouki</option>
            <option value="dgdae">&nbsp;&nbsp;DGDAE Bouzouki</option>
            <option value="guitare">&nbsp;&nbsp;Standard tuned guitar</option>
            <option value="guitard">&nbsp;&nbsp;DADGAD tuned guitar</option>
            <option value="uke">&nbsp;&nbsp;Ukulele</option>
            <option value="whistle">&nbsp;&nbsp;Whistle</option>
          </select>
        </p>

        <p><input type="checkbox" id="addAutoPlay" checked="true">&nbsp;&nbsp;Add Auto-Play to Share Link</p>

        <!-- Compression mode selection.
             In your own tool/app, you can pick one mode and remove this UI entirely. -->
        <p style="margin-top:8px;margin-bottom:8px;font-size:11pt;font-family:Helvetica;">
          <span>Compression:</span>
          <label style="margin-left:12px;">
            <input type="radio" name="compressionMode" value="deflate" checked> Deflate
          </label>
          <label style="margin-left:12px;">
            <input type="radio" name="compressionMode" value="lzw"> LZW (Legacy)
          </label>
        </p>
      
        <p style="margin-top:24px"><button id="generateShareLink" class="btn btn-generate" onClick="UI_GenerateShareLink();">Generate Share Link</button></p>
        
        <div style="margin-bottom: 8px;">
          <h4>Generated Share Link:</h4>
        </div>

        <!-- Link-size display is demo-only, but it's useful because Share Links have a practical max length. -->
        <p id="linkSize" style="font-size:11pt;font-family:Helvetica;margin-bottom:8px;"></p>
        
        <textarea id="output" placeholder="Generated Share Link will appear here" spellcheck="false" autocorrect="off" autocapitalize="none"></textarea>
        
        <p style="margin-top:20px;">
          <button id="copybutton" class="btn btn-controls" onClick="copyOutputToClipboard();">Copy Share Link to the clipboard</button>
          <button style="margin-left:24px;" class="btn btn-controls" onClick="saveOutput();">Save Share Link to a file</button>
          <button style="margin-left:24px;" class="btn btn-controls" onClick="testOutput();">Test Share Link in the ABC Transcription Tools</button>
        </p>
      </div>
                  
      <hr>
      
      <div style="text-align: center;">
        <p style="text-align: center">Complete source code for this utility may be found on GitHub</p>
        <p style="text-align: center"> <a href="https://github.com/seisiuneer/abctools/tree/main/tools" target="_blank">Generate ABC Transcription Tools Share Link on Github</a></p>
        <hr style="margin-bottom:50px">
      </div>
    </div>
  </body>
  
  <!--
    REQUIRED LIBRARIES FOR SHARE LINKS:

    1) LZ-String:
       Needed if you want to build LZW-based links using the "lzw=" URL parameter.
       (This is the long-standing/standard share-link method.)

    2) Pako:
       Needed if you want to build Deflate-based links using the "def=" URL parameter.
       (Typically produces shorter links for larger ABC.)

    3) DayPilot:
       Not required for share-link generation. This demo uses it only for nice alert/prompt dialogs.
  -->
  <script type="text/javascript" src="lz-string.min.js?v=2"></script>
  <script type="text/javascript" src="pako.min.js?v=1"></script>
  <script type="text/javascript" src="daypilot-modal.min-3.10.1.js?v=2"></script>

  <script>

// ********************************************************************************************************************
//
// Generate an ABC Transcription Tools Share Link from ABC with specified share name and optional auto-play when opened
//
// If you are building share link generation into your own web page or Javascript tool, all you need is the
// generateShareLink() function and including the lz-string.min.js and pako.min.js files in your project.
//
// This sample supports two *equivalent* ways to embed ABC into a URL:
//
//   A) LZW mode (standard / compatible / simple):
//        https://michaeleskin.com/abctools/abctools.html?lzw=<LZString.compressToEncodedURIComponent(ABC)>&...
//
//   B) Deflate mode (often shorter for large ABC):
//        https://michaeleskin.com/abctools/abctools.html?def=<base64url(deflate(utf8(ABC)))>&...
//
// In both cases, the rest of the URL is just normal query parameters that configure the tool.
//
// ********************************************************************************************************************

// Read selected compression mode from radio buttons (demo UI helper).
// In your own application you can:
//   - hardcode a choice (LZW or Deflate), OR
//   - provide your own UI, OR
//   - decide dynamically (e.g., try Deflate first, fall back to LZW if needed).
function getSelectedCompressionMode() {
    var radios = document.getElementsByName("compressionMode");
    var mode = COMPRESSION_MODE_LZW;
    for (var i = 0; i < radios.length; i++) {
        if (radios[i].checked) {
            mode = (radios[i].value === "deflate") ? COMPRESSION_MODE_DEFLATE : COMPRESSION_MODE_LZW;
            break;
        }
    }
    return mode;
}

// Compression mode ids (internal to this demo)
var COMPRESSION_MODE_LZW = 0;      // uses "lzw=" param (LZString output)
var COMPRESSION_MODE_DEFLATE = 1;  // uses "def=" param (Deflate + Base64URL output)

//
// Main function for generating a share link
//
// PARAMETERS (what a 3rd-party developer usually provides):
//   abcText          = The ABC text you want loaded when the link opens
//   shareName        = Title shown by the tools (you typically URL-encode it first)
//   tablatureOption  = The tools "format" parameter (e.g., noten, whistle, uke, etc.)
//   addAutoPlay      = If true, adds play=1 so the Player auto-opens
//
// RETURNS:
//   A fully-formed URL string, or null if it would exceed the max length.
//
function generateShareLink(abcText, shareName, tablatureOption, addAutoPlay) {

    // ----------------------------
    // Deflate mode helpers
    // ----------------------------
    // Deflate returns a byte array (Uint8Array). URLs need *text*, so we encode bytes to Base64,
    // then convert Base64 to "Base64URL" (safe for query strings without extra escaping).
    //
    // If you implement this in another language (Swift, Python, etc.), the algorithm is the same:
    //   utf8_bytes = UTF8(abcText)
    //   deflated   = DEFLATE(utf8_bytes, level=6)
    //   b64        = BASE64(deflated)
    //   b64url     = b64 with '+'->'-', '/'->'_', and strip trailing '=' padding
    function bytesToBase64(bytes) {
        var binary = "";
        var len = bytes.length;
        for (var i = 0; i < len; i++) {
            binary += String.fromCharCode(bytes[i]);
        }
        return btoa(binary);
    }

    function bytesToBase64URL(bytes) {
      return bytesToBase64(bytes)
          .replace(/\+/g, "-")
          .replace(/\//g, "_")
          .replace(/=+$/, "");
    }

    // ----------------------------
    // LZW mode helper
    // ----------------------------
    // LZ-String already returns a URL-safe encoding with compressToEncodedURIComponent().
    function compressABC_LZW(abcText) {
        return LZString.compressToEncodedURIComponent(abcText);
    }

    // ----------------------------
    // Deflate compression helper
    // ----------------------------
    // Uses pako.deflate() at level 6 (a good size/speed trade-off).
    // NOTE: TextEncoder is supported in modern browsers. If you need older compatibility,
    // you would add a UTF-8 encoding polyfill.
    function compressABC_Deflate(abcText) {
      if (typeof pako === "undefined") {
          throw new Error("pako (Deflate library) is not loaded.");
      }
      var encoder = new TextEncoder();
      var utf8Bytes = encoder.encode(abcText);
      var deflated = pako.deflate(utf8Bytes, { level: 6 });
      return bytesToBase64URL(deflated);
    }

    // ----------------------------
    // 1) Base URL (the tool you're launching)
    // ----------------------------
    // Your code always starts from this URL, then adds query parameters.
    var baseUrl = "https://michaeleskin.com/abctools/abctools.html";

    // ----------------------------
    // 2) Choose compression mode
    // ----------------------------
    // Demo uses a radio button. Replace with your own logic as needed.
    var compressionMode = getSelectedCompressionMode();

    // ----------------------------
    // 3) Build the URL query string
    // ----------------------------
    // Important parameters used here:
    //   - lzw=... OR def=...   (this is the embedded ABC payload)
    //   - format=...           (tablature/notation mode)
    //   - name=...             (display name/title)
    //   - ssp=10               (example of passing other tool options)
    //   - play=1               (optional: auto-open the player)
    //
    // NOTE: shareName should be URL-safe.
    // In this demo, shareName is already a simple string ("Share_Link_Test"),
    // but in real use you should do: encodeURIComponent(shareName).
    var url = "";
    if (compressionMode === COMPRESSION_MODE_DEFLATE) {

        // Deflate-based link: def=...
        // This typically yields shorter URLs for longer ABC text.
        var defEncoded = compressABC_Deflate(abcText);

        url = baseUrl
            + "?def=" + defEncoded
            + "&format=" + tablatureOption
            + "&ssp=10"
            + "&name=" + shareName;

        if (addAutoPlay) {
            url += "&play=1";
        }

    } else {

        // LZW-based link: lzw=...
        // Very simple: compress and drop it in as a query parameter.
        var abcInLZW = compressABC_LZW(abcText);

        url = baseUrl
            + "?lzw=" + abcInLZW
            + "&format=" + tablatureOption
            + "&ssp=10"
            + "&name=" + shareName;

        if (addAutoPlay) {
            url += "&play=1";
        }
    }

    // ----------------------------
    // 4) Enforce the practical URL-length limit
    // ----------------------------
    // Browsers, proxies, and servers can reject very long URLs.
    // This demo uses 8100 as a safe-ish maximum (consistent with your tool ecosystem).
    if (url.length > 8100) {
        return null;
    }

    return url;
}

//
// Optional developer sanity-check: verify that a generated share link "round-trips" correctly.
//
// This is *not required* to generate a share link, but it's useful if you're implementing the
// encoder/decoder in another language and want to confirm you didn't break UTF-8 or Base64URL.
//
// Decoder logic:
//   If lzw param present -> LZString.decompressFromEncodedURIComponent()
//   Else if def param present -> Base64URL decode -> pako.inflate() -> UTF-8 decode
//
function verifyShareLink(url, originalABC) {

    // ----------------------------
    // Deflate-based decompression helpers
    // ----------------------------
    function base64ToBytes(base64) {
        var binary = atob(base64);
        var len = binary.length;
        var bytes = new Uint8Array(len);
        for (var i = 0; i < len; i++) {
            bytes[i] = binary.charCodeAt(i);
        }
        return bytes;
    }

    // Base64URL is just Base64 with a few substitutions + stripped padding.
    // To decode, reverse the substitutions and restore padding to a multiple of 4 chars.
    function base64URLToBytes(base64url) {
        var base64 = base64url
            .replace(/-/g, "+")
            .replace(/_/g, "/");

        var pad = base64.length % 4;
        if (pad === 2) base64 += "==";
        else if (pad === 3) base64 += "=";
        else if (pad !== 0) {
            throw new Error("Invalid Base64URL length");
        }
        return base64ToBytes(base64);
    }

    function decompressABC_Deflate(encoded) {
        if (typeof pako === "undefined") {
            throw new Error("pako (Deflate library) is not loaded.");
        }
        var deflatedBytes = base64URLToBytes(encoded);
        var inflatedBytes = pako.inflate(deflatedBytes);
        var decoder = new TextDecoder();
        return decoder.decode(inflatedBytes);
    }

    try {
        var qIndex = url.indexOf("?");
        if (qIndex === -1) return false;

        var query = url.substring(qIndex + 1);
        var params = new URLSearchParams(query);

        var reconstructed = null;

        var lzwParam = params.get("lzw");
        var defParam = params.get("def");

        if (lzwParam != null) {
            // LZW mode: one-liner decode
            reconstructed = LZString.decompressFromEncodedURIComponent(lzwParam);
        } else if (defParam != null) {
            // Deflate mode: Base64URL -> bytes -> inflate -> UTF-8 string
            reconstructed = decompressABC_Deflate(defParam);
        } else {
            // No ABC payload found in the URL
            return false;
        }

        if (reconstructed === null) return false;

        // Exact string match: this will catch subtle issues like newline normalization or encoding bugs.
        return reconstructed === originalABC;

    } catch (e) {
        console.log("verifyShareLink error:", e);
        return false;
    }
}

// ********************************************************************************************************************
//
// The rest of this Javascript is specfically for use by the Share Link demo application.
// You do not need to include it in your own web page or Javascript tool
//
// ********************************************************************************************************************

// Globals

// Suggested filename for save
var gSaveFilename = "";

//
// Main processor
//
function UI_GenerateShareLink(){

    // Get the source ABC
    var abcText = document.getElementById('input').value;

    if (abcText.length == 0) {

        DayPilot.Modal.alert("No input to process!", {
            theme: "modal_flat",
            top: 50
        });

        return;
    }

    // Auto-play requested?
    var addAutoPlay = false;

    if  (document.getElementById('addAutoPlay').checked){
        addAutoPlay = true;
    }

    // Get the tablature option from the dropdown
    var tablatureOption = document.getElementById('tablature_options').value;

    //
    // Generate the Share Link
    //
    // NOTE FOR DEVELOPERS:
    //   - Replace "Share_Link_Test" with your own title (ideally encodeURIComponent()).
    //   - Pass whatever tablatureOption/format you want.
    //   - Decide whether to add play=1 (auto-open player).
    var url = generateShareLink(abcText, "Share_Link_Test", tablatureOption, addAutoPlay);

    if (url == null){
       DayPilot.Modal.alert("ABC text is too long to generate a valid Share Link!", {
            theme: "modal_flat",
            top: 50
        });

        // clear size display
        var sz = document.getElementById("linkSize");
        if (sz) {
            sz.innerHTML = "";
        }
    }
    else{

        document.getElementById("output").value = url;

        // show link size (handy when you're tuning compression decisions)
        var sz = document.getElementById("linkSize");
        if (sz) {
            sz.innerHTML = "Share link length: " + url.length + " characters";
        }

        // verify round-trip (optional developer check)
        var ok = verifyShareLink(url, abcText);
        if (!ok) {
            DayPilot.Modal.alert("Warning: The decompressed Share Link does not match the original ABC text!", {
                theme: "modal_flat",
                top: 50
            });
        }

        // Give some feedback
        document.getElementById("generateShareLink").innerHTML = "Share Link Generated!";

        setTimeout(function() {
            document.getElementById("generateShareLink").innerHTML = "Generate Share Link";
        }, 1250);
       
    }
}

//
// Save the Output to a file
//
function saveOutput() {

    var theData = document.getElementById("output").value;

    if (theData.length == 0) {

        DayPilot.Modal.alert("Nothing to save!", {
            theme: "modal_flat",
            top: 50
        });

        return;
    }

    if (gSaveFilename == ""){
        gSaveFilename = "abc_tools_share_link";
    }

    var thePlaceholder = gSaveFilename;

    var thePrompt = "Please enter a filename for your output Share Link file:";

    DayPilot.Modal.prompt(thePrompt, thePlaceholder, {
        theme: "modal_flat",
        top: 194,
        autoFocus: false
    }).then(function(args) {

        var fname = args.result;

        // If the user pressed Cancel, exit
        if (fname == null) {
            return null;
        }

        // Strip out any naughty HTML tag characters
        fname = fname.replace(/[^a-zA-Z0-9_\-. ]+/ig, '');

        if (fname.length == 0) {
            return null;
        }

        // Give it a good extension
        if ((!gIsAndroid) && (!gIsIOS)) {

            if ((!fname.endsWith(".txt")) && (!fname.endsWith(".TXT"))) {
                fname = fname.replace(/\..+$/, '');
                fname = fname + ".txt";
            }

        } else {
            // iOS and Android have odd rules about text file saving
            fname = fname.replace(/\..+$/, '');
            fname = fname + ".txt";
        }
        
        var a = document.createElement("a");

        document.body.appendChild(a);

        a.style = "display: none";

        var blob = new Blob([theData], { type: "text/plain" });

        var url = window.URL.createObjectURL(blob);
        a.href = url;
        a.download = fname;
        a.click();

        document.body.removeChild(a);

        setTimeout(function() {
            window.URL.revokeObjectURL(url);
        }, 1000);

    });

}

//
// Copy the output text are to the clipboard 
// 
function copyOutputToClipboard() {

    var textToCopy = document.getElementById('output').value;

    if (textToCopy.length == 0) {

        DayPilot.Modal.alert("Nothing to copy!", {
            theme: "modal_flat",
            top: 50
        });

        return;

    }

    copyToClipboard(textToCopy);

    // Give some feedback
    document.getElementById("copybutton").innerHTML = "Share link copied!";

    setTimeout(function() {
        document.getElementById("copybutton").innerHTML = "Copy share link to the clipboard";
    }, 1250);
}

//
// Copy to Clipboard Polyfill
//
function copyToClipboard(textToCopy) {

    try {

        // navigator clipboard api needs a secure context (https)
        if (navigator.clipboard && window.isSecureContext) {
            return navigator.clipboard.writeText(textToCopy);
        } else {

            let textArea = document.createElement("textarea");
            textArea.value = textToCopy;

            // make the textarea out of viewport
            textArea.style.position = "fixed";
            textArea.style.left = "-999999px";
            textArea.style.top = "-999999px";

            document.body.appendChild(textArea);

            textArea.focus();
            textArea.select();

            return new Promise((res, rej) => {
                document.execCommand('copy') ? res() : rej();
                textArea.remove();
            });
        }

    } catch (error) {
        console.log("CopyToClipboard error: " + error);
    }
}

//
// Generate and open an ABC Transcription Tools Share URL for the output
//
function testOutput() {

    var url = document.getElementById('output').value;

    if (url.length > 8100) {

        DayPilot.Modal.alert("Output too long to test!", {
            theme: "modal_flat",
            top: 50
        });

        return;
    }

    // Open the transcription tools with the share link
    var w = window.open(url);
}

//
// Are we on iOS?
//
function isIOS() {
    if (/iPad|iPhone|iPod/.test(navigator.platform)) {
        return true;
    } else {
        return navigator.maxTouchPoints &&
            navigator.maxTouchPoints > 2 &&
            /MacIntel/.test(navigator.platform);
    }
}

//
// Are we on an iPhone?
//
function isIPhone() {
    if (/iPad|iPhone|iPod/.test(navigator.platform)) {
        return true;
    } else {
        return false;
    }
}

//
// Are we on an iPad?
//
function isIPad() {
    return navigator.maxTouchPoints &&
        navigator.maxTouchPoints > 2 &&
        /MacIntel/.test(navigator.platform);
}

//
// Are we on Android?
//
function isAndroid() {
    if (/Android/i.test(navigator.userAgent)) {
        return true;
    } else {
        return false;
    }
}

//
// Globals
//
var gIsIOS = false;
var gIsAndroid = false;

//
// Initialization 
//
function DoStartup() {

    // Demo ABC pre-fill (not needed for developers using generateShareLink() elsewhere)
    var theValue = "";
    theValue += "X: 1\n";
    theValue += "T: The Kesh\n";
    theValue += "R: Jig\n";
    theValue += "M: 6/8\n";
    theValue += "L: 1/8\n";
    theValue += "K: Gmaj\n";
    theValue += "C: Traditional\n";
    theValue += '|:GAG GAB|ABA ABd|edd gdd|edB dBA|\n';
    theValue += 'GAG GAB|ABA ABd|edd gdB|AGF G3:|\n';
    theValue += '|:BAB dBd|ege dBA|BAB dBG|ABA AGA|\n';
    theValue += 'BAB dBd|ege dBd|gfg aga|bgf g3:|\n';

    document.getElementById('input').value = theValue;
    document.getElementById('output').value = "";

    var sz = document.getElementById("linkSize");
    if (sz) sz.innerHTML = "";

    // Reset file selectors
    var fileElement = document.getElementById('selectabcfile');
    fileElement.value = "";

    // Platform detection (demo UI behavior only)
    gIsIOS = isIOS();
    gIsAndroid = isAndroid();

    if (gIsIOS) {
        // iOS can be picky about "accept" filters; demo removes it.
        document.getElementById("selectabcfile").removeAttribute("accept");
    }

    //
    // Setup the file import control (demo-only)
    //
    document.getElementById("selectabcfile").onchange = () => {

        let fileElement = document.getElementById("selectabcfile");
        let file = fileElement.files[0];

        gSaveFilename = file.name;

        // Normalize filename for saves
        gSaveFilename = gSaveFilename.trim();
        gSaveFilename = gSaveFilename.replace(/[^a-zA-Z0-9_\-. ]+/ig, '');
        gSaveFilename = gSaveFilename.replace(/\s/g, '_');
        gSaveFilename = gSaveFilename.replace(/\..+$/, '');
       
        // Clean up the notation while the new file is loading
        document.getElementById('input').value = "";

        const reader = new FileReader();

        reader.addEventListener('load', (event) => {

            document.getElementById('input').value = event.target.result;

            // Reset file selector so the same file can be re-selected if desired
            let fileElement = document.getElementById('selectabcfile');
            fileElement.value = "";
        });

        reader.readAsText(file);
    }
}

//
// Wait for the document to be ready, then fire a function
//
function WaitForReady(fn) {

    if (document.readyState !== 'loading') {
        fn();
        return;
    }

    document.addEventListener('DOMContentLoaded', fn);
}

//
// Wait for the document to be ready, then startup
//
WaitForReady(DoStartup);

</script>
  
</html>
