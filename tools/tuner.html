<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <meta property="og:type" content="website" />
  <meta property="og:title" content="Chromatic Tuner" />
  <meta property="og:description" content="Simple chromatic instrument tuner. Adjustable temperament (ET, Just Intonation, Pythagorean, Fiddle sweetened), A4 reference, and input boost." />
  <meta property="og:url" content="https://michaeleskin.com/tools/tuner.html" />
  <meta property="og:site_name" content="Chromatic Tuner" />
  <meta property="og:image" content="https://michaeleskin.com/abctools/img/abc-icon.png" />
  <meta name="msapplication-TileColor" content="#ffffff">
  <meta name="msapplication-TileImage" content="https://michaeleskin.com/abctools/img/abc-ms-icon-144x144.png">
  <link rel="apple-touch-icon" sizes="57x57" href="https://michaeleskin.com/abctools/img/abc-apple-icon-57x57.png">
  <link rel="apple-touch-icon" sizes="60x60" href="https://michaeleskin.com/abctools/img/abc-apple-icon-60x60.png">
  <link rel="apple-touch-icon" sizes="72x72" href="https://michaeleskin.com/abctools/img/abc-apple-icon-72x72.png">
  <link rel="apple-touch-icon" sizes="76x76" href="https://michaeleskin.com/abctools/img/abc-apple-icon-76x76.png">
  <link rel="apple-touch-icon" sizes="114x114" href="https://michaeleskin.com/abctools/img/abc-apple-icon-114x114.png">
  <link rel="apple-touch-icon" sizes="120x120" href="https://michaeleskin.com/abctools/img/abc-apple-icon-120x120.png">
  <link rel="apple-touch-icon" sizes="144x144" href="https://michaeleskin.com/abctools/img/abc-apple-icon-144x144.png">
  <link rel="apple-touch-icon" sizes="152x152" href="https://michaeleskin.com/abctools/img/abc-apple-icon-152x152.png">
  <link rel="apple-touch-icon" sizes="180x180" href="https://michaeleskin.com/abctools/img/abc-apple-icon-180x180.png">
  <link rel="icon" type="image/png" sizes="192x192" href="https://michaeleskin.com/abctools/img/abc-android-icon-192x192.png">
  <link rel="icon" type="image/png" sizes="32x32" href="https://michaeleskin.com/abctools/img/abc-favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="96x96" href="https://michaeleskin.com/abctools/img/abc-favicon-96x96.png">
  <link rel="icon" type="image/png" sizes="16x16" href="https://michaeleskin.com/abctools/img/abc-favicon-16x16.png">

  <script async src="https://www.googletagmanager.com/gtag/js?id=G-VM0N9HL3MK"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-VM0N9HL3MK');
  </script>

  <title>Chromatic Tuner</title>

  <style>
    :root{
      --accent:#00f2ff;
      --bg:#0f0f0f;
      --panel:#1a1a1a;
      --text:#e0e0e0;
      --ui-max: 800px;
    }

    body{
      font-family:'Segoe UI',sans-serif;
      background:var(--bg);
      color:var(--text);
      margin:0;
      padding:20px;
      display:flex;
      flex-direction:column;
      align-items:center;
    }

    #tuner-ui{
      background:var(--panel);
      border-radius:16px;
      padding:22px;
      box-shadow:0 20px 50px rgba(0,0,0,0.7);
      width:100%;
      text-align:center;
      border:1px solid #333;
      position:relative;
      max-width: var(--ui-max);
    }

    /* instructions (?) button */
    #help-btn{
      position:absolute;
      top:8px;
      left:8px;
      width:52px;
      height:52px;
      border: 0px;
      color:#e8e8e8;
      font-weight:900;
      font-size:1.75rem;
      line-height:52px;
      text-align:center;
      cursor:pointer;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }
    @media (hover: hover) and (pointer: fine) {
      #help-btn{ transition: filter 125ms ease; }
      #help-btn:hover{ filter: brightness(1.5); }
      #help-btn:active{ filter: brightness(1.0); }
    }

    /* Small subtle volume level meter */
    #level-meter{
      position:absolute;
      top:22px;
      height:10px;
      right:22px;
      width:86px;
      border-radius:3px;
      background:#0a0a0a;
      border:1px solid #2f2f2f;
      box-shadow: inset 0 0 0 1px rgba(255,255,255,0.02);
      overflow:hidden;
      opacity:0.55;
      pointer-events:none;
      transform: translateY(calc((1.6rem * 1.1 - 10px) / 2));
    }
    #level-meter-fill{
      height:100%;
      width:0%;
      background:var(--accent);
      opacity:0.65;
      transition: width 80ms linear;
    }

    /* instructions modal */
    #instructions-overlay{
      display:none;
      position:fixed;
      inset:0;
      background:rgba(0,0,0,0.65);
      z-index:9999;
      padding:16px;
      box-sizing:border-box;
    }

    /* Make the modal match the tuner UI height, and keep Close button pinned */
    #instructions-modal{
      max-width:700px;
      width:100%;
      margin:0 auto;
      background:var(--panel);
      border:1px solid #333;
      border-radius:16px;
      box-shadow:0 20px 50px rgba(0,0,0,0.7);
      padding:18px;
      box-sizing:border-box;
      position:relative;
      top:0vh;
      text-align:left;

      /* NEW: flex layout + height sync */
      display:flex;
      flex-direction:column;

      /* fallback */
      max-height: calc(100vh - 32px - 6vh);

      /* NEW: will be set by JS to match #tuner-ui height */
      height: auto;
    }

    #instructions-title{
      font-size:1.25rem;
      font-weight:900;
      margin:0 0 15px 0;
      color:#e0e0e0;
      flex: 0 0 auto;
    }

    /* NEW: scrolling container */
    #instructions-scroll{
      flex: 1 1 auto;
      overflow:auto;
      -webkit-overflow-scrolling: touch;
      border:1px solid #2a2a2a;
      border-radius:12px;
      padding:12px 12px;
      background:#0b0b0b;
      box-shadow: inset 0 0 0 1px rgba(255,255,255,0.02);
    }

    #instructions-body{
      font-size:1.0rem;
      line-height:1.6;
      color:#e0e0e0;
      margin:0 0 14px 0;
      padding-top:6px;
    }

    #instructions-close{
      width:100%;
      margin-top:12px;
      margin-bottom:-7px;
      padding:14px 18px;
      border:1px solid #333;
      font-weight:900;
      cursor:pointer;
      transition:.2s;
      font-size:1.15rem;
      background:var(--accent);
      color:#FEFEFE;
      background-color: black;
      flex: 0 0 auto;
    }

    .instructions-subtitle{
      font-weight:900;
      font-size:1.1rem;
      margin:0 0 10px 0;
      color:#f0f0f0;
    }

    .instructions-subbody{
      margin:0 0 14px 0;
      color:#e6e6e6;
    }

    @media (max-width: 600px) {
      #help-btn{
        top:0px;
        left:0px;
      }
      #instructions-close{
        font-size:1.2rem;
        padding:16px 18px;
        border-radius:14px;
      }

      #level-meter{
        width:74px;
        height:9px;
        opacity:0.5;
        right:22px;
        transform: translateY(calc((1.25rem * 1.1 - 9px) / 2));
      }
    }

    /* Only dim the "live" area */
    #tuner-live{
      transition: opacity 125ms ease, filter 125ms ease;
    }
    #tuner-live.dimmed{
      opacity: 0.3;
      filter: saturate(0.85);
      transition-duration: 550ms, 550ms;
    }

    .row{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap:12px;
      margin:10px 0 10px;
      align-items:start;
    }

    /* Make the 2nd row use 2 equal columns (full-width with no empty third column) */
    .row-intonation{
      grid-template-columns: 1fr 1fr;
    }

    label{
      display:block;
      font-size:0.85rem;
      color:#bbb;
      margin-bottom:6px;
      text-align:left;
    }
    select{
      width:100%;
      background:#0b0b0b;
      color:#e8e8e8;
      border:1px solid #333;
      border-radius:10px;
      padding:10px 10px;
      font-size:0.95rem;
    }

    /* Disabled: dim + not-allowed cursor (including dropdown wrapper area) */
    select:disabled{
      cursor: not-allowed;
      opacity: 0.45;
    }

    .note-display{
      font-size:5rem;
      color:#fff;
      line-height:1;
      margin:0;
      text-shadow:0 0 20px var(--accent);
      font-weight:900;
      margin-top: 32px;
    }

    .freq-display{
      font-size:1.35rem;
      color:#FEFEFE;
      font-family:ui-monospace, Menlo, Consolas, monospace;
      margin-top:10px;
      margin-bottom:10px;
      line-height:1.35;
      font-weight:800;
    }

    .meter-box{
      width:100%;
      height:90px;
      background:#000;
      position:relative;
      border-radius:10px;
      margin:18px 0 8px;
      border:1px solid #333;
      overflow:hidden;
    }

    #strobe-layer{
      position:absolute;
      inset:0;
      display:none;
      z-index:1;
      overflow:hidden;
      pointer-events:none;
      opacity:0.95;
      background:#050a2a;
      box-shadow: inset 0 0 18px rgba(0,0,0,0.55);
    }

    body.not-started #strobe-layer{
      opacity:0.25;
      filter:saturate(0.85);
    }

    #strobe-pattern{
      position:absolute;
      inset:-40px;
      will-change: background-position;

      --strobe-cyan: #21c7ff;
      --strobe-navy: #07104a;

      background-image:
        linear-gradient(
          90deg,
          var(--strobe-navy) 0px,
          var(--strobe-navy) 16px,
          var(--strobe-cyan) 16px,
          var(--strobe-cyan) 32px
        ),
        linear-gradient(
          180deg,
          rgba(255,255,255,0.10) 0%,
          rgba(255,255,255,0.03) 18%,
          rgba(0,0,0,0.10) 55%,
          rgba(0,0,0,0.18) 100%
        );

      background-repeat: repeat, no-repeat;
      background-size: 32px 100%, 100% 100%;
      background-position: 0px 0px, 0px 0px;
    }

    #strobe-center{
      position:absolute;
      left:50%;
      top:0;
      height:100%;
      width:2px;
      background:var(--accent);
      opacity:0.30;
    }

    #needle{
      width:3px;
      height:100%;
      background:#ff3e3e;
      position:absolute;
      left:50%;
      transform:translateX(-50%);
      transition:left .10s ease-out, background-color .10s ease-out;
      z-index:2;
    }

    body.not-started.mode-needle .meter-box{
      opacity:0.25;
    }
    body.not-started.mode-needle .meter-labels{
      opacity:0.25;
    }

    .center-mark{
      position:absolute;
      left:50%;
      width:2px;
      height:100%;
      background:var(--accent);
      opacity:.55;
      z-index:1;
    }

    .edge-mark{
      position:absolute;
      top:0;
      height:100%;
      width:1px;
      background:#444;
      opacity:0.9;
      z-index:1;
    }
    .edge-left{ left:0%; }
    .edge-right{ left:100%; }

    .tick-mark{
      position:absolute;
      top:0;
      height:100%;
      width:1px;
      background:#2b2b2b;
      opacity:0.8;
      z-index:1;
    }

    .meter-labels{
      display:flex;
      justify-content:space-between;
      font-family:ui-monospace, Menlo, Consolas, monospace;
      font-size:0.9rem;
      color:#bbb;
      margin-top:8px;
      padding:0 2px;
    }

    body.mode-strobe .meter-labels{ display:none !important; }
    body.mode-strobe .center-mark,
    body.mode-strobe .edge-mark,
    body.mode-strobe .tick-mark{ display:none !important; }
    body.mode-strobe #strobe-center{ display:none !important; }

    #mic-error{
      display:none;
      margin: 10px 0 4px;
      padding: 12px 12px;
      border-radius: 12px;
      text-align: left;
      font-weight: 800;
      font-size: 0.98rem;
      line-height: 1.35;
      color: #ffecec;
      background: #3a0f12;
      border: 1px solid #7a2b30;
      box-shadow: 0 10px 24px rgba(0,0,0,0.35);
      grid-column: 1 / -1;
    }

    button{
      padding:14px 18px;
      border:none;
      border-radius:10px;
      font-weight:900;
      cursor:pointer;
      transition:.2s;
      width:100%;
      margin-top:12px;
      font-size:1.15rem;
    }
    .btn-main{ background:var(--accent); color:#000; }

    @media (hover: hover) and (pointer: fine) {
      #start-btn.btn-main{ transition: filter 125ms ease; }
      #start-btn.btn-main:hover{ filter: brightness(1.75); }
      #start-btn.btn-main:active{ filter: brightness(1.0); }
    }

    .select-wrap{ position: relative; }
    .select-wrap select{
      -webkit-appearance:none;
      -moz-appearance:none;
      appearance:none;
      padding-right:46px;
      background-image:none;
    }
    .select-wrap::after{
      content:"▾";
      position:absolute;
      right:14px;
      top:50%;
      transform:translateY(-50%);
      pointer-events:none;
      color:#e8e8e8;
      font-size:0.95rem;
      line-height:1;
      opacity:0.85;
    }
    .select-wrap select::-ms-expand{ display:none; }

    /* Also reflect disabled state via wrapper cursor + dim arrow */
    .select-wrap select:disabled{
      pointer-events: none;
    }
    .select-wrap:has(select:disabled){
      cursor: not-allowed;
      opacity: 0.55;
    }
    .select-wrap:has(select:disabled)::after{
      opacity: 0.45;
    }

    @media (max-width: 600px) {
      body{ padding:12px; }
      #tuner-ui{ padding:16px; border-radius:14px; }
      #tuner-ui h1{ font-size:1.25rem !important; margin:0 0 12px 0 !important; }
      label{ font-size:0.9rem; margin-bottom:8px; }
      select{ font-size:1.05rem; padding:14px 12px; border-radius:12px; }
      .select-wrap select{ padding-right:52px; }
      .select-wrap::after{ right:18px; font-size:1.1rem; opacity:0.9; }
      .note-display{ font-size:5rem; margin-top:24px; }
      .freq-display{ font-size:1.35rem; margin-bottom:10px; }
      .meter-box{ height:90px; margin:18px 0 8px; border-radius:12px; }
      button{ font-size:1.2rem; padding:16px 18px; border-radius:14px; }

      .row{
        grid-template-columns: 1fr;
      }
    }

   @media (min-width: 900px){
      :root{
        --ui-max: 1000px;
      }
    }
  </style>
</head>

<body>
  <div id="tuner-ui">

    <div id="help-btn" title="Instructions">?</div>

    <div id="level-meter" title="Input level">
      <div id="level-meter-fill"></div>
    </div>

    <div id="instructions-overlay" aria-hidden="true">
      <div id="instructions-modal" role="dialog" aria-modal="true" aria-label="Instructions">
        <div id="instructions-title" style="text-align:center;">Instructions</div>

        <div id="instructions-scroll">
          <div id="instructions-body">
            <div class="instructions-subtitle">How to use this tuner</div>
            <div class="instructions-subbody">

              1) Select the A4 reference frequency, display mode (Needle or Strobe), and input level adjustment.<br/>
              2) Select the temperament: Equal Temperament, Just Intonation, Pythagorean (Perfect fifths), or the Fiddle sweetened modes.<br/>
              3) If you select Just Intonation or Pythagorean, also select the root note for the temperament.<br/>
              4) For the fiddle sweetened modes, the root note selector is disabled because the anchor is fixed by the selected mode.<br/>
              5) Click <b>START</b> and play a steady tone. The note name and cents offset will be shown for the selected temperament.

            </div>

            <hr style="border:0; border-top:1px solid #2a2a2a; margin: 14px 0 14px 0;"/>

            <div class="instructions-subtitle">Pythagorean (Perfect fifths) for fiddlers (G–D–A–E)</div>
            <div class="instructions-subbody">
              This mode uses <b>pure 3:2 fifths</b> (Pythagorean tuning).<br/><br/>
              It is ideal for tuning a fiddle so the <b>open strings</b> and
              <b>fifth-based double stops</b> sound clean and consonant, with
              <b>minimal beating</b>.<br/><br/>

              <b>Recommended fiddle tuning workflow:<br/><br/>
              Root = D (recommended), start on the D string</b><br/><br/>

              1) Set the <b>Temperament</b> to <b>Pythagorean (Perfect fifths)</b>.<br/>
              2) Set the <b>Root note</b> to <b>D</b>.<br/>
              3) Tune the <b>D string</b> until the tuner reads <b>0.0 cents</b>.<br/>
              4) Tune the <b>A string</b> until it reads <b>0.0 cents</b>.<br/>
              5) Tune the <b>G string</b> until it reads <b>0.0 cents</b>.<br/>
              6) Finally, tune the <b>E string</b> until it reads <b>0.0 cents</b>.<br/><br/>

              <b>Alternative workflow:</b><br/><br/>
              <b>Root = A, start on the A string</b><br/><br/>

              1) Set the <b>Temperament</b> to <b>Pythagorean (Perfect fifths)</b>.<br/>
              2) Set the <b>Root note</b> to <b>A</b>.<br/>
              3) Tune the <b>A string</b> until the tuner reads <b>0.0 cents</b>.<br/>
              4) Tune the <b>D string</b> until it reads <b>0.0 cents</b>.<br/>
              5) Tune the <b>E string</b> until it reads <b>0.0 cents</b>.<br/>
              6) Finally, tune the <b>G string</b> until it reads <b>0.0 cents</b>.<br/><br/>

              In both cases, the strings are tuned in <b>pure fifths</b>, which is why
              all strings read <b>0.0 cents</b> when correctly tuned.
            </div>

            <hr style="border:0; border-top:1px solid #2a2a2a; margin: 14px 0 14px 0;"/>

            <div class="instructions-subtitle">Fiddle sweetened (open strings pure fifths, everything else ET)</div>
            <div class="instructions-subbody">
              These two modes are designed for traditional fiddle tuning where you want the <b>open strings (G–D–A–E)</b> to be tuned
              in <b>pure 3:2 fifths</b> for clean resonance and double stops, but want <b>all other notes</b> to match
              <b>Equal Temperament</b> for compatibility with other instruments.<br/><br/>

              <b>Fiddle sweetened (Anchor on D)</b><br/>
              • D4 is locked to the Equal Temperament D (based on the selected A4 reference).<br/>
              • G3, A4, and E5 are derived from D using pure 3:2 fifth ratios.<br/>
              • All other notes are Equal Temperament.<br/><br/>

              <b>Recommended workflow (Anchor on D):</b><br/>
              1) Select <b>Fiddle sweetened (Anchor on D)</b>.<br/>
              2) Tune <b>D</b> first until the tuner reads <b>0.0 cents</b>.<br/>
              3) Tune <b>A</b>, then <b>G</b>, then <b>E</b> until each reads <b>0.0 cents</b>.<br/><br/>

              <b>Fiddle sweetened (Anchor on A)</b><br/>
              • A4 is locked to the Equal Temperament A (based on the selected A4 reference).<br/>
              • G3, D4, and E5 are derived from A using pure 3:2 fifth ratios.<br/>
              • All other notes are Equal Temperament.<br/><br/>

              <b>Recommended workflow (Anchor on A):</b><br/>
              1) Select <b>Fiddle sweetened (Anchor on A)</b>.<br/>
              2) Tune <b>A</b> first until the tuner reads <b>0.0 cents</b>.<br/>
              3) Tune <b>D</b>, then <b>E</b>, then <b>G</b> until each reads <b>0.0 cents</b>.<br/><br/>

              <b>Note:</b> In these sweetened fifths modes, the <b>Root note</b> selector is disabled because the anchor is fixed by the selected mode.
            </div>

            <hr style="border:0; border-top:1px solid #2a2a2a; margin: 14px 0 14px 0;"/>

            <div class="instructions-subtitle">Troubleshooting</div>
            <div class="instructions-subbody">
              You must grant the browser microphone permission for this tool to work.<br/><br/>
              The audio input level is displayed in a bar at the top-right of the tool.<br/><br/>
              <b>If no audio is detected or the audio input meter is maxed-out and no notes are getting recognized:</b><br/><br/>
              This tuner is designed to be used in a quiet environment.<br/><br/>
              It may not work well or at all with loud background noise or other instruments playing in the background.<br/><br/>
              To optimize the signal level coming into the tuner, I recommend that you first verify and adjust your system's microphone level settings as required to get a strong audio signal coming into the tuner.<br/><br/>
              If necessary, you can also reduce or boost the microphone signal level from within the tuner using the options in the <b>Input level adjustment</b> dropdown.<br/><br/>
              On Windows systems, you may also need to disable any automatic microphone noise reduction performed by the system audio drivers.<br/><br/>
              Noise reduction audio driver software may mistake continuous tones for background noise (such as fans or AC hum) and filter them out.<br/><br/>
              Open Windows Settings, search for Microphone settings, make any required changes, and then reload the tuner tab in your browser.
            </div>
          </div>
        </div>

        <button id="instructions-close" type="button">CLOSE</button>
      </div>
    </div>

    <h1 style="margin: 0 0 16px 0; font-size: 1.6rem; line-height:1.1; font-weight: 900; letter-spacing: 0.4px; color: #e0e0e0; text-align: center;" title="This utility was developed by Michael Eskin - https://michaeleskin.com">
      Chromatic Tuner
    </h1>

    <div class="row">

      <div>
        <label for="displaymode">&nbsp;&nbsp;Display mode</label>
        <div class="select-wrap">
          <select id="displaymode">
            <option value="needle" selected>Needle</option>
            <option value="strobe">Strobe</option>
          </select>
        </div>
      </div>

      <div>
        <label for="a4ref">&nbsp;&nbsp;A4 reference (Hz)</label>
        <div class="select-wrap">
          <select id="a4ref">
            <option value="392">392</option>
            <option value="415">415</option>
            <option value="438">438</option>
            <option value="439">439</option>
            <option value="440" selected>440</option>
            <option value="441">441</option>
            <option value="442">442</option>
            <option value="443">443</option>
            <option value="444">444</option>
            <option value="445">445</option>
            <option value="446">446</option>
            <option value="465">465</option>
            <option value="470">470</option>
            <option value="472">472</option>
            <option value="475">475</option>
            <option value="478">478</option>
            <option value="480">480</option>
            <option value="482">482</option>
            <option value="485">485</option>
          </select>
        </div>
      </div>

      <div>
        <label for="inputboost">&nbsp;&nbsp;Input level adjustment</label>
        <div class="select-wrap">
          <select id="inputboost">
            <option value="0.125">-18 dB</option>
            <option value="0.25">-12 dB</option>
            <option value="0.5">-6 dB</option>
            <option value="0.7079">-3 dB</option>
            <option value="1.0" selected>0 dB</option>
            <option value="1.4125">+3 dB</option>
            <option value="2.0">+6 dB</option>
            <option value="4.0">+12 dB</option>
            <option value="8.0">+18 dB</option>
          </select>
        </div>
      </div>

    </div>

    <!-- Second line of dropdowns (full width, 2 columns) -->
    <div class="row row-intonation">

      <div>
        <label for="intonation">&nbsp;&nbsp;Temperament</label>
        <div class="select-wrap">
          <select id="intonation">
            <option value="et" selected>Equal Temperament</option>
            <option value="just">Just Intonation</option>
            <option value="pyth">Pythagorean (Perfect fifths)</option>
            <option value="fiddle_d">Fiddle sweetened (Anchor on D)</option>
            <option value="fiddle_a">Fiddle sweetened (Anchor on A)</option>
          </select>
        </div>
      </div>

      <div>
        <label for="rootnote">&nbsp;&nbsp;Root note</label>
        <div class="select-wrap">
          <select id="rootnote" disabled>
            <option value="0" selected>C</option>
            <option value="1">C#</option>
            <option value="2">D</option>
            <option value="3">D#</option>
            <option value="4">E</option>
            <option value="5">F</option>
            <option value="6">F#</option>
            <option value="7">G</option>
            <option value="8">G#</option>
            <option value="9">A</option>
            <option value="10">A#</option>
            <option value="11">B</option>
          </select>
        </div>
      </div>

    </div>

    <div id="mic-error" style="display:none;"></div>

    <div id="tuner-live">
      <div id="note" class="note-display">--</div>
      <div id="freq" class="freq-display">-- cents</div>

      <div class="meter-box" title="In Needle mode shows cents relative to the selected temperament.&nbsp;&nbsp;Range: -50 to +50 cents.&nbsp;&nbsp;In Strobe mode, stripes moves left if note is flat, right if sharp.&nbsp;&nbsp;Strobe stops when note is in tune.">
        <div id="strobe-layer" aria-hidden="true">
          <div id="strobe-pattern"></div>
          <div id="strobe-center"></div>
        </div>

        <div class="center-mark"></div>

        <div class="edge-mark edge-left"></div>
        <div class="edge-mark edge-right"></div>

        <div class="tick-mark" style="left:10%;"></div>
        <div class="tick-mark" style="left:20%;"></div>
        <div class="tick-mark" style="left:30%;"></div>
        <div class="tick-mark" style="left:40%;"></div>
        <div class="tick-mark" style="left:60%;"></div>
        <div class="tick-mark" style="left:70%;"></div>
        <div class="tick-mark" style="left:80%;"></div>
        <div class="tick-mark" style="left:90%;"></div>

        <div id="needle"></div>
      </div>

      <div class="meter-labels">
        <div>-50 cents</div>
        <div>0</div>
        <div>+50 cents</div>
      </div>
    </div>

    <button id="start-btn" class="btn-main" type="button">START</button>
  </div>

<script>
  const LS_KEY_A4REF = "abctools_tuner_a4ref_hz";
  const LS_KEY_BOOST = "abctools_tuner_input_boost_v2";
  const LS_KEY_MODE  = "abctools_tuner_display_mode_v1";

  const LS_KEY_INTONATION = "abctools_tuner_intonation_v1";
  const LS_KEY_ROOTNOTE   = "abctools_tuner_rootnote_v1";

  let audioCtx = null;
  let streamSource = null;
  let analyserPitch = null;
  let timeDataPitch = null;

  let userBoostGainNode = null;
  let gUserBoostGain = 1.0;

  let inputGainNode = null;
  let iosCompressorNode = null;

  const IS_IOS = (() => {
    const ua = navigator.userAgent || "";
    const iOSUA = /iPad|iPhone|iPod/.test(ua);
    const iPadOS = (navigator.platform === "MacIntel" && navigator.maxTouchPoints > 1);
    return iOSUA || iPadOS;
  })();

  const IOS_INPUT_GAIN = 3.0;

  async function ensureAudioContextRunning() {
    if (!audioCtx) return;
    try {
      if (audioCtx.state === "suspended") await audioCtx.resume();
    } catch (e) { }
  }

  function clamp(v, lo, hi){ return Math.max(lo, Math.min(hi, v)); }
  function median(arr){
    if (!arr || !arr.length) return null;
    const s = arr.slice().sort((a,b)=>a-b);
    return s[Math.floor(s.length/2)];
  }
  function rmsOfArray(buf){
    let sum = 0;
    for (let i=0;i<buf.length;i++){ const v = buf[i]; sum += v*v; }
    return Math.sqrt(sum / buf.length);
  }

  function freqToMidi(freq){ return 12 * (Math.log2(freq / gA4RefHz)) + 69; }
  function midiToFreq(midi){ return gA4RefHz * Math.pow(2, (midi - 69) / 12); }
  function centsBetween(fA, fB){ return 1200 * Math.log2(fA / fB); }

  function midiToNoteName(midi){
    const pc = ((midi % 12) + 12) % 12;
    const octave = Math.floor(midi / 12) - 1;
    return NOTES[pc] + octave;
  }
  function fmtCentsSigned(c){
    if (c == null || !isFinite(c)) return "--";
    const v = Math.round(c * 10) / 10;
    return (v > 0 ? "+" : "") + v.toFixed(1);
  }

  const tunerLive = document.getElementById('tuner-live');
  const needle = document.getElementById('needle');
  const noteEl = document.getElementById('note');
  const deltaEl = document.getElementById('freq');

  const strobeLayer = document.getElementById('strobe-layer');
  const strobePattern = document.getElementById('strobe-pattern');
  let gDisplayMode = "needle";

  let strobePhasePx = 0;
  let strobeLastT = performance.now();
  const STROBE_PX_PER_CENT = 7.0;
  const STROBE_MAX_PX_PER_SEC = 420;

  function resetStrobe(){
    strobePhasePx = 0;
    strobeLastT = performance.now();
    if (strobePattern) strobePattern.style.backgroundPosition = "0px 0px";
  }

  function setBodyModeClasses(){
    document.body.classList.toggle("mode-strobe", gDisplayMode === "strobe");
    document.body.classList.toggle("mode-needle", gDisplayMode !== "strobe");
  }

  function applyDisplayModeFromUI(){
    const sel = document.getElementById("displaymode");
    if (!sel) return;
    const v = String(sel.value || "needle");
    gDisplayMode = (v === "strobe") ? "strobe" : "needle";

    setBodyModeClasses();

    if (strobeLayer){
      strobeLayer.style.display = (gDisplayMode === "strobe") ? "block" : "none";
      strobeLayer.setAttribute("aria-hidden", (gDisplayMode === "strobe") ? "false" : "true");
    }
    if (needle){
      needle.style.display = (gDisplayMode === "strobe") ? "none" : "block";
    }
    resetStrobe();
  }

  function updateStrobe(detuneCents){
    if (gDisplayMode !== "strobe") return;
    if (!strobePattern) return;

    const now = performance.now();
    const dt = Math.max(0, Math.min(0.06, (now - strobeLastT) / 1000));
    strobeLastT = now;

    let pxPerSec = (detuneCents || 0) * STROBE_PX_PER_CENT;
    pxPerSec = clamp(pxPerSec, -STROBE_MAX_PX_PER_SEC, STROBE_MAX_PX_PER_SEC);

    strobePhasePx += pxPerSec * dt;

    if (strobePhasePx > 100000) strobePhasePx -= 100000;
    if (strobePhasePx < -100000) strobePhasePx += 100000;

    const px = Math.round(strobePhasePx);
    strobePattern.style.backgroundPosition = `${px}px 0, 0 0`;
  }

  const levelMeterFill = document.getElementById('level-meter-fill');
  let levelMeterSmoothed = 0;
  const LEVEL_METER_ALPHA = 0.25;
  function setLevelMeter01(x){
    if (!levelMeterFill) return;
    const v = Math.max(0, Math.min(1, x || 0));
    levelMeterSmoothed = (LEVEL_METER_ALPHA * v) + ((1 - LEVEL_METER_ALPHA) * levelMeterSmoothed);
    levelMeterFill.style.width = Math.round(levelMeterSmoothed * 100) + "%";
  }

  const helpBtn = document.getElementById('help-btn');
  const instructionsOverlay = document.getElementById('instructions-overlay');
  const instructionsClose = document.getElementById('instructions-close');

  function syncinstructionsHeight(){
    const ui = document.getElementById("tuner-ui");
    const modal = document.getElementById("instructions-modal");
    if (!ui || !modal) return;

    const r = ui.getBoundingClientRect();
    const uiH = Math.max(0, Math.round(r.height));

    const maxH = Math.round(window.innerHeight - 32 - (window.innerHeight * 0.06));
    const finalH = clamp(uiH, 240, maxH);

    modal.style.height = finalH + "px";
  }

  function openinstructions(){
    if (!instructionsOverlay) return;
    instructionsOverlay.style.display = "block";
    instructionsOverlay.setAttribute("aria-hidden", "false");

    syncinstructionsHeight();
    requestAnimationFrame(syncinstructionsHeight);
  }
  function closeinstructions(){
    if (!instructionsOverlay) return;
    instructionsOverlay.style.display = "none";
    instructionsOverlay.setAttribute("aria-hidden", "true");
  }

  if (helpBtn){
    helpBtn.addEventListener("click", openinstructions);
    helpBtn.addEventListener("touchstart", (e) => { e.preventDefault(); openinstructions(); }, { passive:false });
  }
  if (instructionsClose){
    instructionsClose.addEventListener("click", closeinstructions);
  }
  if (instructionsOverlay){
    instructionsOverlay.addEventListener("click", (e) => {
      if (e.target === instructionsOverlay) closeinstructions();
    });
  }
  document.addEventListener("keydown", (e) => {
    if (e.key === "Escape") closeinstructions();
  });

  window.addEventListener("resize", () => {
    if (instructionsOverlay && instructionsOverlay.style.display === "block") {
      syncinstructionsHeight();
    }
  });

  const NOTES = ['C','C#','D','D#','E','F','F#','G','G#','A','A#','B'];

  let gA4RefHz = 440;

  const RMS_SILENCE = 0.020;

  let noiseFloorRms = 0;
  let noiseFloorPrimed = false;
  let adaptiveRmsGate = RMS_SILENCE;

  const GATE_CALIBRATION_FRAMES = 30;
  let gateCalibrationFramesLeft = GATE_CALIBRATION_FRAMES;

  const NOISE_FLOOR_ALPHA = 0.06;
  const NOISE_FLOOR_ALPHA_FAST = 0.25;

  const GATE_MULTIPLIER = IS_IOS ? 2.0 : 3.0;
  const GATE_OFFSET     = IS_IOS ? 0.0015 : 0.003;
  const GATE_MIN        = IS_IOS ? 0.0030 : 0.006;

  const IOS_CALIBRATION_QUIET_MAX_RMS = 0.030;

  function resetAdaptiveGate(){
    noiseFloorRms = 0;
    noiseFloorPrimed = false;
    adaptiveRmsGate = RMS_SILENCE;
    gateCalibrationFramesLeft = GATE_CALIBRATION_FRAMES;
  }

  function updateAdaptiveGate(rms){
    if (gateCalibrationFramesLeft > 0) {

      if (IS_IOS && rms > IOS_CALIBRATION_QUIET_MAX_RMS) {
        return;
      }

      const a = NOISE_FLOOR_ALPHA_FAST;

      if (!noiseFloorPrimed) {
        noiseFloorRms = rms;
        noiseFloorPrimed = true;
      } else {
        noiseFloorRms = (a * rms) + ((1 - a) * noiseFloorRms);
      }

      gateCalibrationFramesLeft--;
    } else {
      const quietBand = adaptiveRmsGate * 1.15;

      if (rms <= quietBand) {
        const a = NOISE_FLOOR_ALPHA;

        if (!noiseFloorPrimed) {
          noiseFloorRms = rms;
          noiseFloorPrimed = true;
        } else {
          noiseFloorRms = (a * rms) + ((1 - a) * noiseFloorRms);
        }
      }
    }

    const floor = noiseFloorPrimed ? noiseFloorRms : rms;
    adaptiveRmsGate = Math.max(GATE_MIN, (floor * GATE_MULTIPLIER) + GATE_OFFSET);
  }

  const MAX_CENTS_DISPLAY = 50;

  let pitchHistory = [];
  const PITCH_HIST_FRAMES = 15;

  let silentFrames = 0;
  let lastDetectedMidi = null;

  const NEEDLE_IN_TUNE_CENTS = 3.5;
  const NEEDLE_NEAR_CENTS = 8.0;

  const NEEDLE_SMOOTH_ALPHA = 0.20;
  let visualCentsSmoothed = 0;
  let visualSmoothingPrimed = false;

  const NEEDLE_COLOR_OUT  = "#ff3e3e";
  const NEEDLE_COLOR_NEAR = "#ffd34d";
  const NEEDLE_COLOR_IN   = "#28a745";

  const micErrorEl = document.getElementById('mic-error');

  function escapeHTML(s){
    return String(s).replace(/[&<>"']/g, ch => ({
      "&":"&amp;",
      "<":"&lt;",
      ">":"&gt;",
      '"':"&quot;",
      "'":"&#39;"
    }[ch]));
  }

  function showMicError(html){
    if (!micErrorEl) return;
    micErrorEl.innerHTML = html;
    micErrorEl.style.display = "block";
  }

  function hideMicError(){
    if (!micErrorEl) return;
    micErrorEl.innerHTML = "";
    micErrorEl.style.display = "none";
  }

  function micErrorMessageFromException(err){
    const name = (err && err.name) ? err.name : "";
    const base = "Microphone access failed.";

    if (name === "NotAllowedError" || name === "PermissionDeniedError") {
      return "Microphone access permission was denied.<br/><br/>Reload the page, click <b>START</b>, and allow microphone access when asked by your browser.";
    }
    if (name === "NotFoundError" || name === "DevicesNotFoundError") {
      return "No microphone was found.<br/><br/>Please connect/select a microphone and try again.";
    }
    if (name === "NotReadableError" || name === "TrackStartError") {
      return "Your microphone is in use by another app or unavailable.<br/><br/>Close other apps using the mic and try again.";
    }
    if (name === "OverconstrainedError" || name === "ConstraintNotSatisfiedError") {
      return "Your browser could not satisfy the microphone constraints.<br/><br/>Try again, or try a different browser/device.";
    }
    if (name === "SecurityError") {
      return "Microphone access is blocked by the browser security policy.<br/><br/>Please open this page via HTTPS and try again.";
    }

    return (err && err.message)
      ? `${base}<br/>${escapeHTML(err.message)}`
      : base;
  }

  let tunerStarted = false;

  function setDimmed(on){
    if (!tunerStarted) return;
    tunerLive.classList.toggle("dimmed", !!on);
  }

  function setNeedleCents(cents){
    const c = (cents == null) ? 0 : clamp(cents, -MAX_CENTS_DISPLAY, MAX_CENTS_DISPLAY);
    const pos = 50 + (c / MAX_CENTS_DISPLAY) * 50;
    needle.style.left = clamp(pos, 0, 100) + "%";
  }

  function setNeedleColorByCents(cents){
    const a = Math.abs(cents || 0);

    if (a <= NEEDLE_IN_TUNE_CENTS) {
      needle.style.backgroundColor = NEEDLE_COLOR_IN;
    } else if (a <= NEEDLE_NEAR_CENTS) {
      needle.style.backgroundColor = NEEDLE_COLOR_NEAR;
    } else {
      needle.style.backgroundColor = NEEDLE_COLOR_OUT;
    }
  }

  function resetNeedleSmoothing(){
    visualSmoothingPrimed = false;
  }

  function applyVisualNeedleSmoothing(cents){
    if (!isFinite(cents)) return cents;

    const target = clamp(cents, -MAX_CENTS_DISPLAY, MAX_CENTS_DISPLAY);

    if (!visualSmoothingPrimed){
      visualCentsSmoothed = target;
      visualSmoothingPrimed = true;
      return target;
    }

    visualCentsSmoothed = (NEEDLE_SMOOTH_ALPHA * target) + ((1 - NEEDLE_SMOOTH_ALPHA) * visualCentsSmoothed);
    return visualCentsSmoothed;
  }

  function clearDisplay(){
    noteEl.innerText = "--";
    deltaEl.innerHTML = "-- cents";
    setNeedleCents(0);
    setNeedleColorByCents(0);

    pitchHistory = [];
    lastDetectedMidi = null;
    silentFrames = 0;
    resetNeedleSmoothing();

    resetAdaptiveGate();

    levelMeterSmoothed = 0;
    setLevelMeter01(0);

    resetStrobe();
  }

  function setUserBoostGainFromUI(){
    const sel = document.getElementById("inputboost");
    if (!sel) return;
    const v = parseFloat(sel.value);
    gUserBoostGain = (isFinite(v) && v > 0) ? v : 1.0;

    if (userBoostGainNode) {
      try { userBoostGainNode.gain.value = gUserBoostGain; } catch(e){ }
    }
  }

  // intonation modes
  const INTON_ET       = "et";
  const INTON_JUST     = "just";
  const INTON_PYTH     = "pyth";
  const INTON_FIDDLE_D = "fiddle_d"; // open strings pure fifths, anchor D4 to ET
  const INTON_FIDDLE_A = "fiddle_a"; // open strings pure fifths, anchor A4 to ET

  let gIntonation = INTON_ET;
  let gRootPc = 0;

  /*
    JUST INTONATION (CHROMATIC) - UPDATED

    These specific ratios match your hardware tuner’s behavior for:
      m2  = 25/24  (~70.7c)
      tritone = 25/18 (~568.7c)
      aug5 = 25/16 (~772.6c)

    The rest of the set remains the common 5-limit chromatic mapping.
  */
  const JUST_RATIOS = [
    1/1,     // unison
    25/24,   // m2 (chromatic semitone)  <-- changed from 16/15
    9/8,     // M2
    6/5,     // m3
    5/4,     // M3
    4/3,     // P4
    25/18,   // tritone                 <-- changed from 45/32
    3/2,     // P5
    25/16,   // aug5 (often used for #5 / enharmonic m6 region) <-- changed from 8/5
    5/3,     // M6
    9/5,     // m7
    15/8     // M7
  ];

  /*
    PYTHAGOREAN (PERFECT FIFTHS)
  */
  const PYTH_RATIOS = [
    1/1,             // unison
    2187/2048,       // chromatic semitone
    9/8,             // whole tone
    19683/16384,     // minor third (pyth)
    81/64,           // major third (pyth)
    4/3,             // perfect fourth
    729/512,         // tritone (pyth)
    3/2,             // perfect fifth
    6561/4096,       // minor sixth (pyth)
    27/16,           // major sixth (pyth)
    59049/32768,     // minor seventh (pyth)
    243/128          // major seventh (pyth)
  ];

  // Sweetened fiddle open-string mappings (ratios relative to the anchor note)
  // MIDI: G3=55, D4=62, A4=69, E5=76
  const FIDDLE_OPEN_MIDI = { G3:55, D4:62, A4:69, E5:76 };

  // Anchor on D4 (locked to ET under A4 reference), derive G3/A4/E5 by pure fifth ratios
  const FIDDLE_D_RATIOS_BY_MIDI = {
    55: 2/3,  // G3 = D4 * (2/3)
    62: 1/1,  // D4 = anchor
    69: 3/2,  // A4 = D4 * (3/2)
    76: 9/4   // E5 = D4 * (9/4)
  };

  // Anchor on A4 (locked to ET under A4 reference), derive D4/G3/E5 by pure fifth ratios
  const FIDDLE_A_RATIOS_BY_MIDI = {
    55: 4/9,  // G3 = A4 * (4/9)  (down two fifths)
    62: 2/3,  // D4 = A4 * (2/3)
    69: 1/1,  // A4 = anchor
    76: 3/2   // E5 = A4 * (3/2)
  };

  function getActiveRatios(){
    if (gIntonation === INTON_JUST) return JUST_RATIOS;
    if (gIntonation === INTON_PYTH) return PYTH_RATIOS;
    return null;
  }

  function ratioForSemitoneDistance(d, ratios){
    const nOct = Math.floor(d / 12);
    const interval = ((d % 12) + 12) % 12;
    return ratios[interval] * Math.pow(2, nOct);
  }

  function fiddleSweetenedIdealFreqForMidi(midi){
    // All non-open-string notes are ET
    const et = midiToFreq(midi);

    if (gIntonation === INTON_FIDDLE_D){
      const anchorMidi = FIDDLE_OPEN_MIDI.D4; // 62
      const ratio = FIDDLE_D_RATIOS_BY_MIDI[midi];
      if (!ratio) return et;
      const anchorFreq = midiToFreq(anchorMidi); // ET D4 under A4 reference
      return anchorFreq * ratio;
    }

    if (gIntonation === INTON_FIDDLE_A){
      const anchorMidi = FIDDLE_OPEN_MIDI.A4; // 69
      const ratio = FIDDLE_A_RATIOS_BY_MIDI[midi];
      if (!ratio) return et;
      const anchorFreq = midiToFreq(anchorMidi); // ET A4 under A4 reference
      return anchorFreq * ratio;
    }

    return et;
  }

  function temperamentIdealFreqForMidi(midi){
    // New hybrid fiddle modes
    if (gIntonation === INTON_FIDDLE_D || gIntonation === INTON_FIDDLE_A){
      return fiddleSweetenedIdealFreqForMidi(midi);
    }

    if (gIntonation === INTON_ET) return midiToFreq(midi);

    const rootMidi = 60 + (gRootPc % 12);     // root at octave 4
    const rootFreq = midiToFreq(rootMidi);    // lock root to ET under A4 ref
    const d = midi - rootMidi;

    const ratios = getActiveRatios();         // just/pyth arrays
    if (!ratios) return midiToFreq(midi);

    // Default behavior (kept exactly as-is for JUST)
    if (gIntonation !== INTON_PYTH) {
      const ratio = ratioForSemitoneDistance(d, ratios);
      return rootFreq * ratio;
    }

    // PYTHAGOREAN ONLY: fix negative intervals by using reciprocal of upward ratio
    const ratio = (d >= 0)
      ? ratioForSemitoneDistance(d, ratios)
      : (1 / ratioForSemitoneDistance(-d, ratios));

    return rootFreq * ratio;
  }

  function updateRootEnablement(){
    const rootSel = document.getElementById("rootnote");
    if (!rootSel) return;

    // Root note is only meaningful/adjustable for JUST and PYTH.
    rootSel.disabled = !(gIntonation === INTON_JUST || gIntonation === INTON_PYTH);
  }

  function applyIntonationFromUI(){
    const intSel = document.getElementById("intonation");
    if (intSel) {
      const v = String(intSel.value || INTON_ET);
      if (v === INTON_JUST || v === INTON_PYTH || v === INTON_FIDDLE_D || v === INTON_FIDDLE_A) {
        gIntonation = v;
      } else {
        gIntonation = INTON_ET;
      }
    }

    const rootSel = document.getElementById("rootnote");
    if (rootSel) {
      // For the sweetened fiddle modes, force the root note display to match the anchor.
      if (gIntonation === INTON_FIDDLE_D){
        gRootPc = 2; // D
        rootSel.value = "2";
      } else if (gIntonation === INTON_FIDDLE_A){
        gRootPc = 9; // A
        rootSel.value = "9";
      } else {
        const n = parseInt(rootSel.value, 10);
        gRootPc = (isFinite(n) ? n : 0) % 12;
      }
    }

    updateRootEnablement();

    pitchHistory = [];
    lastDetectedMidi = null;
    silentFrames = 0;
    resetNeedleSmoothing();
    resetStrobe();
    clearDisplay();
  }

  function restoreSettingsFromLocalStorage(){
    try{
      const mode = localStorage.getItem(LS_KEY_MODE);
      const a4 = localStorage.getItem(LS_KEY_A4REF);
      const boost = localStorage.getItem(LS_KEY_BOOST);
      const intonation = localStorage.getItem(LS_KEY_INTONATION);
      const rootnote = localStorage.getItem(LS_KEY_ROOTNOTE);

      const modeSel = document.getElementById("displaymode");
      if (modeSel && mode && modeSel.querySelector(`option[value="${CSS.escape(mode)}"]`)) modeSel.value = mode;

      const a4Sel = document.getElementById("a4ref");
      if (a4Sel && a4 && a4Sel.querySelector(`option[value="${CSS.escape(a4)}"]`)) a4Sel.value = a4;

      const boostSel = document.getElementById("inputboost");
      if (boostSel && boost && boostSel.querySelector(`option[value="${CSS.escape(boost)}"]`)) boostSel.value = boost;

      const intSel = document.getElementById("intonation");
      if (intSel && intonation && intSel.querySelector(`option[value="${CSS.escape(intonation)}"]`)) intSel.value = intonation;

      const rootSel = document.getElementById("rootnote");
      if (rootSel && rootnote && rootSel.querySelector(`option[value="${CSS.escape(rootnote)}"]`)) rootSel.value = rootnote;

    } catch(e){
    }
  }

  function saveSettingsToLocalStorage(){
    try{
      const modeSel = document.getElementById("displaymode");
      const a4Sel = document.getElementById("a4ref");
      const boostSel = document.getElementById("inputboost");
      if (modeSel) localStorage.setItem(LS_KEY_MODE, String(modeSel.value));
      if (a4Sel) localStorage.setItem(LS_KEY_A4REF, String(a4Sel.value));
      if (boostSel) localStorage.setItem(LS_KEY_BOOST, String(boostSel.value));

      const intSel = document.getElementById("intonation");
      const rootSel = document.getElementById("rootnote");
      if (intSel) localStorage.setItem(LS_KEY_INTONATION, String(intSel.value));
      if (rootSel) localStorage.setItem(LS_KEY_ROOTNOTE, String(rootSel.value));
    } catch(e){
    }
  }

  function yinPitch(buffer, sampleRate, minFreq, maxFreq, threshold) {
    const halfSize = Math.floor(buffer.length / 2);

    const minTau = Math.floor(sampleRate / maxFreq);
    const maxTau = Math.floor(sampleRate / minFreq);
    if (maxTau >= halfSize) return null;

    const d = new Float32Array(maxTau + 1);
    for (let tau = 1; tau <= maxTau; tau++) {
      let sum = 0;
      for (let i = 0; i < halfSize; i++) {
        const delta = buffer[i] - buffer[i + tau];
        sum += delta * delta;
      }
      d[tau] = sum;
    }

    const cmnd = new Float32Array(maxTau + 1);
    cmnd[0] = 1;
    let runningSum = 0;
    for (let tau = 1; tau <= maxTau; tau++) {
      runningSum += d[tau];
      cmnd[tau] = d[tau] * tau / (runningSum || 1e-12);
    }

    let tauEstimate = -1;
    for (let tau = Math.max(2, minTau); tau <= maxTau; tau++) {
      if (cmnd[tau] < threshold && cmnd[tau] < cmnd[tau - 1]) {
        while (tau + 1 <= maxTau && cmnd[tau + 1] < cmnd[tau]) tau++;
        tauEstimate = tau;
        break;
      }
    }
    if (tauEstimate === -1) return null;

    const probability = 1 - cmnd[tauEstimate];

    const PROB_MIN = IS_IOS ? 0.62 : 0.75;
    if (probability < PROB_MIN) return null;

    const x0 = tauEstimate > 1 ? tauEstimate - 1 : tauEstimate;
    const x2 = tauEstimate + 1 <= maxTau ? tauEstimate + 1 : tauEstimate;
    const s0 = cmnd[x0], s1 = cmnd[tauEstimate], s2 = cmnd[x2];

    const denom = (2 * s1 - s2 - s0);
    let betterTau = tauEstimate;
    if (Math.abs(denom) > 1e-12) {
      const delta = (s2 - s0) / (2 * denom);
      betterTau = tauEstimate + delta;
    }

    const freq = sampleRate / betterTau;
    if (!(freq > 0) || freq < minFreq || freq > maxFreq) return null;

    return { freq, probability };
  }

  function tick(){
    if (!audioCtx || !analyserPitch) {
      requestAnimationFrame(tick);
      return;
    }

    analyserPitch.getFloatTimeDomainData(timeDataPitch);
    const rms = rmsOfArray(timeDataPitch);

    setLevelMeter01(clamp(rms / 0.10, 0, 1));
    updateAdaptiveGate(rms);

    if (rms < adaptiveRmsGate){
      setDimmed(true);

      strobeLastT = performance.now();

      const isDeepSilence = (rms < (adaptiveRmsGate * 0.45));
      silentFrames++;

      const framesNeeded = isDeepSilence ? 1 : 4;

      if (silentFrames === framesNeeded) {
        pitchHistory = [];
        lastDetectedMidi = null;
        resetNeedleSmoothing();
        resetStrobe();

        if (!IS_IOS) {
          resetAdaptiveGate();
        }
      }

      ensureAudioContextRunning();
      requestAnimationFrame(tick);
      return;
    }

    silentFrames = 0;
    setDimmed(false);

    const yin = yinPitch(timeDataPitch, audioCtx.sampleRate, 55, 2000, 0.12);

    if (yin && yin.freq){
      const midiFloatNow = freqToMidi(yin.freq);
      const midiNow = Math.round(midiFloatNow);

      if (lastDetectedMidi !== null && midiNow !== lastDetectedMidi) {
        pitchHistory = [];
        resetNeedleSmoothing();
        resetStrobe();
      }
      lastDetectedMidi = midiNow;

      pitchHistory.push(yin.freq);
      while (pitchHistory.length > 15) pitchHistory.shift();

      if (pitchHistory.length >= 8){
        const f0 = median(pitchHistory);

        if (f0 && isFinite(f0) && f0 > 0){
          const midiFloat = freqToMidi(f0);
          const midi = Math.round(midiFloat);
          const note = midiToNoteName(midi);

          const ideal = temperamentIdealFreqForMidi(midi);

          const centsRaw = centsBetween(f0, ideal);
          let cents = (Math.abs(centsRaw) <= 1.0) ? 0 : centsRaw;
          cents = (Math.abs(cents) <= 1.0) ? 0 : cents;

          noteEl.innerText = note;
          deltaEl.innerHTML = `${fmtCentsSigned(cents)} cents`;

          const centsForStrobe = (Math.abs(centsRaw) <= 1.0) ? 0 : centsRaw;
          updateStrobe(centsForStrobe);

          const visualCents = applyVisualNeedleSmoothing((Math.abs(cents) <= 1.0) ? 0 : cents);
          setNeedleCents(visualCents);
          setNeedleColorByCents(cents);
        }
      }
    }

    ensureAudioContextRunning();
    requestAnimationFrame(tick);
  }

  async function startAudio(){
    hideMicError();

    setUserBoostGainFromUI();
    applyDisplayModeFromUI();
    applyIntonationFromUI();

    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    await ensureAudioContextRunning();

    const stream = await navigator.mediaDevices.getUserMedia({
      audio: {
        autoGainControl: false,
        echoCancellation: false,
        noiseSuppression: false
      }
    });
    await ensureAudioContextRunning();

    const track = stream.getAudioTracks()[0];
    if (track && track.applyConstraints) {
      try {
        await track.applyConstraints({
          autoGainControl: false,
          echoCancellation: false,
          noiseSuppression: false
        });
      } catch (e) { }
    }

    streamSource = audioCtx.createMediaStreamSource(stream);

    analyserPitch = audioCtx.createAnalyser();
    analyserPitch.fftSize = 4096;
    timeDataPitch = new Float32Array(analyserPitch.fftSize);

    userBoostGainNode = audioCtx.createGain();
    userBoostGainNode.gain.value = gUserBoostGain;

    if (IS_IOS) {
      inputGainNode = audioCtx.createGain();
      inputGainNode.gain.value = 3.0;

      iosCompressorNode = audioCtx.createDynamicsCompressor();
      iosCompressorNode.threshold.value = -48;
      iosCompressorNode.knee.value = 30;
      iosCompressorNode.ratio.value = 12;
      iosCompressorNode.attack.value = 0.003;
      iosCompressorNode.release.value = 0.25;

      streamSource.connect(userBoostGainNode);
      userBoostGainNode.connect(inputGainNode);
      inputGainNode.connect(iosCompressorNode);
      iosCompressorNode.connect(analyserPitch);
    } else {
      streamSource.connect(userBoostGainNode);
      userBoostGainNode.connect(analyserPitch);
    }

    const silentGain = audioCtx.createGain();
    silentGain.gain.value = 0;
    analyserPitch.connect(silentGain);
    silentGain.connect(audioCtx.destination);

    clearDisplay();

    tunerStarted = true;
    document.body.classList.remove("not-started");
    setDimmed(true);

    requestAnimationFrame(tick);
  }

  document.getElementById('start-btn').onclick = async () => {
    try{
      const btn = document.getElementById('start-btn');
      btn.disabled = true;
      btn.innerText = "STARTING…";
      await startAudio();
      btn.style.display = "none";
    }catch(err){
      console.error(err);

      showMicError(micErrorMessageFromException(err));

      const btn = document.getElementById('start-btn');
      btn.disabled = false;
      btn.innerText = "START";
      tunerStarted = false;
      setDimmed(false);
    }
  };

  const displayModeSelect = document.getElementById('displaymode');
  if (displayModeSelect) {
    displayModeSelect.addEventListener('change', () => {
      applyDisplayModeFromUI();
      saveSettingsToLocalStorage();
    });
  }

  const a4RefSelect = document.getElementById('a4ref');
  if (a4RefSelect) {
    gA4RefHz = parseFloat(a4RefSelect.value) || 440;

    a4RefSelect.addEventListener('change', () => {
      gA4RefHz = parseFloat(a4RefSelect.value) || 440;

      saveSettingsToLocalStorage();

      pitchHistory = [];
      lastDetectedMidi = null;
      silentFrames = 0;
      resetNeedleSmoothing();
      resetStrobe();
      clearDisplay();
    });
  }

  const inputBoostSelect = document.getElementById('inputboost');
  if (inputBoostSelect) {
    setUserBoostGainFromUI();
    inputBoostSelect.addEventListener('change', () => {
      setUserBoostGainFromUI();
      saveSettingsToLocalStorage();
    });
  }

  const intonationSelect = document.getElementById('intonation');
  if (intonationSelect) {
    intonationSelect.addEventListener('change', () => {
      applyIntonationFromUI();
      saveSettingsToLocalStorage();
    });
  }

  const rootNoteSelect = document.getElementById('rootnote');
  if (rootNoteSelect) {
    rootNoteSelect.addEventListener('change', () => {
      applyIntonationFromUI();
      saveSettingsToLocalStorage();
    });
  }

  restoreSettingsFromLocalStorage();

  document.body.classList.add("not-started");

  if (a4RefSelect){
    gA4RefHz = parseFloat(a4RefSelect.value) || 440;
  }
  setUserBoostGainFromUI();
  applyDisplayModeFromUI();
  applyIntonationFromUI();

  function addIOSResumeGestures() {
    const handler = async () => {
      if (audioCtx) await ensureAudioContextRunning();
    };
    window.addEventListener("touchstart", handler, { passive: true });
    window.addEventListener("mousedown", handler, { passive: true });
    window.addEventListener("keydown", handler, { passive: true });

    document.addEventListener("visibilitychange", () => {
      if (!document.hidden && audioCtx) ensureAudioContextRunning();
    });
  }
  if (IS_IOS){
    addIOSResumeGestures();
  }

  clearDisplay();
</script>
</body>
</html>
