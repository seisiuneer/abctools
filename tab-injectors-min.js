var angloFingeringsGenerator=function(e,a){var n,r="",t=function(e,a,n,r){this.name=e,this.notes=a,this.cost=n,this.finger=r},s={L1a:new t("L1a",["E,","F,"],10,"l4"),L2a:new t("L2a",["A,","_B,"],10,"l4"),L3a:new t("L3a",["^C","_E"],10,"l3"),L4a:new t("L4a",["A","G"],10,"l2"),L5a:new t("L5a",["^G","_B"],10,"l1"),L1:new t("L1",["C,","G,"],1,"l4"),L2:new t("L2",["G,","B,"],1,"l4"),L3:new t("L3",["C","D"],1,"l3"),L4:new t("L4",["E","F"],1,"l2"),L5:new t("L5",["G","A"],1,"l1"),L6:new t("L6",["B,","A,"],1,"l4"),L7:new t("L7",["D","^F"],2,"l4"),L8:new t("L8",["G","A"],2,"l3"),L9:new t("L9",["B","c"],2,"l2"),L10:new t("L10",["d","e"],2,"l1"),R1:new t("R1",["c","B"],1,"r1"),R2:new t("R2",["e","d"],1,"r2"),R3:new t("R3",["g","f"],2,"r3"),R4:new t("R4",["c'","a"],2,"r4"),R5:new t("R5",["e'","b"],2,"r4"),R6:new t("R6",["g","^f"],1,"r1"),R7:new t("R7",["b","a"],1,"r2"),R8:new t("R8",["d'","c'"],1,"r3"),R9:new t("R9",["g'","e'"],1,"r4"),R10:new t("R10",["b'","^f'"],1,"r4")};new t("L1a",["E,","F,"],10,"l4"),new t("L2a",["A,","_B,"],10,"l4"),new t("L3a",["^C","_E"],10,"l3"),new t("L4a",["A","G"],10,"l2"),new t("L5a",["^G","_B"],10,"l1"),new t("L1",["C,","G,"],1,"l4"),new t("L2",["G,","B,"],1,"l4"),new t("L3",["C","D"],1,"l3"),new t("L4",["E","F"],1,"l2"),new t("L5",["G","A"],1,"l1"),new t("L6",["B,","A,"],1,"l4"),new t("L7",["D","^F"],2,"l4"),new t("L8",["G","A"],2,"l3"),new t("L9",["B","c"],2,"l2"),new t("L10",["d","e"],1,"l1"),new t("R1",["c","B"],1,"r1"),new t("R2",["e","d"],2,"r2"),new t("R3",["g","f"],2,"r3"),new t("R4",["c'","a"],2,"r4"),new t("R5",["e'","b"],2,"r4"),new t("R6",["g","^f"],1,"r1"),new t("R7",["b","a"],1,"r2"),new t("R8",["d'","c'"],1,"r3"),new t("R9",["g'","e'"],1,"r4"),new t("R10",["b'","^f'"],1,"r4");var c={L1a:new t("L1a",["E,","F,"],10,"l4"),L2a:new t("L2a",["A,","_B,"],10,"l4"),L3a:new t("L3a",["^C","_E"],10,"l3"),L4a:new t("L4a",["A","G"],10,"l2"),L5a:new t("L5a",["^G","_B"],10,"l1"),L1:new t("L1",["C,","G,"],1,"l4"),L2:new t("L2",["G,","B,"],1,"l4"),L3:new t("L3",["C","D"],1,"l3"),L4:new t("L4",["E","F"],1,"l2"),L5:new t("L5",["G","A"],1,"l1"),L6:new t("L6",["B,","A,"],1,"l4"),L7:new t("L7",["D","^F"],2,"l4"),L8:new t("L8",["G","A"],2,"l3"),L9:new t("L9",["B","z"],2,"l2"),L9a:new t("L9",["z","c"],1,"l2"),L10:new t("L10",["d","e"],1,"l1"),R1:new t("R1",["c","x"],2,"r1"),R1x:new t("R1",["x","B"],1,"r1"),R2:new t("R2",["e","d"],2,"r2"),R3:new t("R3",["g","f"],2,"r3"),R4:new t("R4",["c'","a"],2,"r4"),R5:new t("R5",["e'","b"],2,"r4"),R6:new t("R6",["g","^f"],1,"r1"),R7:new t("R7",["b","a"],1,"r2"),R8:new t("R8",["d'","c'"],1,"r3"),R9:new t("R9",["g'","e'"],1,"r4"),R10:new t("R10",["b'","^f'"],1,"r4")};new t("R1a",["^d","^c"],1,"r1"),new t("R2a",["^c","^d"],10,"r2"),new t("R3a",["^g","g"],10,"r3"),new t("R4a",["^c'","_b"],10,"r4"),new t("R5a",["a","d'"],10,"r4");var l={R1a:new t("R1a",["^d","^c"],10,"r1"),R2a:new t("R2a",["^c","^d"],1,"r2"),R3a:new t("R3a",["^g","g"],10,"r3"),R4a:new t("R4a",["^c'","_b"],10,"r4"),R5a:new t("R5a",["a","d'"],10,"r4")},i={R1a:new t("R1a",["^c","^d"],10,"r1"),R2a:new t("R2a",["a","g"],10,"r2"),R3a:new t("R3a",["^g","_b"],10,"r3"),R4a:new t("R4a",["^c'","_e'"],10,"r4"),R5a:new t("R5a",["a","f'"],10,"r4")},o=["1a","2a","3a","4a","5a","1a","2a","3a","4a","5a","1","2","3","4","5","1","2","3","4","5","6","7","8","9","10","6","7","8","9","10"],_=null,u=null,d=null,f=null,g=null,h=0;function $(e){}function x(e){if($("Got input:"+e),!function e(){var a,n,r=parseInt(gInjectTab_ConcertinaFingering);switch(_=[],u=[],r){case 0:for(var t in l)_[t]=l[t];for(var t in i)u[t]=i[t];for(var t in s)_[t]=s[t],u[t]=s[t];break;case 1:for(var t in l)_[t]=l[t];for(var t in i)u[t]=i[t];for(var t in c)_[t]=c[t];for(var t in c)u[t]=c[t]}d=(a=d=0==parseInt(gInjectTab_ConcertinaStyle)?_:u,n=gAngloButtonNames,gInjectTab_GaryCoover&&(gAngloButtonNames=o),a.L1a.name=gAngloButtonNames[0],a.L2a.name=gAngloButtonNames[1],a.L3a.name=gAngloButtonNames[2],a.L4a.name=gAngloButtonNames[3],a.L5a.name=gAngloButtonNames[4],a.R1a.name=gAngloButtonNames[5],a.R2a.name=gAngloButtonNames[6],a.R3a.name=gAngloButtonNames[7],a.R4a.name=gAngloButtonNames[8],a.R5a.name=gAngloButtonNames[9],a.L1.name=gAngloButtonNames[10],a.L2.name=gAngloButtonNames[11],a.L3.name=gAngloButtonNames[12],a.L4.name=gAngloButtonNames[13],a.L5.name=gAngloButtonNames[14],a.R1.name=gAngloButtonNames[15],a.R1x&&(a.R1x.name=gAngloButtonNames[15]),a.R2.name=gAngloButtonNames[16],a.R3.name=gAngloButtonNames[17],a.R4.name=gAngloButtonNames[18],a.R5.name=gAngloButtonNames[19],a.L6.name=gAngloButtonNames[20],a.L7.name=gAngloButtonNames[21],a.L8.name=gAngloButtonNames[22],a.L9.name=gAngloButtonNames[23],a.L9a&&(a.L9a.name=gAngloButtonNames[23]),a.L10.name=gAngloButtonNames[24],a.R6.name=gAngloButtonNames[25],a.R7.name=gAngloButtonNames[26],a.R8.name=gAngloButtonNames[27],a.R9.name=gAngloButtonNames[28],a.R10.name=gAngloButtonNames[29],gInjectTab_GaryCoover&&(gAngloButtonNames=n),a)}(),null==(f=function e(a){var n,r,t=null,s=a.match(/^K: *([A-G])([b#])? *(.*?)$/m);if(null==s||s.length<3)return null;if(n=void 0==s[2]?s[1]:s[1]+s[2],$("Got base key of '"+n+"' and extra of '"+(r=(r=(r=s[3].toLowerCase()).replace(/%.*/,"")).trim())+"'"),""==r||-1!=r.search("maj")||-1!=r.search("ion")?($("Mode: Ionian (major)"),t=G(n,0)):-1!=r.search("mix")?($("Mode: Mixolydian"),t=G(n,1)):-1!=r.search("dor")?($("Mode: Dorian"),t=G(n,2)):-1!=r.search("m")&&-1==r.search("mix")||-1!=r.search("min")||-1!=r.search("aeo")?($("Mode: Aeolian (minor)"),t=G(n,3)):-1!=r.search("phr")?($("Mode: Phrygian"),t=G(n,4)):-1!=r.search("loc")?($("Mode: Locrian"),t=G(n,5)):-1!=r.search("lyd")?($("Mode: Lydian"),t=G(n,-1)):-1!=r.search("exp")?($("(Accidentals to be explicitly specified)"),t=G("C",0)):($("Failed to determine key signature mode"),t=null),null==t)return t;var c=r.match(/_./g),l=r.match(/\^./g);for(note in c)t.flats+=c[note][1].toUpperCase();for(note in l)t.sharps+=l[note][1].toUpperCase();return t}(e)))return"ERROR: Unknown or unsupported key signature";var a,h=function e(a){for(var n,r,t=a,s=/^\w:.*$/mg;n=s.exec(a);)t=D(t,n.index,n[0].length);for(var c=/"[^"]*"/gm;r=c.exec(t);)for(var l=r.index,i=l+r[0].length,o=l;o<i;++o)t=t.substring(0,o)+"*"+t.substring(o+1);for(c=/\[[^\]|]*\]/g;r=c.exec(t);)for(var l=r.index,i=l+r[0].length,o=l;o<i;++o)t=t.substring(0,o)+"*"+t.substring(o+1);for(c=/![^!\n]*!/gm;r=c.exec(t);)for(var l=r.index,i=l+r[0].length,o=l;o<i;++o)t=t.substring(0,o)+"*"+t.substring(o+1);for(c=/^%%begintext((.|\n)*)%%endtext/gm;r=c.exec(t);)for(var l=r.index,i=l+r[0].length,o=l;o<i;++o)t=t.substring(0,o)+"*"+t.substring(o+1);for(c=/^%.*$/gm;r=c.exec(t);)for(var l=r.index,i=l+r[0].length,o=l;o<i;++o)t=t.substring(0,o)+"*"+t.substring(o+1);t=t.replaceAll("!","*"),$("orginal input:\n"+a),$("sanitized input:\n"+t);for(var _=/([=^_]?[a-gA-G][',]?|\|)/g,u=[];r=_.exec(t);){var d=r[1];if("|"==d)f.accidentalFlats="",f.accidentalSharps="",f.accidentalNaturals="";else{var g=C(d);$("UnNormalized="+d+" normalized="+g),u.push(new v(r.index,d,g))}}return u}(e),x=function e(a){var n={};for(var r in a){var t=a[r].notes;if(null==t){$("Failed to find entry for button "+b);continue}t.forEach(function(e){null==n[e]?n[e]=[a[r]]:n[e].push(a[r]),null==n[e=E(e)]?n[e]=[a[r]]:n[e].push(a[r])})}return n}(d);!function e(a){for(var n in a)a[n].sort(function(e,a){return e.cost-a.cost})}(x);var B,w=(a=function e(a,n){for(var s=null,c=null,l=0;l<a.length;++l){var i=a[l],o=i.normalizedValue,_=n[o];if(null==_||_.length<1){$("Failed to find button for note "+o),$("Attempting respell...");var u=E(o);if($("Respelled as "+u),null==(_=n[u])||_.length<1)return $("Respelling as "+u+" failed to find a button."),r="ERROR:Failed to find button for note '"+o+"'",null}var d=[];_.forEach(function(e){d.push(new m(i,e,A(i,e)))}),null==s&&(s=d),null!=c&&c.forEach(function(e){e.nextStates=d}),c=d}var f=new m(null,new t("root",[],0,"none"));return f.nextStates=s,f}(h,x),n=1e8,g={},function e(a){if(0==a.nextStates.length)return $("Last state, note="+a.note.normalizedValue+" button="+a.button.name+". Popping up the stack"),new p([a],a.button.cost);var n=a.note,r=null,t=null;if(null!=n&&(r=n.unNormalizedValue,t=n.normalizedValue),$("Choosing: current note="+t+" button="+a.button.name),g[a])return $("Already visited state note="+a.note.normalizedValue+" button="+a.button.name),g[a];for(var s=new p([],1e7),c=0;c<a.nextStates.length;++c){var l=a.nextStates[c];$("Trying next ["+c+"/"+a.nextStates.length+"] note="+l.note.normalizedValue+" button="+l.button.name);var i=e(l);if(null==i)return $("Could not get fingerings"),null;var o=a.button.cost;if(0!=i.states.length){var _=i.states[0].button;i.states[0].button.finger,F(a.button,_)&&($("Penalizing finger hop for note "+t),o+=100)}if($("path had cost of "+i.cost+" my cost="+o),i.cost+o<s.cost){var u=i.states.slice(0);u.unshift(a),$("New best path for note["+t+"], cost="+(s=new p(u,i.cost+o)).cost)}}return g[a]=s,$("Done choosing: current note="+t+" button="+a.button.name+" best cost="+s.cost),s}(a));return null==w?($("No fingerings generated!"),r):r=function e(a,n,r){if(n.states.shift(),n.states.length!=r.length)return"ERROR: Internal error. Length mismatch";for(var t=a,s=0,c=parseInt(gInjectTab_TabLocation),l=0;l<n.states.length;++l){var i=r[l].index+s,o=n.states[l].button.name;if(gInjectTab_GaryCoover){if(0==n.states[l].button.finger.indexOf("l")){if(n.states[l].direction==y)o='"_ ;'+o+'"';else{for(var _=o.length,u="",d=0;d<_;++d)u+="_";var f=o;o=(o='"_'+u+";")+f+'"'}}else if(n.states[l].direction==y)o='"^'+o+'"';else{for(var _=o.length,u="",d=0;d<_;++d)u+="_";var f=o;o=(o='"^'+u+";")+f+'"'}}else if(gInjectTab_UseBarForDraw)switch(c){case 0:if(n.states[l].direction==y)o='"^'+o+'"';else{for(var _=o.length,u="",d=0;d<_;++d)u+="_";var f=o;o=(o='"^'+u+";")+f+'"'}break;case 1:if(n.states[l].direction==y)o='"_ ;'+o+'"';else{for(var _=o.length,u="",d=0;d<_;++d)u+="_";var f=o;o=(o='"_'+u+";")+f+'"'}}else switch(c){case 0:o=(o='"^'+o+";")+n.states[l].direction+'"';break;case 1:o=(o='"_'+o+";")+n.states[l].direction+'"'}var g=o.length;t=t.substr(0,i)+o+t.substr(i),s+=g}return t}(e,w,h)}var p=function(e,a){this.states=e,this.cost=a},v=function(e,a,n){this.index=e,this.unNormalizedValue=a,this.normalizedValue=n},m=function(e,a,n){this.note=e,this.button=a,this.direction=n,this.nextStates=[],this.id=h++,this.toString=function(){var e="["+this.id+"] Note:";return this.note?e+=this.note.normalizedValue:e+="none",e+=" Button:"+this.button.name}};function G(e,a){var n="FCGDAEB",r={sharps:"",flats:""},t=n.indexOf(e[0])-1;if(-2==t)return $("Bad tonic: "+e),null;"b"==e.slice(1)?t-=7:"#"==e.slice(1)&&(t+=7);var s=t-a;return s>7?($("Too many sharps: "+s),null):s<-7?($("Too many flats: "+-1*s),null):(s>0?r.sharps=n.slice(0,s):s<0&&(r.flats=n.slice(s)),r.accidentalSharps="",r.accidentalFlats="",r.accidentalNaturals="",r)}function A(e,a){if(e.normalizedValue==a.notes[0])return y;if(e.normalizedValue==a.notes[1])return w;var n=function e(a){var n=a,r={"^A":"_B","^D":"_E","^G":"_A"};for(var t in r)n=(n=n.replace(t,r[t])).replace(t.toLowerCase(),r[t].toLowerCase());return n}(e.normalizedValue);return n==a.notes[0]?y:n==a.notes[1]?w:" "}function F(e,a){return e.finger==a.finger&&e.name!=a.name}function D(e,a,n){for(var r="",t=0;t<n;++t)r+="*";return e.substr(0,a)+r+e.substr(a+n)}function E(e){var a=e,n={_B:"^A","^B":"C",_C:"B",_D:"^C","^D":"_E",_E:"^D","^E":"F",_F:"E",_G:"^F","^G":"_A"};for(var r in n)a=(a=a.replace(r,n[r])).replace(r.toLowerCase(),n[r].toLowerCase());return a}function C(e){var a=e.search(/[A-G]/i);if(-1==a)return $("Failed to find basename for value!"),e;var n=e.substr(a,1).toUpperCase();return"="==e.substr(0,1)?(f.accidentalFlats=f.accidentalFlats.replace(n,""),f.accidentalSharps=f.accidentalSharps.replace(n,""),f.accidentalNaturals+=n,e.substr(1)):"_"==e.substr(0,1)?(f.accidentalFlats+=n,f.accidentalSharps=f.accidentalSharps.replace(n,""),f.accidentalNaturals=f.accidentalNaturals.replace(n,""),e):"^"==e.substr(0,1)?(f.accidentalFlats=f.accidentalFlats.replace(n,""),f.accidentalNaturals=f.accidentalNaturals.replace(n,""),f.accidentalSharps+=n,e):-1!=f.accidentalNaturals.search(n)?e:-1!=f.sharps.search(n)||-1!=f.accidentalSharps.search(n)?"^"+e:-1!=f.flats.search(n)||-1!=f.accidentalFlats.search(n)?"_"+e:e}function B(e){return e.split(/^X:.*$/gm).length-1}var y="↓",w="↑";return function e(a,n){var r=a.split(/^X:.*$/gm).length-1,t=gInjectTab_FontFamily,s=gInjectTab_TabFontSize,c=gInjectTab_MusicSpace,l=gInjectTab_StaffSep,i=parseInt(gInjectTab_TabLocation),o=gInjectTab_StripChords;y=gInjectTab_PushGlyph,w=gInjectTab_DrawGlyph;var _=FindPreTuneHeader(a),u=!1,d=[],f=parseInt(gInjectTab_TabLocation);clearGetTuneByIndexCache();for(var g=0;g<r;++g){var h=getTuneByIndex(g),$=h;if(isSectionHeader(h)||isMultiVoiceTune(h)){_+="\n",_+=h,_+="\n\n";continue}h=StripTabOne(h),(gInjectTab_GaryCoover||0==i||1==i&&o)&&(h=StripChordsOne(h));try{h=x(h)}catch(p){_+=$;var v=getTuneTitle($);d.push(v),u=!0;continue}h=InjectStringBelowTuneHeaderConditional(h,"%%staffsep "+l),h=InjectStringAboveTuneHeaderConditional(h,"%%annotationfont "+t+" "+s),(0==f||gInjectTab_GaryCoover)&&(h=InjectStringAboveTuneHeaderConditional(h,"%%musicspace "+c)),_+=h=h.replaceAll("\n\n","\n"),_+="\n\n"}if(_=normalizeBlankLines(_),u){for(var m='<p style="text-align:center;font-size:18px;margin-bottom:18px">No Anglo Concertina tablature generated for one or more tunes:</p>',G=0;G<d.length;++G)m+='<p style="text-align:center;font-size:18px;">'+d[G]+"</p>";n(_,!0,m+='<p style="text-align:center;font-size:18px;line-height:24px;margin-top:18px">Some notes may be outside the range or not available on the selected style of Anglo concertina.</p>')}else n(_,!1,"")}(e,a)},boxTabGenerator=function(e){var a=null;function n(e){}function r(e){n("Got input:"+e);var r=parseInt(gInjectTab_BoxStyle);if(null==(a=function e(a){var r,t,c=null,l=a.match(/^K: *([A-G])([b#])? *(.*?)$/m);if(null==l||l.length<3)return null;if(r=void 0==l[2]?l[1]:l[1]+l[2],n("Got base key of '"+r+"' and extra of '"+(t=(t=(t=l[3].toLowerCase()).replace(/%.*/,"")).trim())+"'"),""==t||-1!=t.search("maj")||-1!=t.search("ion")?(n("Mode: Ionian (major)"),c=s(r,0)):-1!=t.search("mix")?(n("Mode: Mixolydian"),c=s(r,1)):-1!=t.search("dor")?(n("Mode: Dorian"),c=s(r,2)):-1!=t.search("m")&&-1==t.search("mix")||-1!=t.search("min")||-1!=t.search("aeo")?(n("Mode: Aeolian (minor)"),c=s(r,3)):-1!=t.search("phr")?(n("Mode: Phrygian"),c=s(r,4)):-1!=t.search("loc")?(n("Mode: Locrian"),c=s(r,5)):-1!=t.search("lyd")?(n("Mode: Lydian"),c=s(r,-1)):-1!=t.search("exp")?(n("(Accidentals to be explicitly specified)"),c=s("C",0)):(n("Failed to determine key signature mode"),c=null),null==c)return c;var i=t.match(/_./g),o=t.match(/\^./g);for(note in i)c.flats+=i[note][1].toUpperCase();for(note in o)c.sharps+=o[note][1].toUpperCase();return c}(e)))return"ERROR: Unknown or unsupported key signature";var o=function e(r,s){for(var o,_,u=r,d=/^\w:.*$/mg;o=d.exec(r);)u=c(u,o.index,o[0].length);for(var f=/"[^"]*"/gm;_=f.exec(u);)for(var g=_.index,h=g+_[0].length,$=g;$<h;++$)u=u.substring(0,$)+"*"+u.substring($+1);for(f=/\[[^\]|]*\]/g;_=f.exec(u);)for(var g=_.index,h=g+_[0].length,$=g;$<h;++$)u=u.substring(0,$)+"*"+u.substring($+1);for(f=/![^!\n]*!/gm;_=f.exec(u);)for(var g=_.index,h=g+_[0].length,$=g;$<h;++$)u=u.substring(0,$)+"*"+u.substring($+1);for(f=/^%%begintext((.|\n)*)%%endtext/gm;_=f.exec(u);)for(var g=_.index,h=g+_[0].length,$=g;$<h;++$)u=u.substring(0,$)+"*"+u.substring($+1);for(f=/^%.*$/gm;_=f.exec(u);)for(var g=_.index,h=g+_[0].length,$=g;$<h;++$)u=u.substring(0,$)+"*"+u.substring($+1);n("sanitized input:"+(u=u.replaceAll("!","*")));for(var x=/([=^_]?[a-gA-G][',]?|\|)/g,p=[];_=x.exec(u);){var v=_[1];if("|"==v)a.accidentalFlats="",a.accidentalSharps="",a.accidentalNaturals="";else{var m=i(v);n("UnNormalized="+v+" normalized="+m);var G=l(m,s);p.push(new t(_.index,v,m,G))}}return p}(e,r);return function e(a,n){for(var r,t=a,s=0,c=parseInt(gInjectTab_TabLocation),l=0;l<n.length;++l){var i=n[l].index+s,o=n[l].glyph,u=o.length,d=o.substr(0,1),f=o.substr(1,u-1);if(0==o.indexOf("10")&&(d=o.substr(0,2),f=o.substr(2,u-1)),1==gInjectTab_BoxTabStyle){switch(d){case"①":d="1'";break;case"②":d="2'";break;case"③":d="3'";break;case"④":d="4'";break;case"⑤":d="5'";break;case"⑥":d="6'";break;case"⑦":d="7'";break;case"⑧":d="8'";break;case"⑨":d="9'";break;case"⑩":d="10'";break;case"⑪":d="11'"}r=f==_?'"_'+d+';-; "':'"_ ;-;'+d+'"'}else if(gInjectTab_UseBarForDraw)switch(c){case 0:if(f==_)r='"^'+d+'"';else{for(var g=d.length,h="",$=0;$<g;++$)h+="_";if(gIsChrome||gIsSafari)switch(d){case"①":case"②":case"③":case"④":case"⑤":case"⑥":case"⑦":case"⑧":case"⑨":case"⑩":case"⑪":h+="_"}r=(r='"^'+h+";")+d+'"'}break;case 1:if(f==_)r='"_ ;'+d+'"';else{for(var g=d.length,h="",$=0;$<g;++$)h+="_";if(gIsChrome||gIsSafari)switch(d){case"①":case"②":case"③":case"④":case"⑤":case"⑥":case"⑦":case"⑧":case"⑨":case"⑩":case"⑪":h+="_"}r=(r='"_'+h+";")+d+'"'}}else switch(c){case 0:r=(r='"^'+d+";")+f+'"';break;case 1:r=(r='"_'+d+";")+f+'"'}var x=r.length;t=t.substr(0,i)+r+t.substr(i),s+=x}return t}(e,o)}var t=function(e,a,n,r){this.index=e,this.unNormalizedValue=a,this.normalizedValue=n,this.glyph=r};function s(e,a){var r="FCGDAEB",t={sharps:"",flats:""},s=r.indexOf(e[0])-1;if(-2==s)return n("Bad tonic: "+e),null;"b"==e.slice(1)?s-=7:"#"==e.slice(1)&&(s+=7);var c=s-a;return c>7?(n("Too many sharps: "+c),null):c<-7?(n("Too many flats: "+-1*c),null):(c>0?t.sharps=r.slice(0,c):c<0&&(t.flats=r.slice(c)),t.accidentalSharps="",t.accidentalFlats="",t.accidentalNaturals="",t)}function c(e,a,n){for(var r="",t=0;t<n;++t)r+="*";return e.substr(0,a)+r+e.substr(a+n)}function l(e,a){switch(a){case 0:var n={"^D,":"①"+_,"_E,":"①"+_,"E,":"1"+_,"F,":"x ","^F,":"②"+_,"_G,":"②"+_,"G,":"2"+_,"^G,":"①"+u,"_A,":"①"+u,"A,":"1"+u,"^A,":"②"+u,"_B,":"②"+u,"B,":"2"+u,C:"3"+_,"^C":"③"+u,_D:"③"+u,D:"3"+u,"^D":"④"+_,_E:"④"+_,E:"4"+_,F:"4"+u,"^F":"⑤"+_,_G:"⑤"+_,G:"5"+_,"^G":"⑤"+u,_A:"⑤"+u,A:"5"+u,"^A":"⑥"+u,_B:"⑥"+u,B:"6"+u,c:"6"+_,"^c":"⑦"+u,_d:"⑦"+u,d:"7"+u,"^d":"⑦"+_,_e:"⑦"+_,e:"7"+_,f:"8"+u,"^f":"⑧"+_,_g:"⑧"+_,g:"8"+_,"^g":"⑨"+u,_a:"⑨"+u,a:"9"+u,"^a":"⑩"+u,_b:"⑩"+u,b:"10"+u,"c'":"9"+_,"^c'":"⑪"+u,"_d'":"⑪"+u,"d'":"x ","^d'":"⑩"+_,"_e'":"⑩"+_,"e'":"10"+_,"^f'":"⑪"+_,"_g'":"⑪"+_},r=n[e];if(!r)return"x ";break;case 1:var n={"F,":"①"+_,"^F,":"1"+_,"_G,":"1"+_,"G,":"x ","^G,":"②"+_,"_A,":"②"+_,"A,":"2"+_,"^A,":"①"+u,"_B,":"①"+u,"B,":"1"+u,C:"②"+u,"^C":"2"+u,_D:"2"+u,D:"3"+_,"^D":"③"+u,_E:"③"+u,E:"3"+u,F:"④"+_,"^F":"4"+_,_G:"4"+_,G:"4"+u,"^G":"⑤"+_,_A:"⑤"+_,A:"5"+_,"^A":"⑤"+u,_B:"⑤"+u,B:"5"+u,c:"⑥"+u,"^c":"6"+u,_d:"6"+u,d:"6"+_,"^d":"⑦"+u,_e:"⑦"+u,e:"7"+u,f:"⑦"+_,"^f":"7"+_,_g:"7"+_,g:"8"+u,"^g":"⑧"+_,_a:"⑧"+_,a:"8"+_,"^a":"⑨"+u,_b:"⑨"+u,b:"9"+u,"c'":"⑩"+u,"^c'":"10"+u,"_d'":"10"+u,"d'":"9"+_,"^d'":"⑪"+u,"_e'":"⑪"+u,"e'":"x ","f'":"⑩"+_,"^f'":"10"+_,"_g'":"10"+_,"g'":"x ","^g'":"⑪"+_,"_a'":"⑪"+_},r=n[e];if(!r)return"x "}return r}function i(e){var r=e.search(/[A-G]/i);if(-1==r)return n("Failed to find basename for value!"),e;var t=e.substr(r,1).toUpperCase();return"="==e.substr(0,1)?(a.accidentalFlats=a.accidentalFlats.replace(t,""),a.accidentalSharps=a.accidentalSharps.replace(t,""),a.accidentalNaturals+=t,e.substr(1)):"_"==e.substr(0,1)?(a.accidentalFlats+=t,a.accidentalSharps=a.accidentalSharps.replace(t,""),a.accidentalNaturals=a.accidentalNaturals.replace(t,""),e):"^"==e.substr(0,1)?(a.accidentalFlats=a.accidentalFlats.replace(t,""),a.accidentalNaturals=a.accidentalNaturals.replace(t,""),a.accidentalSharps+=t,e):-1!=a.accidentalNaturals.search(t)?e:-1!=a.sharps.search(t)||-1!=a.accidentalSharps.search(t)?"^"+e:-1!=a.flats.search(t)||-1!=a.accidentalFlats.search(t)?"_"+e:e}function o(e){return e.split(/^X:.*$/gm).length-1}var _="↓",u="↑";return function e(a){var n=a.split(/^X:.*$/gm).length-1,t=gInjectTab_FontFamily,s=gInjectTab_TabFontSize,c=gInjectTab_MusicSpace,l=gInjectTab_StaffSep,i=parseInt(gInjectTab_TabLocation),o=gInjectTab_StripChords;_=gInjectTab_PushGlyph,u=gInjectTab_DrawGlyph;var d=FindPreTuneHeader(a),f=parseInt(gInjectTab_TabLocation);clearGetTuneByIndexCache();for(var g=0;g<n;++g){var h=getTuneByIndex(g);if(isSectionHeader(h)||isMultiVoiceTune(h)){d+="\n",d+=h,d+="\n\n";continue}h=StripTabOne(h),(0==i||1==i&&o)&&(h=StripChordsOne(h)),h=r(h),h=InjectStringBelowTuneHeaderConditional(h,"%%staffsep "+l),h=InjectStringAboveTuneHeaderConditional(h,"%%annotationfont "+t+" "+s),0==f&&(h=InjectStringAboveTuneHeaderConditional(h,"%%musicspace "+c)),d+=h,d+="\n\n"}return normalizeBlankLines(d)}(e)},bambooFluteTabGenerator=function(e){var a="",n=null;function r(e){}function t(e){r("Got input:"+e);var t=parseInt(gBambooFluteKey);if(null==(n=function e(a){var n,t,s=null,l=a.match(/^K: *([A-G])([b#])? *(.*?)$/m);if(null==l||l.length<3)return null;if(n=void 0==l[2]?l[1]:l[1]+l[2],r("Got base key of '"+n+"' and extra of '"+(t=(t=(t=l[3].toLowerCase()).replace(/%.*/,"")).trim())+"'"),""==t||-1!=t.search("maj")||-1!=t.search("ion")?(r("Mode: Ionian (major)"),s=c(n,0)):-1!=t.search("mix")?(r("Mode: Mixolydian"),s=c(n,1)):-1!=t.search("dor")?(r("Mode: Dorian"),s=c(n,2)):-1!=t.search("m")&&-1==t.search("mix")||-1!=t.search("min")||-1!=t.search("aeo")?(r("Mode: Aeolian (minor)"),s=c(n,3)):-1!=t.search("phr")?(r("Mode: Phrygian"),s=c(n,4)):-1!=t.search("loc")?(r("Mode: Locrian"),s=c(n,5)):-1!=t.search("lyd")?(r("Mode: Lydian"),s=c(n,-1)):-1!=t.search("exp")?(r("(Accidentals to be explicitly specified)"),s=c("C",0)):(r("Failed to determine key signature mode"),s=null),null==s)return s;var i=t.match(/_./g),o=t.match(/\^./g);for(note in i)s.flats+=i[note][1].toUpperCase();for(note in o)s.sharps+=o[note][1].toUpperCase();return s}(e)))return"ERROR: Unknown or unsupported key signature";var _=function e(a,t){for(var c,_,u=a,d=/^\w:.*$/mg;c=d.exec(a);)u=l(u,c.index,c[0].length);for(var f=/"[^"]*"/gm;_=f.exec(u);)for(var g=_.index,h=g+_[0].length,$=g;$<h;++$)u=u.substring(0,$)+"*"+u.substring($+1);for(f=/\[[^\]|]*\]/g;_=f.exec(u);)for(var g=_.index,h=g+_[0].length,$=g;$<h;++$)u=u.substring(0,$)+"*"+u.substring($+1);for(f=/![^!\n]*!/gm;_=f.exec(u);)for(var g=_.index,h=g+_[0].length,$=g;$<h;++$)u=u.substring(0,$)+"*"+u.substring($+1);for(f=/^%%begintext((.|\n)*)%%endtext/gm;_=f.exec(u);)for(var g=_.index,h=g+_[0].length,$=g;$<h;++$)u=u.substring(0,$)+"*"+u.substring($+1);for(f=/^%.*$/gm;_=f.exec(u);)for(var g=_.index,h=g+_[0].length,$=g;$<h;++$)u=u.substring(0,$)+"*"+u.substring($+1);r("sanitized input:"+(u=u.replaceAll("!","*")));for(var x=/([=^_]?[a-gA-G][',]?|\|)/g,p=[];_=x.exec(u);){var v=_[1];if("|"==v)n.accidentalFlats="",n.accidentalSharps="",n.accidentalNaturals="";else{var m=o(v);r("UnNormalized="+v+" normalized="+m);var G=i(m,t);p.push(new s(_.index,v,m,G))}}return p}(e,t);return a=function e(a,n){for(var r,t=a,s=0,c=0;c<n.length;++c){var l=n[c].index+s,i=n[c].glyph,o=i.length,_=i.substr(0,o-1),u=i.substr(o-1,o-1),d=(r="-"!=u?'"_'+u+";"+_+'"':'"_ ;'+_+';•"').length;t=t.substr(0,l)+r+t.substr(l),s+=d}return t}(e,_)}var s=function(e,a,n,r){this.index=e,this.unNormalizedValue=a,this.normalizedValue=n,this.glyph=r};function c(e,a){var n="FCGDAEB",t={sharps:"",flats:""},s=n.indexOf(e[0])-1;if(-2==s)return r("Bad tonic: "+e),null;"b"==e.slice(1)?s-=7:"#"==e.slice(1)&&(s+=7);var c=s-a;return c>7?(r("Too many sharps: "+c),null):c<-7?(r("Too many flats: "+-1*c),null):(c>0?t.sharps=n.slice(0,c):c<0&&(t.flats=n.slice(c)),t.accidentalSharps="",t.accidentalFlats="",t.accidentalNaturals="",t)}function l(e,a,n){for(var r="",t=0;t<n;++t)r+="*";return e.substr(0,a)+r+e.substr(a+n)}function i(e,a){var n="";switch(a){case 0:var r={"G,":"5-","^G,":"#5-","_A,":"#5-","A,":"6-","^A,":"#6-","_B,":"#6-","B,":"7-",C:"1 ","^C":"#1 ",_D:"#1 ",D:"2 ","^D":"#2 ",_E:"#2 ",E:"3 ",F:"4 ","^F":"#4 ",_G:"#4 ",G:"5 ","^G":"#5 ",_A:"#5 ",A:"6 ","^A":"#6 ",_B:"#6 ",B:"7 ",c:"1•","^c":"#1•",_d:"#1•",d:"2•","^d":"#2•",_e:"#2•",e:"3•",f:"4•","^f":"#4•",_g:"#4•",g:"5•","^g":"#5•",_a:"#5•",a:"6•","^a":"#6•",_b:"#6•",b:"7•"};if(!(n=r[e]))return"x ";break;case 1:var r={"G,":"4-","^G,":"#4-","_A,":"#4-","A,":"5-","^A,":"#5-","_B,":"#5-","B,":"6-",C:"#6-","^C":"7-",_D:"7-",D:"1 ","^D":"#1 ",_E:"#1 ",E:"2 ",F:"#2 ","^F":"3 ",_G:"3 ",G:"4 ","^G":"#4 ",_A:"#4 ",A:"5 ","^A":"#5 ",_B:"#5 ",B:"6 ",c:"#6 ","^c":"7 ",_d:"7 ",d:"1•","^d":"#1•",_e:"#1•",e:"2•",f:"#2•","^f":"3•",_g:"3•",g:"4•","^g":"#4•",_a:"#4•",a:"5•","^a":"#5•",_b:"#5•",b:"6•","c'":"#6•","^c'":"7•"};if(!(n=r[e]))return"x ";break;case 2:var r={"G,":"1-","^G,":"#1-","_A,":"#1-","A,":"2-","^A,":"#2-","_B,":"#2-","B,":"3-",C:"4-","^C":"#4-",_D:"#4-",D:"5-","^D":"#5-",_E:"#5-",E:"6-",F:"#6-","^F":"7-",G:"1 ","^G":"#1 ",_A:"#1 ",A:"2 ","^A":"#2 ",_B:"#2 ",B:"3 ",c:"4 ","^c":"#4 ",_d:"#4 ",d:"5 ","^d":"#5 ",_e:"#5 ",e:"6 ",f:"#6 ","^f":"7 ",_g:"7 ",g:"1•","^g":"#1•",_a:"#1•",a:"2•","^a":"#2•",_b:"#2•",b:"3•","c'":"4•","^c'":"#4•","_d'":"#4•","d'":"5•","^d'":"#5•","_e'":"#5•","e'":"6•","f'":"6#•","^f'":"7•","_g'":"7•"};if(!(n=r[e]))return"x ";break;case 3:var r={"A,":"1-","^A,":"#1-","_B,":"#1-","B,":"2-",C:"#2-","^C":"3-",_D:"3-",D:"4-","^D":"#4-",_E:"#4-",E:"5-",F:"#5-","^F":"6-",_G:"6-",G:"6#-","^G":"7-",_A:"7-",A:"1 ","^A":"#1 ",_B:"#1 ",B:"2 ",c:"#2 ","^c":"3 ",_d:"3 ",d:"4 ","^d":"#4 ",_e:"#4 ",e:"5 ",f:"#5 ","^f":"6 ",_g:"6 ",g:"6# ","^g":"7 ",_a:"7 ",a:"1•","^a":"#1•",_b:"#1•",b:"2•","c'":"#2•","^c'":"3•","_d'":"3•","d'":"4•","^d'":"#4•","_e'":"#4•","e'":"5•","f'":"#5•","^f'":"6•","_g'":"6•","g'":"6#•","^g'":"7•","_a'":"7•"};if(!(n=r[e]))return"x "}return n}function o(e){var a=e.search(/[A-G]/i);if(-1==a)return r("Failed to find basename for value!"),e;var t=e.substr(a,1).toUpperCase();return"="==e.substr(0,1)?(n.accidentalFlats=n.accidentalFlats.replace(t,""),n.accidentalSharps=n.accidentalSharps.replace(t,""),n.accidentalNaturals+=t,e.substr(1)):"_"==e.substr(0,1)?(n.accidentalFlats+=t,n.accidentalSharps=n.accidentalSharps.replace(t,""),n.accidentalNaturals=n.accidentalNaturals.replace(t,""),e):"^"==e.substr(0,1)?(n.accidentalFlats=n.accidentalFlats.replace(t,""),n.accidentalNaturals=n.accidentalNaturals.replace(t,""),n.accidentalSharps+=t,e):-1!=n.accidentalNaturals.search(t)?e:-1!=n.sharps.search(t)||-1!=n.accidentalSharps.search(t)?"^"+e:-1!=n.flats.search(t)||-1!=n.accidentalFlats.search(t)?"_"+e:e}function _(e){return e.split(/^X:.*$/gm).length-1}return function e(a){var n=a.split(/^X:.*$/gm).length-1,r=gInjectTab_FontFamily,s=gInjectTab_TabFontSize,c=gInjectTab_StaffSep;parseInt(gInjectTab_TabLocation);var l=gInjectTab_StripChords,i=FindPreTuneHeader(a);clearGetTuneByIndexCache();for(var o=0;o<n;++o){var _=getTuneByIndex(o);if(isSectionHeader(_)||isMultiVoiceTune(_)){i+="\n",i+=_,i+="\n\n";continue}switch(_=StripTabOne(_),l&&(_=StripChordsOne(_)),_=t(_),_=InjectStringBelowTuneHeaderConditional(_,"%%staffsep "+c),parseInt(gBambooFluteKey)){case 0:_=InjectStringBelowTuneHeaderConditional(_,"%%text 1=C"),_=InjectStringBelowTuneHeaderConditional(_,"%%text ");break;case 1:_=InjectStringBelowTuneHeaderConditional(_,"%%text 1=D"),_=InjectStringBelowTuneHeaderConditional(_,"%%text ");break;case 2:_=InjectStringBelowTuneHeaderConditional(_,"%%text 1=G"),_=InjectStringBelowTuneHeaderConditional(_,"%%text ");break;case 3:_=InjectStringBelowTuneHeaderConditional(_,"%%text 1=A"),_=InjectStringBelowTuneHeaderConditional(_,"%%text ")}_=(_=InjectStringAboveTuneHeaderConditional(_,"%%annotationfont "+r+" "+s)).replaceAll("\n\n","\n"),i+=_,i+="\n\n"}return normalizeBlankLines(i)}(e)},ceoltasABCTransformer=function(e,a,n){var r="",t=null;function s(e){}function c(e,a,n){if(s("Got input:"+e),null==(t=function e(a){var n,r,t=null,c=a.match(/^K: *([A-G])([b#])? *(.*?)$/m);if(null==c||c.length<3)return null;if(n=void 0==c[2]?c[1]:c[1]+c[2],s("Got base key of '"+n+"' and extra of '"+(r=(r=(r=c[3].toLowerCase()).replace(/%.*/,"")).trim())+"'"),""==r||-1!=r.search("maj")||-1!=r.search("ion")?(s("Mode: Ionian (major)"),t=i(n,0)):-1!=r.search("mix")?(s("Mode: Mixolydian"),t=i(n,1)):-1!=r.search("dor")?(s("Mode: Dorian"),t=i(n,2)):-1!=r.search("m")&&-1==r.search("mix")||-1!=r.search("min")||-1!=r.search("aeo")?(s("Mode: Aeolian (minor)"),t=i(n,3)):-1!=r.search("phr")?(s("Mode: Phrygian"),t=i(n,4)):-1!=r.search("loc")?(s("Mode: Locrian"),t=i(n,5)):-1!=r.search("lyd")?(s("Mode: Lydian"),t=i(n,-1)):-1!=r.search("exp")?(s("(Accidentals to be explicitly specified)"),t=i("C",0)):(s("Failed to determine key signature mode"),t=null),null==t)return t;var l=r.match(/_./g),o=r.match(/\^./g);for(note in l)t.flats+=l[note][1].toUpperCase();for(note in o)t.sharps+=o[note][1].toUpperCase();return t}(e)))return"ERROR: Unknown or unsupported key signature";var c=function e(a,n,r){for(var c,i,d=a,f=/^\w:.*$/mg;c=f.exec(a);)d=o(d,c.index,c[0].length);for(var g=/"[^"]*"/gm;i=g.exec(d);)for(var h=i.index,$=h+i[0].length,x=h;x<$;++x)d=d.substring(0,x)+"*"+d.substring(x+1);for(g=/\[[^\]|]*\]/g;i=g.exec(d);)for(var h=i.index,$=h+i[0].length,x=h;x<$;++x)d=d.substring(0,x)+"*"+d.substring(x+1);for(g=/![^!\n]*!/gm;i=g.exec(d);)for(var h=i.index,$=h+i[0].length,x=h;x<$;++x)d=d.substring(0,x)+"*"+d.substring(x+1);for(g=/^%%begintext((.|\n)*)%%endtext/gm;i=g.exec(d);)for(var h=i.index,$=h+i[0].length,x=h;x<$;++x)d=d.substring(0,x)+"*"+d.substring(x+1);for(g=/^%.*$/gm;i=g.exec(d);)for(var h=i.index,$=h+i[0].length,x=h;x<$;++x)d=d.substring(0,x)+"*"+d.substring(x+1);s("sanitized input:"+(d=d.replaceAll("!","*")));for(var p=/([=^_]?[a-gA-G][',]?|\|)/g,v=[];i=p.exec(d);){var m=i[1];if("|"==m)t.accidentalFlats="",t.accidentalSharps="",t.accidentalNaturals="";else{var G=u(m);s("UnNormalized="+m+" normalized="+G);var A=_(m,n,r);v.push(new l(i.index,m,G,A))}}return v}(e,a,n);return r=function e(a,n){for(var r,t,s,c,l,i=a,o=0,_=0;_<n.length;++_)r=n[_].index+o,t=n[_].glyph,s=n[_].unNormalizedValue,glyphLen=t.length,c=s.length,i=i.substr(0,r)+t+i.substr(r+c),o+=l=glyphLen-c;return i}(e,c)}var l=function(e,a,n,r){this.index=e,this.unNormalizedValue=a,this.normalizedValue=n,this.glyph=r};function i(e,a){var n="FCGDAEB",r={sharps:"",flats:""},t=n.indexOf(e[0])-1;if(-2==t)return s("Bad tonic: "+e),null;"b"==e.slice(1)?t-=7:"#"==e.slice(1)&&(t+=7);var c=t-a;return c>7?(s("Too many sharps: "+c),null):c<-7?(s("Too many flats: "+-1*c),null):(c>0?r.sharps=n.slice(0,c):c<0&&(r.flats=n.slice(c)),r.accidentalSharps="",r.accidentalFlats="",r.accidentalNaturals="",r)}function o(e,a,n){for(var r="",t=0;t<n;++t)r+="*";return e.substr(0,a)+r+e.substr(a+n)}function _(e,a,n){if(n){var r={"D,":"D,","^D,":"D#,","_E,":"Eb,","E,":"E,","^E,":"E#,","_F,":"Fb,","F,":"F,","^F,":"F#,","_G,":"Gb,","G,":"G,","^G,":"G#,","_A,":"Ab,","A,":"A,","^A,":"A#,","_B,":"Bb,","B,":"B,","^B,":"B#,",_C:"Cb,",C:"C,","^C":"C,#",_D:"Db",D:"D","^D":"D#",_E:"Eb",E:"E","^E":"E#",_F:"Fb",F:"F","^F":"F#",_G:"Gb",G:"G","^G":"G#",_A:"Ab",A:"A","^A":"A#",_B:"Bb",B:"B","^B":"B#",_c:"Cb",c:"C","^c":"C#",_d:"Db'",d:"D'","^d":"D#'",_e:"Eb'",e:"E'","^e":"E#'",_f:"Fb'",f:"F'","^f":"F#'",_g:"Gb'",g:"G'","^g":"G#'",_a:"Ab'",a:"A'","^a":"A#'",_b:"Bb'",b:"B'","^b":"B#'","_c'":"Cb'","c'":"C'","^c'":"C#'","_d'":"Db''","d'":"D''","^d'":"D#''","_e'":"Eb''","e'":"E''","^e'":"E#''","_f'":"Fb''","f'":"F''","^f'":"F#''","_g'":"Gb''","g'":"G''","=D,":"D,","=E,":"E,","=F,":"F,","=G,":"G,","=A,":"A,","=B,":"B,","=C":"C,","=D":"D","=E":"E","=F":"F","=G":"G","=A":"A","=B":"B","=c":"C","=d":"D'","=e":"E'","=f":"F'","=g":"G'","=a":"A'","=b":"B'","=c'":"C'","=d'":"D''","=e'":"E''","=f'":"F''","=g'":"G''","C'":"C","^C'":"C#","_D'":"Db'","D'":"D'","^D'":"D#'","_E'":"Eb'","E'":"E'","F'":"F'","^F'":"F#'","_G'":"Gb'","G'":"G'","^G'":"G#'","_A'":"Ab'","A'":"A'","^A'":"A#'","_B'":"Bb'","B'":"B'","C''":"C'","^C''":"C#'","_D''":"Db''","D''":"D''","^D''":"D#''","_E''":"Eb''","E''":"E''","F''":"F''","^F''":"F#''","_G''":"Gb''","G''":"G''","=C'":"C","=D'":"D'","=E'":"E'","=F'":"F'","=G'":"G'","=A'":"A'","=B'":"B'","=C''":"C'","=D''":"D''","=E''":"E''","=F''":"F''","=G''":"G''"},t=r[e];return t||"x "}if(a){var r={"D,":"D,","^D,":"^D,","E,":"E,","F,":"F,","^F,":"^F,","_G,":"_G,","G,":"G,","^G,":"^G,","_A,":"_A,","A,":"A,","^A,":"^A,","_B,":"_B,","B,":"B,","^B,":"^B,",_C:"_C",C:"C","^C":"^C",_D:"_D",D:"D","^D":"^D",_E:"_E",E:"E","^E":"^E",_F:"_F",F:"F","^F":"^F",_G:"_G",G:"G","^G":"^G",_A:"_A",A:"A","^A":"^A",_B:"_B",B:"B","^B":"^B",_C:"_c","C'":"c","^C'":"^c","_D'":"_d","D'":"d","^D'":"^d","_E'":"_e","E'":"e","^E'":"^e","_F'":"_f","F'":"f","^F'":"^f","_G'":"_g","G'":"g","^G'":"^g","_A'":"_a","A'":"a","^A'":"^a","_B'":"_b","B'":"b","^B'":"^b","_C''":"_c'","C''":"c'","^C''":"^c'","_D''":"_d'","D''":"d'","^D''":"^d'","_E''":"_e'","E''":"e'","^E'":"^e'","_F'":"_f'","F''":"f'","^F''":"^f'","_G''":"_g'","G''":"g'","=D,":"=D,","=E,":"=E,","=F,":"=F,","=G,":"=G,","=A,":"=A,","=B,":"=B,","=C":"=C","=D":"=D","=E":"=E","=F":"=F","=G":"=G","=A":"=A","=B":"=B","=C'":"=c","=D'":"=d","=E'":"=e","=F'":"=f","=G'":"=g","=A'":"=a","=B'":"=b","=C''":"=c'","=D''":"=d'","=E''":"=e'","=F''":"=f'","=G''":"=g'",c:"c","^c":"^c",_d:"_d",d:"d","^d":"^d",_e:"_e",e:"e",f:"f","^f":"^f",_g:"_g",g:"g","^g":"^g",_a:"_a",a:"a","^a":"^a",_b:"_b",b:"b","c'":"c'","^c'":"^c'","_d'":"_d'","d'":"d'","^d'":"^d'","_e'":"_e'","e'":"e'","f'":"f'","^f'":"^f'","_g'":"_g'","g'":"g'","=c":"=c","=d":"=d","=e":"=e","=f":"=f","=g":"=g","=a":"=a","=b":"=b","=c'":"=c'","=d'":"=d'","=e'":"=e'","=f'":"=f'","=g'":"=g'"},t=r[e];return t||"x "}var r={"D,":"D,","^D,":"^D,","_E,":"_E,","E,":"E,","^E,":"^E,","_F,":"_F,","F,":"F,","^F,":"^F,","_G,":"_G,","G,":"G,","^G,":"^G,","_A,":"_A,","A,":"A,","^A,":"^A,","_B,":"_B,","B,":"B,","^B,":"^B,",_C:"_C",C:"C","^C":"^C",_D:"_D",D:"D","^D":"^D",_E:"_E",E:"E","^E":"^E",_F:"_F",F:"F","^F":"^F",_G:"_G",G:"G","^G":"^G",_A:"_A",A:"A","^A":"^A",_B:"_B",B:"B","^B":"^B",_c:"_C'",c:"C'","^c":"^C'",_d:"_D'",d:"D'","^d":"^D'",_e:"_E'",e:"E'","^e":"^E'",_f:"_F'",f:"F'","^f":"^F'",_g:"_G'",g:"G'","^g":"^G'",_a:"_A'",a:"A'","^a":"^A'",_b:"_B'",b:"B'","^b":"^B'","_c'":"_C''","c'":"C''","^c'":"^C''","_d'":"_D''","d'":"D''","^d'":"^D''","_e'":"_E''","e'":"E''","^e'":"^E''","_f'":"_F''","f'":"F''","^f'":"^F''","_g'":"_G''","g'":"G''","=D,":"=D,","=E,":"=E,","=F,":"=F,","=G,":"=G,","=A,":"=A,","=B,":"=B,","=C":"=C,","=D":"=D","=E":"=E","=F":"=F","=G":"=G","=A":"=A","=B":"=B","=c":"=C","=d":"=D'","=e":"=E'","=f":"=F'","=g":"=G'","=a":"=A'","=b":"=B'","=c'":"=C''","=d'":"=D''","=e'":"=E''","=f'":"=F''","=g'":"=G''","C'":"C'","^C'":"^C'","_D'":"_D'","D'":"D'","^D'":"^D'","_E'":"_E'","E'":"E'","F'":"F'","^F'":"^F'","_G'":"_G'","G'":"G'","^G'":"^G'","_A'":"_A'","A'":"A'","^A'":"^A'","_B'":"_B'","B'":"B'","C''":"C''","^C''":"^C''","_D''":"_D''","D''":"D''","^D''":"^D''","_E''":"_E''","E''":"E''","F''":"F''","^F''":"^F''","_G''":"_G''","G''":"G''","=C'":"=C'","=D'":"=D'","=E'":"=E'","=F'":"=F'","=G'":"=G'","=A'":"=A'","=B'":"=B'","=C''":"=C''","=D''":"=D''","=E''":"=E''","=F''":"=F''","=G''":"=G''"},t=r[e];return t||"x "}function u(e){var a=e.search(/[A-G]/i);if(-1==a)return s("Failed to find basename for value!"),e;var n=e.substr(a,1).toUpperCase();return"="==e.substr(0,1)?(t.accidentalFlats=t.accidentalFlats.replace(n,""),t.accidentalSharps=t.accidentalSharps.replace(n,""),t.accidentalNaturals+=n,e.substr(1)):"_"==e.substr(0,1)?(t.accidentalFlats+=n,t.accidentalSharps=t.accidentalSharps.replace(n,""),t.accidentalNaturals=t.accidentalNaturals.replace(n,""),e):"^"==e.substr(0,1)?(t.accidentalFlats=t.accidentalFlats.replace(n,""),t.accidentalNaturals=t.accidentalNaturals.replace(n,""),t.accidentalSharps+=n,e):-1!=t.accidentalNaturals.search(n)?e:-1!=t.sharps.search(n)||-1!=t.accidentalSharps.search(n)?"^"+e:-1!=t.flats.search(n)||-1!=t.accidentalFlats.search(n)?"_"+e:e}return function e(a,n,r){if(r){var t=c(a,n,r);return t}var s,l=(s=a).split(/^X:.*$/gm).length-1,i=FindPreTuneHeader(a);clearGetTuneByIndexCache();for(var o=0;o<l;++o){var t=getTuneByIndex(o);if(isSectionHeader(t)||isMultiVoiceTune(t)){i+="\n",i+=t,i+="\n\n";continue}t=c(t,n,r),i+=t,i+="\n\n"}return normalizeBlankLines(i)}(e,a,n)},fiddleFingeringsGenerator=function(e,a){var n="",r=null;function t(e){}function s(e){if(t("Got input:"+e),null==(r=function e(a){var n,r,s=null,c=a.match(/^K: *([A-G])([b#])? *(.*?)$/m);if(null==c||c.length<3)return null;if(n=void 0==c[2]?c[1]:c[1]+c[2],t("Got base key of '"+n+"' and extra of '"+(r=(r=(r=c[3].toLowerCase()).replace(/%.*/,"")).trim())+"'"),""==r||-1!=r.search("maj")||-1!=r.search("ion")?(t("Mode: Ionian (major)"),s=l(n,0)):-1!=r.search("mix")?(t("Mode: Mixolydian"),s=l(n,1)):-1!=r.search("dor")?(t("Mode: Dorian"),s=l(n,2)):-1!=r.search("m")&&-1==r.search("mix")||-1!=r.search("min")||-1!=r.search("aeo")?(t("Mode: Aeolian (minor)"),s=l(n,3)):-1!=r.search("phr")?(t("Mode: Phrygian"),s=l(n,4)):-1!=r.search("loc")?(t("Mode: Locrian"),s=l(n,5)):-1!=r.search("lyd")?(t("Mode: Lydian"),s=l(n,-1)):-1!=r.search("exp")?(t("(Accidentals to be explicitly specified)"),s=l("C",0)):(t("Failed to determine key signature mode"),s=null),null==s)return s;var i=r.match(/_./g),o=r.match(/\^./g);for(note in i)s.flats+=i[note][1].toUpperCase();for(note in o)s.sharps+=o[note][1].toUpperCase();return s}(e)))return"ERROR: Unknown or unsupported key signature";var s=function e(n,s){for(var l=n,h=/^\w:.*$/mg;F=h.exec(n);)l=i(l,F.index,F[0].length);for(var $=/"[^"]*"/gm;D=$.exec(l);)for(var x=D.index,p=x+D[0].length,v=x;v<p;++v)l=l.substring(0,v)+"*"+l.substring(v+1);for($=/\[[^\]|]*\]/g;D=$.exec(l);)for(var x=D.index,p=x+D[0].length,v=x;v<p;++v)l=l.substring(0,v)+"*"+l.substring(v+1);for($=/![^!\n]*!/gm;D=$.exec(l);)for(var x=D.index,p=x+D[0].length,v=x;v<p;++v)l=l.substring(0,v)+"*"+l.substring(v+1);for($=/^%%begintext((.|\n)*)%%endtext/gm;D=$.exec(l);)for(var x=D.index,p=x+D[0].length,v=x;v<p;++v)l=l.substring(0,v)+"*"+l.substring(v+1);for($=/^%.*$/gm;D=$.exec(l);)for(var x=D.index,p=x+D[0].length,v=x;v<p;++v)l=l.substring(0,v)+"*"+l.substring(v+1);t("sanitized input:"+(l=l.replaceAll("!","*")));for(var m=/([=^_]?[a-gA-G][',]?|\|)/g,G=[];D=m.exec(l);){var A=D[1];if("|"==A)r.accidentalFlats="",r.accidentalSharps="",r.accidentalNaturals="";else{var F,D,E,C=g(A);switch(t("UnNormalized="+A+" normalized="+C),a){case 0:E=o(C);break;case 1:default:E=_(C);break;case 2:E=u(C);break;case 3:E=d(C);break;case 4:E=f(C)}G.push(new c(D.index,A,C,E))}}return G}(e);return n=function e(a,n){for(var r=a,t=0,s=parseInt(gInjectTab_TabLocation),c=0;c<n.length;++c){var l=n[c].index+t,i=n[c].glyph;if(i.length,-1==i.indexOf("!"))switch(s){case 0:var o='"^'+i+'"';break;case 1:var o='"_'+i+'"'}else o=i;var _=o.length;r=r.substr(0,l)+o+r.substr(l),t+=_}return r}(e,s)}var c=function(e,a,n,r){this.index=e,this.unNormalizedValue=a,this.normalizedValue=n,this.glyph=r};function l(e,a){var n="FCGDAEB",r={sharps:"",flats:""},s=n.indexOf(e[0])-1;if(-2==s)return t("Bad tonic: "+e),null;"b"==e.slice(1)?s-=7:"#"==e.slice(1)&&(s+=7);var c=s-a;return c>7?(t("Too many sharps: "+c),null):c<-7?(t("Too many flats: "+-1*c),null):(c>0?r.sharps=n.slice(0,c):c<0&&(r.flats=n.slice(c)),r.accidentalSharps="",r.accidentalFlats="",r.accidentalNaturals="",r)}function i(e,a,n){for(var r="",t=0;t<n;++t)r+="*";return e.substr(0,a)+r+e.substr(a+n)}function o(e){var a=_(e);return -1==a.indexOf("x")&&(a="!"+a+"!"),a}function _(e){var a={"G,":"0","^G,":"1","_A,":"1","A,":"1","^A,":"2","_B,":"2","B,":"2",C:"3","^C":"3",_D:"3",D:"0","^D":"1",_E:"1",E:"1",F:"2","^F":"2",_G:"2",G:"3","^G":"3",_A:"3",A:"0","^A":"1",_B:"1",B:"1",c:"2","^c":"2",_d:"2",d:"3","^d":"3",_e:"3",e:"0",f:"1","^f":"1",_g:"1",g:"2","^g":"2",_a:"2",a:"3","^a":"3",_b:"3",b:"4","c'":"4","^c'":"4","_d'":"4","d'":"4"}[e];return a||"x "}function u(e){var a={"G,":"G0","^G,":"G1","_A,":"G1","A,":"G1","^A,":"G2","_B,":"G2","B,":"G2",C:"G3","^C":"G3",_D:"G3",D:"D0","^D":"D1",_E:"D1",E:"D1",F:"D2","^F":"D2",_G:"D2",G:"D3","^G":"D3",_A:"D3",A:"A0","^A":"A1",_B:"A1",B:"A1",c:"A2","^c":"A2",_d:"A2",d:"A3","^d":"A3",_e:"A3",e:"E0",f:"E1","^f":"E1",_g:"E1",g:"E2","^g":"E2",_a:"E2",a:"E3","^a":"E3",_b:"E3",b:"E4","c'":"E4","^c'":"E4","_d'":"E4","d'":"E4"}[e];return a||"x "}function d(e){var a={"G,":"G;0","^G,":"G;1","_A,":"G;1","A,":"G;1","^A,":"G;2","_B,":"G;2","B,":"G;2",C:"G;3","^C":"G;3",_D:"G;3",D:"D;0","^D":"D;1",_E:"D;1",E:"D;1",F:"D;2","^F":"D;2",_G:"D;2",G:"D;3","^G":"D;3",_A:"D;3",A:"A;0","^A":"A;1",_B:"A;1",B:"A;1",c:"A;2","^c":"A;2",_d:"A;2",d:"A;3","^d":"A;3",_e:"A;3",e:"E;0",f:"E;1","^f":"E;1",_g:"E;1",g:"E;2","^g":"E;2",_a:"E;2",a:"E;3","^a":"E;3",_b:"E;3",b:"E;4","c'":"E;4","^c'":"E;4","_d'":"E;4","d'":"E;4"}[e];return a||"x "}function f(e){var a={"G,":"0;G","^G,":"1;G","_A,":"1;G","A,":"1;G","^A,":"2;G","_B,":"2;G","B,":"2;G",C:"3;G","^C":"3;G",_D:"3;G",D:"0;D","^D":"1;D",_E:"1;D",E:"1;D",F:"2;D","^F":"2;D",_G:"2;D",G:"3;D","^G":"3;D",_A:"3;D",A:"0;A","^A":"1;A",_B:"1;A",B:"1;A",c:"2;A","^c":"2;A",_d:"2;A",d:"3;A","^d":"3;A",_e:"3;A",e:"0;E",f:"1;E","^f":"1;E",_g:"1;E",g:"2;E","^g":"2;E",_a:"2;E",a:"3;E","^a":"3;E",_b:"3;E",b:"4;E","c'":"4;E","^c'":"4;E","_d'":"4;E","d'":"4;E"}[e];return a||"x "}function g(e){var a=e.search(/[A-G]/i);if(-1==a)return t("Failed to find basename for value!"),e;var n=e.substr(a,1).toUpperCase();return"="==e.substr(0,1)?(r.accidentalFlats=r.accidentalFlats.replace(n,""),r.accidentalSharps=r.accidentalSharps.replace(n,""),r.accidentalNaturals+=n,e.substr(1)):"_"==e.substr(0,1)?(r.accidentalFlats+=n,r.accidentalSharps=r.accidentalSharps.replace(n,""),r.accidentalNaturals=r.accidentalNaturals.replace(n,""),e):"^"==e.substr(0,1)?(r.accidentalFlats=r.accidentalFlats.replace(n,""),r.accidentalNaturals=r.accidentalNaturals.replace(n,""),r.accidentalSharps+=n,e):-1!=r.accidentalNaturals.search(n)?e:-1!=r.sharps.search(n)||-1!=r.accidentalSharps.search(n)?"^"+e:-1!=r.flats.search(n)||-1!=r.accidentalFlats.search(n)?"_"+e:e}function h(e){return e.split(/^X:.*$/gm).length-1}return function e(n){var r=n.split(/^X:.*$/gm).length-1,t=gInjectTab_MusicSpace,c=gInjectTab_FontFamily,l=gInjectTab_TabFontSize,i=gInjectTab_StaffSep,o=parseInt(gInjectTab_TabLocation),_=gInjectTab_StripChords,u=FindPreTuneHeader(n),d=parseInt(gInjectTab_TabLocation);u=(u=u.replace("%%begincss\n/* Offset fingerings below notes, shift chords down */\n.abcjs-annotation {transform: translate(0px,75px);}\n.abcjs-chord {transform: translate(0px,15px);}\n%%endcss\n\n","")).replace("%%begincss\n/* Offset fingerings up */\n.abcjs-annotation {transform: translate(0px,-2px);}\n%%endcss\n\n",""),0==a&&(u=1==d?"%%begincss\n/* Offset fingerings below notes, shift chords down */\n.abcjs-annotation {transform: translate(0px,75px);}\n.abcjs-chord {transform: translate(0px,15px);}\n%%endcss\n\n"+u:"%%begincss\n/* Offset fingerings up */\n.abcjs-annotation {transform: translate(0px,-2px);}\n%%endcss\n\n"+u),clearGetTuneByIndexCache();for(var f=0;f<r;++f){var g=getTuneByIndex(f);if(isSectionHeader(g)||isMultiVoiceTune(g)){u+="\n",u+=g,u+="\n\n";continue}g=StripTabOne(g),0!=a?(0==o||1==o&&_)&&(g=StripChordsOne(g)):_&&(g=StripChordsOne(g)),g=s(g),g=InjectStringBelowTuneHeaderConditional(g,"%%staffsep "+i),g=InjectStringAboveTuneHeaderConditional(g,"%%annotationfont "+c+" "+l),0==d&&(g=InjectStringAboveTuneHeaderConditional(g,"%%musicspace "+t)),u+=g=g.replaceAll("\n\n","\n"),u+="\n\n"}return normalizeBlankLines(u)}(e)},MDTablatureGenerator=function(e){var a="",n=null;function r(e){}function t(e){r("Got input:"+e);var t=parseInt(gMDulcimerStyle);if(null==(n=function e(a){var n,t,s=null,l=a.match(/^K: *([A-G])([b#])? *(.*?)$/m);if(null==l||l.length<3)return null;if(n=void 0==l[2]?l[1]:l[1]+l[2],r("Got base key of '"+n+"' and extra of '"+(t=(t=(t=l[3].toLowerCase()).replace(/%.*/,"")).trim())+"'"),""==t||-1!=t.search("maj")||-1!=t.search("ion")?(r("Mode: Ionian (major)"),s=c(n,0)):-1!=t.search("mix")?(r("Mode: Mixolydian"),s=c(n,1)):-1!=t.search("dor")?(r("Mode: Dorian"),s=c(n,2)):-1!=t.search("m")&&-1==t.search("mix")||-1!=t.search("min")||-1!=t.search("aeo")?(r("Mode: Aeolian (minor)"),s=c(n,3)):-1!=t.search("phr")?(r("Mode: Phrygian"),s=c(n,4)):-1!=t.search("loc")?(r("Mode: Locrian"),s=c(n,5)):-1!=t.search("lyd")?(r("Mode: Lydian"),s=c(n,-1)):-1!=t.search("exp")?(r("(Accidentals to be explicitly specified)"),s=c("C",0)):(r("Failed to determine key signature mode"),s=null),null==s)return s;var i=t.match(/_./g),o=t.match(/\^./g);for(note in i)s.flats+=i[note][1].toUpperCase();for(note in o)s.sharps+=o[note][1].toUpperCase();return s}(e)))return"ERROR: Unknown or unsupported key signature";var _=function e(a,t){for(var c,_,u=a,d=/^\w:.*$/mg;c=d.exec(a);)u=l(u,c.index,c[0].length);for(var f=/"[^"]*"/gm;_=f.exec(u);)for(var g=_.index,h=g+_[0].length,$=g;$<h;++$)u=u.substring(0,$)+"*"+u.substring($+1);for(f=/\[[^\]|]*\]/g;_=f.exec(u);)for(var g=_.index,h=g+_[0].length,$=g;$<h;++$)u=u.substring(0,$)+"*"+u.substring($+1);for(f=/![^!\n]*!/gm;_=f.exec(u);)for(var g=_.index,h=g+_[0].length,$=g;$<h;++$)u=u.substring(0,$)+"*"+u.substring($+1);for(f=/^%%begintext((.|\n)*)%%endtext/gm;_=f.exec(u);)for(var g=_.index,h=g+_[0].length,$=g;$<h;++$)u=u.substring(0,$)+"*"+u.substring($+1);for(f=/^%.*$/gm;_=f.exec(u);)for(var g=_.index,h=g+_[0].length,$=g;$<h;++$)u=u.substring(0,$)+"*"+u.substring($+1);r("sanitized input:"+(u=u.replaceAll("!","*")));for(var x=/([=^_]?[a-gA-G][',]?|\|)/g,p=[];_=x.exec(u);){var v=_[1];if("|"==v)n.accidentalFlats="",n.accidentalSharps="",n.accidentalNaturals="";else{var m=o(v);r("UnNormalized="+v+" normalized="+m);var G=i(m,t);p.push(new s(_.index,v,m,G))}}return p}(e,t);return a=function e(a,n){for(var r,t=a,s=0,c=0;c<n.length;++c){var l=n[c].index+s,i=(r='"_'+n[c].glyph+'"').length;t=t.substr(0,l)+r+t.substr(l),s+=i}return t}(e,_)}var s=function(e,a,n,r){this.index=e,this.unNormalizedValue=a,this.normalizedValue=n,this.glyph=r};function c(e,a){var n="FCGDAEB",t={sharps:"",flats:""},s=n.indexOf(e[0])-1;if(-2==s)return r("Bad tonic: "+e),null;"b"==e.slice(1)?s-=7:"#"==e.slice(1)&&(s+=7);var c=s-a;return c>7?(r("Too many sharps: "+c),null):c<-7?(r("Too many flats: "+-1*c),null):(c>0?t.sharps=n.slice(0,c):c<0&&(t.flats=n.slice(c)),t.accidentalSharps="",t.accidentalFlats="",t.accidentalNaturals="",t)}function l(e,a,n){for(var r="",t=0;t<n;++t)r+="*";return e.substr(0,a)+r+e.substr(a+n)}function i(e,a){switch(a){case 0:var n={"D,":" ; ;0","E,":" ; ;1","^F,":" ; ;2","_G,":" ; ;2","G,":" ; ;3","^G,":" ;6+; ","_A,":" ;6+; ","A,":" ; ;4","B,":" ; ;5",C:" ; ;6","^C":" ; ;6+",_D:" ; ;6+",D:" ; ;0",E:" ; ;1","^F":" ; ;2",_G:" ; ;2",G:" ; ;3","^G":" ;6+; ",_A:" ;6+; ",A:" ; ;4",B:" ; ;5",c:" ; ;6","^c":" ; ;6+",_d:" ; ;6+",d:" ; ;7",e:" ; ;8","^f":" ; ;9",_g:" ; ;9",g:" ; ;10","^g":" ;6+; ",_a:" ;6+; ",a:" ; ;11",b:" ; ;12","c'":" ; ;6","^c'":" ; ;6+","_d'":" ; ;6+","d'":" ; ;7","e'":" ; ;8","^f'":" ; ;9","_g'":" ; ;9","g'":" ; ;10"}[e];if(!n)return"x;x;x";return gMDulcimerUseDashForOpenString&&(n=n.replaceAll(" ","-")),n;case 1:var n={"D,":"0; ; ","E,":"1; ; ","^F,":"2; ; ","_G,":"2; ; ","G,":"3; ; ","^G,":" ;6+; ","_A,":" ;6+; ","A,":" ;0; ","B,":" ;1; ",C:"6; ; ","^C":" ;2; ",_D:" ;2; ",D:"0; ; ",E:"1; ; ","^F":"2; ; ",_G:"2; ; ",G:"3; ; ","^G":" ;6+; ",_A:" ;6+; ",A:" ;0; ",B:" ;1; ",c:"6; ; ","^c":" ;2; ",_d:" ;2; ",d:" ; ;0",e:" ; ;1","^f":" ; ;2",_g:" ; ;2",g:" ; ;3","^g":" ;6+; ",_a:" ;6+; ",a:" ; ;4",b:" ; ;5","c'":" ; ;6","^c'":" ; ;6+","_d'":" ; ;6+","d'":" ; ;7","e'":" ; ;8","^f'":" ; ;9","_g'":" ; ;9","g'":" ; ;10"}[e];if(!n)return"x;x;x";return gMDulcimerUseDashForOpenString&&(n=n.replaceAll(" ","-")),n;case 2:var n={"D,":" ; ;0","E,":" ; ;1","F,":" ;6; ","^F,":" ; ;2","_G,":" ; ;2","G,":" ; ;3","A,":" ; ;4","B,":" ; ;5",C:" ;3; ","^C":" ; ;6+",_D:" ; ;6+",D:" ; ;0",E:" ; ;1",F:" ;6; ","^F":" ; ;2",_G:" ; ;2",G:" ; ;3",A:" ; ;4",B:" ; ;5",c:" ; ;6","^c":" ; ;6+",_d:" ; ;6+",d:" ; ;7",e:" ; ;8",f:" ;6; ","^f":" ; ;9",_g:" ; ;9",g:" ; ;10",a:" ; ;11",b:" ; ;12","c'":" ; ;6","^c'":" ; ;6+","_d'":" ; ;6+","d'":" ; ;7","e'":" ; ;8","f'":" ;6; ","^f'":" ; ;9","_g'":" ; ;9","g'":" ; ;10"}[e];if(!n)return"x;x;x";return gMDulcimerUseDashForOpenString&&(n=n.replaceAll(" ","-")),n;case 3:var n={"D,":"0; ; ","E,":"1; ; ","F,":" ;6; ","^F,":"2; ; ","_G,":"2; ; ","G,":" ;0; ","A,":" ;1; ","B,":" ;2; ",C:" ;3; ","^C":"6+; ; ",_D:"6+; ; ",D:"0; ; ",E:"1; ; ",F:" ;6; ","^F":"2; ; ",_G:"2; ; ",G:" ;0; ",A:" ;1; ",B:" ;2; ",c:" ;3; ","^c":"6+; ; ",_d:"6+; ; ",d:" ; ;0",e:" ; ;1",f:" ;6; ","^f":" ; ;2",_g:" ; ;2",g:" ; ;3",a:" ; ;4",b:" ; ;5","c'":" ; ;6","^c'":" ; ;6+","_d'":" ; ;6+","d'":" ; ;7","e'":" ; ;8","f'":" ;6; ","^f'":" ; ;9","_g'":" ; ;9","g'":" ; ;10"}[e];if(!n)return"x;x;x";return gMDulcimerUseDashForOpenString&&(n=n.replaceAll(" ","-")),n;case 4:var n={"G,":"3; ; ","^G,":" ; ;6+","_A,":" ; ;6+","A,":" ; ;0","B,":" ; ;1",C:"6; ; ","^C":" ; ;2",_D:" ; ;2",D:"0; ; ",E:"1; ; ","^F":"2; ; ",_G:"2; ; ",G:"3 ; ;","^G":" ; ;6+",_A:" ; ;6+",A:" ; ;0",B:" ; ;1",c:"6; ; ","^c":" ; ;2",_d:" ; ;2",d:" ; ;3",e:" ; ;4","^f":" ; ;5",_g:" ; ;5",g:" ; ;6","^g":" ; ;6+",_a:" ; ;6+",a:" ; ;7",b:" ; ;8","c'":"6; ; ","^c'":" ; ;9","_d'":" ; ;9","d'":" ; ;10","e'":" ; ;11","^f'":" ; ;12","_g'":" ; ;12"}[e];if(!n)return"x;x;x";return gMDulcimerUseDashForOpenString&&(n=n.replaceAll(" ","-")),n;case 5:var n=" ; ; ";return gMDulcimerUseDashForOpenString&&(n="-;-;-"),n}}function o(e){var a=e.search(/[A-G]/i);if(-1==a)return r("Failed to find basename for value!"),e;var t=e.substr(a,1).toUpperCase();return"="==e.substr(0,1)?(n.accidentalFlats=n.accidentalFlats.replace(t,""),n.accidentalSharps=n.accidentalSharps.replace(t,""),n.accidentalNaturals+=t,e.substr(1)):"_"==e.substr(0,1)?(n.accidentalFlats+=t,n.accidentalSharps=n.accidentalSharps.replace(t,""),n.accidentalNaturals=n.accidentalNaturals.replace(t,""),e):"^"==e.substr(0,1)?(n.accidentalFlats=n.accidentalFlats.replace(t,""),n.accidentalNaturals=n.accidentalNaturals.replace(t,""),n.accidentalSharps+=t,e):-1!=n.accidentalNaturals.search(t)?e:-1!=n.sharps.search(t)||-1!=n.accidentalSharps.search(t)?"^"+e:-1!=n.flats.search(t)||-1!=n.accidentalFlats.search(t)?"_"+e:e}function _(e){return e.split(/^X:.*$/gm).length-1}function u(e,a){for(var n,r=e,t=function e(a){let n=a.replace(/^(X:|T:|M:|K:|L:|Q:|W:|Z:|R:|C:|A:|O:|P:|N:|G:|H:|B:|D:|F:|S:|I:|:[A-Za-z]:)[^\r\n]*\r?\n?/gm,"");return n}(e=e.trim()),s=(t=t.trim()).split("\n"),c=s.length,l=!1,i=0;i<c;++i)if(0!=(n=s[i]).indexOf("%")){l=!0;var o=t.indexOf(n);t=t.substring(o);break}if(!l)return r;var _=e.indexOf(n);return e=e.substring(0,_),e+=a,e+="\n"+t+"\n\n"}return function e(a){var n=a.split(/^X:.*$/gm).length-1,r=gInjectTab_FontFamily,s=gInjectTab_TabFontSize,c=gInjectTab_StaffSep;parseInt(gInjectTab_TabLocation);var l=gInjectTab_StripChords,i=FindPreTuneHeader(a);gExcludedFromMDSolution=[],clearGetTuneByIndexCache();for(var o=0;o<n;++o){var _=getTuneByIndex(o);if(isSectionHeader(_)||isMultiVoiceTune(_)){i+="\n",i+=_,i+="\n\n";continue}if(_=StripOrnamentsOne(_),_=StripTabOne(_),l&&(_=StripChordsOne(_)),_=t(_),_=InjectStringBelowTuneHeaderConditional(_,"%%staffsep "+c),_=InjectStringAboveTuneHeaderConditional(_,"%%annotationfont "+r+" "+s),gMDulcimerStripBadTunes&&-1!=_.indexOf('"_x;x;x"')){var u=getTuneTitle(_);gExcludedFromMDSolution.push(u),_=""}i+=_=_.replaceAll("\n\n","\n"),i+="\n\n"}return normalizeBlankLines(i)}(e)},shapeNoteGenerator=function(e){var a="",n=null,r=null,t="Major";function s(e){}function c(e){if(s("Got input:"+e),null==(n=function e(a){t="Major";var n,c,l=null,o=a.match(/[kK]: *([A-G])([b#])? *(.*?)$/m);if(null==o||o.length<3)return null;if(n=void 0==o[2]?o[1]:o[1]+o[2],c=(c=(c=o[3].toLowerCase()).replace(/%.*/,"")).trim(),r=(r=n).replace("#","s"),gNonMoveableSolfege=!1,s("Got base key of '"+n+"' and extra of '"+c+"'"),""==c||-1!=c.search("maj")||-1!=c.search("ion")?(s("Mode: Ionian (major)"),t="Major",l=i(n,0)):-1!=c.search("mix")?(s("Mode: Mixolydian"),t="Major",l=i(n,1)):-1!=c.search("dor")?(s("Mode: Dorian"),t="Minor",l=i(n,2)):-1!=c.search("m")&&-1==c.search("mix")||-1!=c.search("min")||-1!=c.search("aeo")?(s("Mode: Aeolian (minor)"),t="Minor",l=i(n,3)):-1!=c.search("phr")?(s("Mode: Phrygian"),t="Major",l=i(n,4)):-1!=c.search("loc")?(s("Mode: Locrian"),t="Major",l=i(n,5)):-1!=c.search("lyd")?(s("Mode: Lydian"),t="Major",l=i(n,-1)):-1!=c.search("exp")?(s("(Accidentals to be explicitly specified)"),t="Major",l=i("C",0)):(s("Failed to determine key signature mode"),l=null),null==l)return l;var _=c.match(/_./g),u=c.match(/\^./g);for(note in _)l.flats+=_[note][1].toUpperCase();for(note in u)l.sharps+=u[note][1].toUpperCase();return l}(e)))return"ERROR: Unknown or unsupported key signature";var c=function e(a){for(var r,t,c=a,i=/^\w:.*$/mg;r=i.exec(a);)c=o(c,r.index,r[0].length);for(var _=/"[^"]*"/gm;t=_.exec(c);)for(var u=t.index,d=u+t[0].length,f=u;f<d;++f)c=c.substring(0,f)+"*"+c.substring(f+1);for(_=/\[[^\]|]*\]/g;t=_.exec(c);)for(var u=t.index,d=u+t[0].length,f=u;f<d;++f)c=c.substring(0,f)+"*"+c.substring(f+1);for(_=/![^!\n]*!/gm;t=_.exec(c);)for(var u=t.index,d=u+t[0].length,f=u;f<d;++f)c=c.substring(0,f)+"*"+c.substring(f+1);for(_=/^%%begintext((.|\n)*)%%endtext/gm;t=_.exec(c);)for(var u=t.index,d=u+t[0].length,f=u;f<d;++f)c=c.substring(0,f)+"*"+c.substring(f+1);for(_=/^%.*$/gm;t=_.exec(c);)for(var u=t.index,d=u+t[0].length,f=u;f<d;++f)c=c.substring(0,f)+"*"+c.substring(f+1);s("sanitized input:"+(c=c.replaceAll("!","*")));for(var g=/([=^_]?[a-gA-G][',]?|\|)/g,h=[];t=g.exec(c);){var $=t[1];if("|"==$)n.accidentalFlats="",n.accidentalSharps="",n.accidentalNaturals="";else{var v=p($);s("UnNormalized="+$+" normalized="+v);var m=x(v);h.push(new l(t.index,$,v,m))}}return h}(e);return a=function e(a,n){for(var r,t=a,s=0,c=0;c<n.length;++c){var l=n[c].index+s;r=n[c].glyph,n[c].normalizedValue;var i=r.length;t=t.substr(0,l)+r+t.substr(l),s+=i}return t}(e,c)}var l=function(e,a,n,r){this.index=e,this.unNormalizedValue=a,this.normalizedValue=n,this.glyph=r};function i(e,a){var n="FCGDAEB",r={sharps:"",flats:""},t=n.indexOf(e[0])-1;if(-2==t)return s("Bad tonic: "+e),null;"b"==e.slice(1)?t-=7:"#"==e.slice(1)&&(t+=7);var c=t-a;return c>7?(s("Too many sharps: "+c),null):c<-7?(s("Too many flats: "+-1*c),null):(c>0?r.sharps=n.slice(0,c):c<0&&(r.flats=n.slice(c)),r.accidentalSharps="",r.accidentalFlats="",r.accidentalNaturals="",r)}function o(e,a,n){for(var r="",t=0;t<n;++t)r+="*";return e.substr(0,a)+r+e.substr(a+n)}var _={c:0,"^c":1,d:2,"^d":3,e:4,f:5,"^f":6,g:7,"^g":8,a:9,"^a":10,b:11},u={c:0,_d:1,d:2,_e:3,e:4,f:5,_g:6,g:7,_a:8,a:9,_b:10,b:11},d={"^b":0,"=c":0,_d:1,"=d":2,_f:4,"=e":4,"^e":5,"=f":5,_g:6,"=g":7,_a:8,"=a":9,_b:10,"=b":11,_c:11},f={0:"c",1:"^c",2:"d",3:"^d",4:"e",5:"f",6:"^f",7:"g",8:"^g",9:"a",10:"^a",11:"b"},g={0:"c",1:"_d",2:"d",3:"_e",4:"e",5:"f",6:"_g",7:"g",8:"_a",9:"a",10:"_b",11:"b"},h={0:"c",1:"_d",2:"d",3:"_e",4:"e",5:"f",6:"_g",7:"g",8:"_a",9:"a",10:"_b",11:"b"},$={C:0,Cs:1,Db:1,D:2,Ds:3,Eb:3,E:4,F:5,Fs:6,Gb:6,G:7,Gs:8,Ab:8,A:9,As:10,Bb:10,B:11};function x(e){var a,s="";switch(e=function e(a,r,t){a=(a=(a=a.toLowerCase()).replaceAll(",","")).replaceAll("'","");var s=!0;""!=n.flats&&(s=!1),(6==gShapeNoteStyle||7==gShapeNoteStyle||8==gShapeNoteStyle)&&(r="C",t="Major");var c=$[r];if(s){var l=_[a],i=!1,o=!1;void 0===l&&(void 0!==(l=u[a])?i=!0:(l=d[a],o=!0)),6!=gShapeNoteStyle&&7!=gShapeNoteStyle&&8!=gShapeNoteStyle&&"Minor"==t&&(l-=3)<0&&(l+=12),(l-=c)<0&&(l+=12),l%=12,a=i?g[l]:o?h[l]:f[l]}else{var l=u[a],i=!1,o=!1;void 0===l&&(void 0!==(l=_[a])?i=!0:(l=d[a],o=!0)),6!=gShapeNoteStyle&&7!=gShapeNoteStyle&&8!=gShapeNoteStyle&&"Minor"==t&&(l-=3)<0&&(l+=12),(l-=c)<0&&(l+=12),l%=12,a=i?f[l]:o?h[l]:g[l]}return a}(e,r,t),gShapeNoteStyle){case 0:a={"^b":"!style=sn_fa!",c:"!style=sn_fa!","^c":"!style=sn_fa!",_d:"!style=sn_so!",d:"!style=sn_so!","^d":"!style=sn_so!",_e:"!style=sn_la!",e:"!style=sn_la!",_f:"!style=sn_la!","^e":"!style=sn_fa!",f:"!style=sn_fa!","^f":"!style=sn_fa!",_g:"!style=sn_so!",g:"!style=sn_so!","^g":"!style=sn_so!",_a:"!style=sn_la!",a:"!style=sn_la!","^a":"!style=sn_la!",_b:"!style=sn_mi!",b:"!style=sn_mi!",_c:"!style=sn_mi!"};break;case 1:a={"^b":'"_fa"!style=sn_fa!',c:'"_fa"!style=sn_fa!',"^c":'"_fa"!style=sn_fa!',_d:'"_sol"!style=sn_so!',d:'"_sol"!style=sn_so!',"^d":'"_sol"!style=sn_so!',_e:'"_la"!style=sn_la!',e:'"_la"!style=sn_la!',_f:'"_la"!style=sn_la!',"^e":'"_fa"!style=sn_fa!',f:'"_fa"!style=sn_fa!',"^f":'"_fa"!style=sn_fa!',_g:'"_sol"!style=sn_so!',g:'"_sol"!style=sn_so!',"^g":'"_sol"!style=sn_so!',_a:'"_la"!style=sn_la!',a:'"_la"!style=sn_la!',"^a":'"_la"!style=sn_la!',_b:'"_mi"!style=sn_mi!',b:'"_mi"!style=sn_mi!',_c:'"_mi"!style=sn_mi!'};break;case 2:a={"^b":'"_fa"',c:'"_fa"',"^c":'"_fa"',_d:'"_sol"',d:'"_sol"',"^d":'"_sol"',_e:'"_la"',e:'"_la"',_f:'"_la"',"^e":'"_fa"',f:'"_fa"',"^f":'"_fa"',_g:'"_sol"',g:'"_sol"',"^g":'"_sol"',_a:'"_la"',a:'"_la"',"^a":'"_la"',_b:'"_mi"',b:'"_mi"',_c:'"_mi"'};break;case 3:a={"^b":"!style=sn_do!",c:"!style=sn_do!","^c":"!style=sn_do!",_d:"!style=sn_re!",d:"!style=sn_re!","^d":"!style=sn_re!",_e:"!style=sn_mi!",e:"!style=sn_mi!",_f:"!style=sn_mi!","^e":"!style=sn_fa!",f:"!style=sn_fa!","^f":"!style=sn_fa!",_g:"!style=sn_so!",g:"!style=sn_so!","^g":"!style=sn_so!",_a:"!style=sn_la!",a:"!style=sn_la!","^a":"!style=sn_la!",_b:"!style=sn_ti!",b:"!style=sn_ti!",_c:"!style=sn_ti!"};break;case 4:a={"^b":'"_do"!style=sn_do!',c:'"_do"!style=sn_do!',"^c":'"_do"!style=sn_do!',_d:'"_re"!style=sn_re!',d:'"_re"!style=sn_re!',"^d":'"_re"!style=sn_re!',_e:'"_mi"!style=sn_mi!',e:'"_mi"!style=sn_mi!',_f:'"_mi"!style=sn_mi!',"^e":'"_fa"!style=sn_fa!',f:'"_fa"!style=sn_fa!',"^f":'"_fa"!style=sn_fa!',_g:'"_sol"!style=sn_so!',g:'"_sol"!style=sn_so!',"^g":'"_sol"!style=sn_so!',_a:'"_la"!style=sn_la!',a:'"_la"!style=sn_la!',"^a":'"_la"!style=sn_la!',_b:'"_ti"!style=sn_ti!',b:'"_ti"!style=sn_ti!',_c:'"_ti"!style=sn_ti!'};break;case 5:a={"^b":'"_do"',c:'"_do"',"^c":'"_do"',_d:'"_re"',d:'"_re"',"^d":'"_re"',_e:'"_mi"',e:'"_mi"',_f:'"_mi"',"^e":'"_fa"',f:'"_fa"',"^f":'"_fa"',_g:'"_sol"',g:'"_sol"',"^g":'"_sol"',_a:'"_la"',a:'"_la"',"^a":'"_la"',_b:'"_ti"',b:'"_ti"',_c:'"_ti"'};break;case 6:var a={"^b":'"_C"',c:'"_C"',"^c":'"_C#"',_d:'"_D♭"',d:'"_D"',"^d":'"_D#"',_e:'"_E♭"',e:'"_E"',_f:'"_E"',"^e":'"_F"',f:'"_F"',"^f":'"_F#"',_g:'"_G♭"',g:'"_G"',"^g":'"_G#"',_a:'"_A♭"',a:'"_A"',"^a":'"_A#"',_b:'"_B♭"',b:'"_B"',_c:'"_B"'};break;case 7:var a={"^b":'"_do"',c:'"_do"',"^c":'"_do"',_d:'"_re"',d:'"_re"',"^d":'"_re"',_e:'"_mi"',e:'"_mi"',_f:'"_mi"',"^e":'"_fa"',f:'"_fa"',"^f":'"_fa"',_g:'"_sol"',g:'"_sol"',"^g":'"_sol"',_a:'"_la"',a:'"_la"',"^a":'"_la"',_b:'"_ti"',b:'"_ti"',_c:'"_ti"'};break;case 8:case 9:case 10:var a={"^b":'"_do"',c:'"_do"',"^c":'"_di"',_d:'"_ra"',d:'"_re"',"^d":'"_ri"',_e:'"_me"',e:'"_mi"',_f:'"_mi"',"^e":'"_fa"',f:'"_fa"',"^f":'"_fi"',_g:'"_se"',g:'"_sol"',"^g":'"_si"',_a:'"_le"',a:'"_la"',"^a":'"_li"',_b:'"_te"',b:'"_ti"',_c:'"_ti"'}}return(s=a[e])?s:"x "}function p(e){var a=e.search(/[A-G]/i);if(-1==a)return s("Failed to find basename for value!"),e;var r=e.substr(a,1).toUpperCase();return"="==e.substr(0,1)?(n.accidentalFlats=n.accidentalFlats.replace(r,""),n.accidentalSharps=n.accidentalSharps.replace(r,""),n.accidentalNaturals+=r,e.substr(1)):"_"==e.substr(0,1)?(n.accidentalFlats+=r,n.accidentalSharps=n.accidentalSharps.replace(r,""),n.accidentalNaturals=n.accidentalNaturals.replace(r,""),e):"^"==e.substr(0,1)?(n.accidentalFlats=n.accidentalFlats.replace(r,""),n.accidentalNaturals=n.accidentalNaturals.replace(r,""),n.accidentalSharps+=r,e):-1!=n.accidentalNaturals.search(r)?e:-1!=n.sharps.search(r)||-1!=n.accidentalSharps.search(r)?"^"+e:-1!=n.flats.search(r)||-1!=n.accidentalFlats.search(r)?"_"+e:e}return function e(a){var s,l=gInjectTab_FontFamily,i=gInjectTab_TabFontSize,o=gInjectTab_StaffSep;n=null,r=null,t="Major";var _=(s=a).split(/^X:.*$/gm).length-1,u=FindPreTuneHeader(a);clearGetTuneByIndexCache();for(var d=0;d<_;++d){var f=getTuneByIndex(d);if(isSectionHeader(f)){u+="\n",u+=f,u+="\n\n";continue}switch(f=c(f),f=InjectStringBelowTuneHeaderConditional(f,"%%staffsep "+o),gShapeNoteStyle){case 1:case 2:case 4:case 5:case 6:case 7:case 8:case 9:case 10:f=InjectStringAboveTuneHeaderConditional(f,"%%annotationfont "+l+" "+i)}u+=f,u+="\n\n"}return normalizeBlankLines(u)}(e)},injectABCNoteNames=function(e){var a=null;function n(e){}function r(e){if(n("Got input:"+e),null==(a=function e(a){var r,t,c=null,l=a.match(/^K: *([A-G])([b#])? *(.*?)$/m);if(null==l||l.length<3)return null;if(r=void 0==l[2]?l[1]:l[1]+l[2],n("Got base key of '"+r+"' and extra of '"+(t=(t=(t=l[3].toLowerCase()).replace(/%.*/,"")).trim())+"'"),""==t||-1!=t.search("maj")||-1!=t.search("ion")?(n("Mode: Ionian (major)"),c=s(r,0)):-1!=t.search("mix")?(n("Mode: Mixolydian"),c=s(r,1)):-1!=t.search("dor")?(n("Mode: Dorian"),c=s(r,2)):-1!=t.search("m")&&-1==t.search("mix")||-1!=t.search("min")||-1!=t.search("aeo")?(n("Mode: Aeolian (minor)"),c=s(r,3)):-1!=t.search("phr")?(n("Mode: Phrygian"),c=s(r,4)):-1!=t.search("loc")?(n("Mode: Locrian"),c=s(r,5)):-1!=t.search("lyd")?(n("Mode: Lydian"),c=s(r,-1)):-1!=t.search("exp")?(n("(Accidentals to be explicitly specified)"),c=s("C",0)):(n("Failed to determine key signature mode"),c=null),null==c)return c;var i=t.match(/_./g),o=t.match(/\^./g);for(note in i)c.flats+=i[note][1].toUpperCase();for(note in o)c.sharps+=o[note][1].toUpperCase();return c}(e)))return"ERROR: Unknown or unsupported key signature";var r=function e(r){for(var s,o,_=r,u=/^\w:.*$/mg;s=u.exec(r);)_=c(_,s.index,s[0].length);for(var d=/"[^"]*"/gm;o=d.exec(_);)for(var f=o.index,g=f+o[0].length,h=f;h<g;++h)_=_.substring(0,h)+"*"+_.substring(h+1);for(d=/\[[^\]|]*\]/g;o=d.exec(_);)for(var f=o.index,g=f+o[0].length,h=f;h<g;++h)_=_.substring(0,h)+"*"+_.substring(h+1);for(d=/![^!\n]*!/gm;o=d.exec(_);)for(var f=o.index,g=f+o[0].length,h=f;h<g;++h)_=_.substring(0,h)+"*"+_.substring(h+1);for(d=/^%%begintext((.|\n)*)%%endtext/gm;o=d.exec(_);)for(var f=o.index,g=f+o[0].length,h=f;h<g;++h)_=_.substring(0,h)+"*"+_.substring(h+1);for(d=/^%.*$/gm;o=d.exec(_);)for(var f=o.index,g=f+o[0].length,h=f;h<g;++h)_=_.substring(0,h)+"*"+_.substring(h+1);n("sanitized input:"+(_=_.replaceAll("!","*")));for(var $=/([=^_]?[a-gA-G][',]?|\|)/g,x=[];o=$.exec(_);){var p=o[1];if("|"==p)a.accidentalFlats="",a.accidentalSharps="",a.accidentalNaturals="";else{var v=i(p);n("UnNormalized="+p+" normalized="+v);var m=l(v);x.push(new t(o.index,p,v,m))}}return x}(e);return function e(a,n){for(var r,t=a,s=0,c=0;c<n.length;++c){var l=n[c].index+s,i=n[c].glyph;i.length;var o=(r='"_'+i+'"').length;t=t.substr(0,l)+r+t.substr(l),s+=o}return t}(e,r)}var t=function(e,a,n,r){this.index=e,this.unNormalizedValue=a,this.normalizedValue=n,this.glyph=r};function s(e,a){var r="FCGDAEB",t={sharps:"",flats:""},s=r.indexOf(e[0])-1;if(-2==s)return n("Bad tonic: "+e),null;"b"==e.slice(1)?s-=7:"#"==e.slice(1)&&(s+=7);var c=s-a;return c>7?(n("Too many sharps: "+c),null):c<-7?(n("Too many flats: "+-1*c),null):(c>0?t.sharps=r.slice(0,c):c<0&&(t.flats=r.slice(c)),t.accidentalSharps="",t.accidentalFlats="",t.accidentalNaturals="",t)}function c(e,a,n){for(var r="",t=0;t<n;++t)r+="*";return e.substr(0,a)+r+e.substr(a+n)}function l(e){if(11==gShapeNoteStyle){var a={"D,":"D,","^D,":"D#,","_E,":"E♭,","E,":"E,","^E,":"E#,","_F,":"F♭,","F,":"F,","^F,":"F#,","_G,":"G♭,","G,":"G,","^G,":"G#,","_A,":"A♭,","A,":"A,","^A,":"A#,","_B,":"B♭,","B,":"B,","^B,":"B#,",_C:"C♭",C:"C","^C":"C#",_D:"D♭",D:"D","^D":"D#",_E:"E♭",E:"E","^E":"E#",_F:"F♭",F:"F","^F":"F#",_G:"G♭",G:"G","^G":"G#",_A:"A♭",A:"A","^A":"A#",_B:"B♭",B:"B","^B":"B#",_c:"c♭",c:"c","^c":"c#",_d:"d♭",d:"d","^d":"d#",_e:"e♭",e:"e","^e":"e#",_f:"f♭",f:"f","^f":"f#",_g:"g♭",g:"g","^g":"g#",_a:"a♭",a:"a","^a":"a#",_b:"b♭",b:"b","^b":"b#","_c'":"c♭'","c'":"c'","^c'":"c#'","_d'":"d♭'","d'":"d'","^d'":"d#'","_e'":"e♭'","e'":"e'","^e'":"e#'","_F'":"F♭'","f'":"f'","^f'":"f#'","_g'":"g♭'","g'":"g'","=D,":"D,","=E,":"E,","=F,":"F,","=G,":"G,","=A,":"A,","=B,":"B,","=C":"C,","=D":"D","=E":"E","=F":"F","=G":"G","=A":"A","=B":"B","=c":"c","=d":"d","=e":"e","=f":"f","=g":"g","=a":"a","=b":"b","=c'":"c'","=d'":"d'","=e'":"e'","=f'":"f'","=g'":"g'","C'":"c","^C'":"c#","_D'":"d♭","D'":"d","^D'":"d#","_E'":"e♭","E'":"e","F'":"f","^F'":"f#","_G'":"g♭","G'":"g","^G'":"g#","_A'":"a♭","A'":"a","^A'":"a#","_B'":"b♭","B'":"b","C''":"c'","^C''":"c#'","_D''":"d♭'","D''":"d'","^D''":"d#'","_E''":"e♭'","E''":"e'","F''":"f'","^F''":"f#'","_G''":"g♭'","G''":"g'","=C'":"c","=D'":"d","=E'":"e","=F'":"f","=G'":"g","=A'":"a","=B'":"b","=C''":"c'","=D''":"d'","=E''":"e'","=F''":"f'","=G''":"g'"},n=a[e];return n||(n="x "),n}var a={"D,":"D,","^D,":"D#,","_E,":"E♭,","E,":"E,","^E,":"E#,","_F,":"F♭,","F,":"F,","^F,":"F#,","_G,":"G♭,","G,":"G,","^G,":"G#,","_A,":"A♭,","A,":"A,","^A,":"A#,","_B,":"B♭,","B,":"B,","^B,":"B#,",_C:"C♭,",C:"C,","^C":"C,#",_D:"D♭",D:"D","^D":"D#",_E:"E♭",E:"E","^E":"E#",_F:"F♭",F:"F","^F":"F#",_G:"G♭",G:"G","^G":"G#",_A:"A♭",A:"A","^A":"A#",_B:"B♭",B:"B","^B":"B#",_c:"C♭",c:"C","^c":"C#",_d:"D♭'",d:"D'","^d":"D#'",_e:"E♭'",e:"E'","^e":"E#'",_f:"F♭'",f:"F'","^f":"F#'",_g:"G♭'",g:"G'","^g":"G#'",_a:"A♭'",a:"A'","^a":"A#'",_b:"B♭'",b:"B'","^b":"B#'","_c'":"C♭'","c'":"C'","^c'":"C#'","_d'":"D♭''","d'":"D''","^d'":"D#''","_e'":"E♭''","e'":"E''","^e'":"E#''","_f'":"F♭''","f'":"F''","^f'":"F#''","_g'":"G♭''","g'":"G''","=D,":"D,","=E,":"E,","=F,":"F,","=G,":"G,","=A,":"A,","=B,":"B,","=C":"C,","=D":"D","=E":"E","=F":"F","=G":"G","=A":"A","=B":"B","=c":"C","=d":"D'","=e":"E'","=f":"F'","=g":"G'","=a":"A'","=b":"B'","=c'":"C'","=d'":"D''","=e'":"E''","=f'":"F''","=g'":"G''","C'":"C","^C'":"C#","_D'":"D♭'","D'":"D'","^D'":"D#'","_E'":"E♭'","E'":"E'","F'":"F'","^F'":"F#'","_G'":"G♭'","G'":"G'","^G'":"G#'","_A'":"A♭'","A'":"A'","^A'":"A#'","_B'":"B♭'","B'":"B'","C''":"C'","^C''":"C#'","_D''":"D♭''","D''":"D''","^D''":"D#''","_E''":"E♭''","E''":"E''","F''":"F''","^F''":"F#''","_G''":"G♭''","G''":"G''","=C'":"C","=D'":"D'","=E'":"E'","=F'":"F'","=G'":"G'","=A'":"A'","=B'":"B'","=C''":"C'","=D''":"D''","=E''":"E''","=F''":"F''","=G''":"G''"},n=a[e];return n||(n="x "),n}function i(e){var r=e.search(/[A-G]/i);if(-1==r)return n("Failed to find basename for value!"),e;var t=e.substr(r,1).toUpperCase();return"="==e.substr(0,1)?(a.accidentalFlats=a.accidentalFlats.replace(t,""),a.accidentalSharps=a.accidentalSharps.replace(t,""),a.accidentalNaturals+=t,e.substr(1)):"_"==e.substr(0,1)?(a.accidentalFlats+=t,a.accidentalSharps=a.accidentalSharps.replace(t,""),a.accidentalNaturals=a.accidentalNaturals.replace(t,""),e):"^"==e.substr(0,1)?(a.accidentalFlats=a.accidentalFlats.replace(t,""),a.accidentalNaturals=a.accidentalNaturals.replace(t,""),a.accidentalSharps+=t,e):-1!=a.accidentalNaturals.search(t)?e:-1!=a.sharps.search(t)||-1!=a.accidentalSharps.search(t)?"^"+e:-1!=a.flats.search(t)||-1!=a.accidentalFlats.search(t)?"_"+e:e}return function e(a){var n,t=gInjectTab_FontFamily,s=gInjectTab_TabFontSize,c=gInjectTab_StaffSep,l=(n=a).split(/^X:.*$/gm).length-1,i=FindPreTuneHeader(a);clearGetTuneByIndexCache();for(var o=0;o<l;++o){var _=getTuneByIndex(o);if(isSectionHeader(_)){i+="\n",i+=_,i+="\n\n";continue}_=r(_),_=InjectStringBelowTuneHeaderConditional(_,"%%staffsep "+c),_=(_=InjectStringAboveTuneHeaderConditional(_,"%%annotationfont "+t+" "+s)).replaceAll("\n\n","\n"),i+=_,i+="\n\n"}return normalizeBlankLines(i)}(e)},HarmonicaTabGenerator=function(e){var a=null;function n(e){}function r(e,r,o,_){var u=[];switch(gHarmonicaTuning){case"0":default:u[0]="1",u[1]="-1'",u[2]="-1",u[3]="1o",u[4]="2",u[5]="-2''",u[6]="-2'",u[7]="3",u[8]="-3'''",u[9]="-3''",u[10]="-3'",u[11]="-3",u[12]="4",u[13]="-4'",u[14]="-4",u[15]="4o",u[16]="5",u[17]="-5",u[18]="5o",u[19]="6",u[20]="-6'",u[21]="-6",u[22]="6o",u[23]="-7",u[24]="7",u[25]="-7o",u[26]="-8",u[27]="8'",u[28]="8",u[29]="-9",u[30]="9'",u[31]="9",u[32]="-9o",u[33]="-10",u[34]="10''",u[35]="10'",u[36]="10",u[37]="-10o'",u[38]="x",u[39]="x",u[40]="x",u[41]="x",u[42]="x",u[43]="x",u[44]="x",u[45]="x",u[46]="x",u[47]="x",u[48]="x",u[49]="x",u[50]="x",u[51]="x",u[52]="x",u[53]="x",u[54]="x",u[55]="x",u[56]="x",u[57]="x",u[58]="x",u[59]="x";break;case"1":u[0]="1",u[1]="-1'",u[2]="-1",u[3]="1o",u[4]="2",u[5]="-2''",u[6]="-2'",u[7]="-2",u[8]="-3'''",u[9]="3",u[10]="-3'",u[11]="-3",u[12]="4",u[13]="-4'",u[14]="-4",u[15]="4o",u[16]="5",u[17]="-5",u[18]="5o",u[19]="6",u[20]="-6'",u[21]="-6",u[22]="6o",u[23]="-7",u[24]="7",u[25]="-7o",u[26]="-8",u[27]="8'",u[28]="8",u[29]="-9",u[30]="9'",u[31]="9",u[32]="-9o",u[33]="-10",u[34]="10''",u[35]="10'",u[36]="10",u[37]="-10o'",u[38]="x",u[39]="x",u[40]="x",u[41]="x",u[42]="x",u[43]="x",u[44]="x",u[45]="x",u[46]="x",u[47]="x",u[48]="x",u[49]="x",u[50]="x",u[51]="x",u[52]="x",u[53]="x",u[54]="x",u[55]="x",u[56]="x",u[57]="x",u[58]="x",u[59]="x";break;case"2":u[0]="1",u[1]="-1'",u[2]="-1",u[3]="1o",u[4]="2",u[5]="-2",u[6]="2o",u[7]="3",u[8]="-3'",u[9]="-3",u[10]="3o",u[11]="x",u[12]="4",u[13]="-4'",u[14]="-4",u[15]="4o",u[16]="5",u[17]="-5",u[18]="5o",u[19]="6",u[20]="-6'",u[21]="-6",u[22]="6o",u[23]="-7",u[24]="7",u[25]="-7o",u[26]="-8",u[27]="8'",u[28]="8",u[29]="-9",u[30]="9'",u[31]="9",u[32]="-9o",u[33]="-10",u[34]="10''",u[35]="10'",u[36]="10",u[37]="-10o'",u[38]="x",u[39]="x",u[40]="x",u[41]="x",u[42]="x",u[43]="x",u[44]="x",u[45]="x",u[46]="x",u[47]="x",u[48]="x",u[49]="x",u[50]="x",u[51]="x",u[52]="x",u[53]="x",u[54]="x",u[55]="x",u[56]="x",u[57]="x",u[58]="x",u[59]="x";break;case"3":u[0]="1",u[1]="-1'",u[2]="-1",u[3]="1o",u[4]="2",u[5]="-2''",u[6]="-2'",u[7]="-2",u[8]="2o",u[9]="3",u[10]="-3'",u[11]="-3",u[12]="4",u[13]="-4'",u[14]="-4",u[15]="4o",u[16]="5",u[17]="-5'",u[18]="-5",u[19]="6",u[20]="-6'",u[21]="-6",u[22]="6o",u[23]="-7",u[24]="7",u[25]="-7o",u[26]="-8",u[27]="8'",u[28]="8",u[29]="-8o",u[30]="-9",u[31]="9",u[32]="-9o",u[33]="-10",u[34]="10''",u[35]="10'",u[36]="10",u[37]="-10o'",u[38]="x",u[39]="x",u[40]="x",u[41]="x",u[42]="x",u[43]="x",u[44]="x",u[45]="x",u[46]="x",u[47]="x",u[48]="x",u[49]="x",u[50]="x",u[51]="x",u[52]="x",u[53]="x",u[54]="x",u[55]="x",u[56]="x",u[57]="x",u[58]="x",u[59]="x";break;case"4":u[0]="1",u[1]="-1'",u[2]="-1",u[3]="1o",u[4]="2",u[5]="-2''",u[6]="-2'",u[7]="-2",u[8]="-3'''",u[9]="-3''",u[10]="-3'",u[11]="-3",u[12]="4",u[13]="-4'",u[14]="-4",u[15]="4o",u[16]="5",u[17]="-5'",u[18]="-5",u[19]="6",u[20]="-6'",u[21]="-6",u[22]="6o",u[23]="-7",u[24]="7",u[25]="-7o",u[26]="-8",u[27]="8'",u[28]="8",u[29]="-9",u[30]="9'",u[31]="9",u[32]="-9o",u[33]="-10",u[34]="10''",u[35]="10'",u[36]="10",u[37]="-10o'",u[38]="x",u[39]="x",u[40]="x",u[41]="x",u[42]="x",u[43]="x",u[44]="x",u[45]="x",u[46]="x",u[47]="x",u[48]="x",u[49]="x",u[50]="x",u[51]="x",u[52]="x",u[53]="x",u[54]="x",u[55]="x",u[56]="x",u[57]="x",u[58]="x",u[59]="x";break;case"5":u[0]="1",u[1]="-1'",u[2]="-1",u[3]="2",u[4]="-2'''",u[5]="-2''",u[6]="-2'",u[7]="-2",u[8]="-3''",u[9]="-3'",u[10]="-3",u[11]="3o",u[12]="4",u[13]="-4'",u[14]="-4",u[15]="5",u[16]="-5'",u[17]="-5",u[18]="5o",u[19]="6",u[20]="-6'",u[21]="-6",u[22]="-7",u[23]="7'",u[24]="7",u[25]="-7o",u[26]="-8",u[27]="8",u[28]="-8o",u[29]="-9",u[30]="9'",u[31]="9",u[32]="-9o",u[33]="-10",u[34]="10''",u[35]="10'",u[36]="10",u[37]="-10o'",u[38]="x",u[39]="x",u[40]="x",u[41]="x",u[42]="x",u[43]="x",u[44]="x",u[45]="x",u[46]="x",u[47]="x",u[48]="x",u[49]="x",u[50]="x",u[51]="x",u[52]="x",u[53]="x",u[54]="x",u[55]="x",u[56]="x",u[57]="x",u[58]="x",u[59]="x";break;case"6":u[0]="1",u[1]="1s",u[2]="-1",u[3]="-1s",u[4]="2",u[5]="-2",u[6]="-2s",u[7]="3",u[8]="3s",u[9]="-3",u[10]="-3s",u[11]="-4",u[12]="5",u[13]="5s",u[14]="-5",u[15]="-5s",u[16]="6",u[17]="-6",u[18]="-6s",u[19]="7",u[20]="7s",u[21]="-7",u[22]="-7s",u[23]="-8",u[24]="9",u[25]="9s",u[26]="-9",u[27]="-9s",u[28]="10",u[29]="-10",u[30]="-10s",u[31]="11",u[32]="11s",u[33]="-11",u[34]="-11s",u[35]="-12",u[36]="12",u[37]="12s",u[38]="-12s",u[39]="x",u[40]="x",u[41]="x",u[42]="x",u[43]="x",u[44]="x",u[45]="x",u[46]="x",u[47]="x",u[48]="x",u[49]="x",u[50]="x",u[51]="x",u[52]="x",u[53]="x",u[54]="x",u[55]="x",u[56]="x",u[57]="x",u[58]="x",u[59]="x";break;case"7":u[0]="1",u[1]="1s",u[2]="-1",u[3]="-1s",u[4]="2",u[5]="-2",u[6]="-2s",u[7]="3",u[8]="3s",u[9]="-3",u[10]="-3s",u[11]="-4",u[12]="5",u[13]="5s",u[14]="-5",u[15]="-5s",u[16]="6",u[17]="-6",u[18]="-6s",u[19]="7",u[20]="7s",u[21]="-7",u[22]="-7s",u[23]="-8",u[24]="9",u[25]="9s",u[26]="-9",u[27]="-9s",u[28]="10",u[29]="-10",u[30]="-10s",u[31]="11",u[32]="11s",u[33]="-11",u[34]="-11s",u[35]="-12",u[36]="13",u[37]="13s",u[38]="-13",u[39]="-13s",u[40]="14",u[41]="-14",u[42]="-14s",u[43]="15",u[44]="15s",u[45]="-15",u[46]="-15s",u[47]="-16",u[48]="16",u[49]="16s",u[50]="-16s",u[51]="x",u[52]="x",u[53]="x",u[54]="x",u[55]="x",u[56]="x",u[57]="x",u[58]="x",u[59]="x";break;case"8":u=gHarmonicaCustom.noteMap}if(n("Got input:"+e),null==(a=function e(a){var r,t,c=null,l=a.match(/^K: *([A-G])([b#])? *(.*?)$/m);if(null==l||l.length<3)return null;if(r=void 0==l[2]?l[1]:l[1]+l[2],n("Got base key of '"+r+"' and extra of '"+(t=(t=(t=l[3].toLowerCase()).replace(/%.*/,"")).trim())+"'"),""==t||-1!=t.search("maj")||-1!=t.search("ion")?(n("Mode: Ionian (major)"),c=s(r,0)):-1!=t.search("mix")?(n("Mode: Mixolydian"),c=s(r,1)):-1!=t.search("dor")?(n("Mode: Dorian"),c=s(r,2)):-1!=t.search("m")&&-1==t.search("mix")||-1!=t.search("min")||-1!=t.search("aeo")?(n("Mode: Aeolian (minor)"),c=s(r,3)):-1!=t.search("phr")?(n("Mode: Phrygian"),c=s(r,4)):-1!=t.search("loc")?(n("Mode: Locrian"),c=s(r,5)):-1!=t.search("lyd")?(n("Mode: Lydian"),c=s(r,-1)):-1!=t.search("exp")?(n("(Accidentals to be explicitly specified)"),c=s("C",0)):(n("Failed to determine key signature mode"),c=null),null==c)return c;var i=t.match(/_./g),o=t.match(/\^./g);for(note in i)c.flats+=i[note][1].toUpperCase();for(note in o)c.sharps+=o[note][1].toUpperCase();return c}(e)))return"ERROR: Unknown or unsupported key signature";var d=function e(r,s,o,_,u){for(var d,f,g=r,h=/^\w:.*$/mg;d=h.exec(r);)g=c(g,d.index,d[0].length);for(var $=/"[^"]*"/gm;f=$.exec(g);)for(var x=f.index,p=x+f[0].length,v=x;v<p;++v)g=g.substring(0,v)+"*"+g.substring(v+1);for($=/\[[^\]|]*\]/g;f=$.exec(g);)for(var x=f.index,p=x+f[0].length,v=x;v<p;++v)g=g.substring(0,v)+"*"+g.substring(v+1);for($=/![^!\n]*!/gm;f=$.exec(g);)for(var x=f.index,p=x+f[0].length,v=x;v<p;++v)g=g.substring(0,v)+"*"+g.substring(v+1);for($=/^%%begintext((.|\n)*)%%endtext/gm;f=$.exec(g);)for(var x=f.index,p=x+f[0].length,v=x;v<p;++v)g=g.substring(0,v)+"*"+g.substring(v+1);for($=/^%.*$/gm;f=$.exec(g);)for(var x=f.index,p=x+f[0].length,v=x;v<p;++v)g=g.substring(0,v)+"*"+g.substring(v+1);n("sanitized input:"+(g=g.replaceAll("!","*")));for(var m=/([=^_]?[a-gA-G][',']*['']*|\|)/g,G=[];f=m.exec(g);){var A=f[1];if("|"==A)a.accidentalFlats="",a.accidentalSharps="",a.accidentalNaturals="";else{var F=i(A);n("UnNormalized="+A+" normalized="+F);var D=l(F,s,o,_,u);G.push(new t(f.index,A,F,D))}}return G}(e,r,o,_,u);return function e(a,n){for(var r,t=a,s=0,c=parseInt(gInjectTab_TabLocation),l=0;l<n.length;++l){var i=n[l].index+s,o=n[l].glyph;switch(c){case 0:r='"^'+o+'"';break;case 1:r='"_'+o+'"'}var _=r.length;t=t.substr(0,i)+r+t.substr(i),s+=_}return t}(e,d)}var t=function(e,a,n,r){this.index=e,this.unNormalizedValue=a,this.normalizedValue=n,this.glyph=r};function s(e,a){var r="FCGDAEB",t={sharps:"",flats:""},s=r.indexOf(e[0])-1;if(-2==s)return n("Bad tonic: "+e),null;"b"==e.slice(1)?s-=7:"#"==e.slice(1)&&(s+=7);var c=s-a;return c>7?(n("Too many sharps: "+c),null):c<-7?(n("Too many flats: "+-1*c),null):(c>0?t.sharps=r.slice(0,c):c<0&&(t.flats=r.slice(c)),t.accidentalSharps="",t.accidentalFlats="",t.accidentalNaturals="",t)}function c(e,a,n){for(var r="",t=0;t<n;++t)r+="*";return e.substr(0,a)+r+e.substr(a+n)}function l(e,a,n,r,t){var s={"C,":0,"^C,":1,"_D,":1,"D,":2,"^D,":3,"_E,":3,"E,":4,"^E,":5,"_F,":4,"F,":5,"^F,":6,"_G,":6,"G,":7,"^G,":8,"_A,":8,"A,":9,"^A,":10,"_B,":10,"B,":11,"^B,":12,_C:11,C:12,"^C":13,_D:13,D:14,"^D":15,_E:15,E:16,"^E":17,_F:16,F:17,"^F":18,_G:18,G:19,"^G":20,_A:20,A:21,"^A":22,_B:22,B:23,"^B":24,_c:23,c:24,"^c":25,_d:25,d:26,"^d":27,_e:27,e:28,"^e":29,_f:28,f:29,"^f":30,_g:30,g:31,"^g":32,_a:32,a:33,"^a":34,_b:34,b:35,"^b":36,"_c'":35,"c'":36,"^c'":37,"_d'":37,"d'":38,"^d'":39,"_e'":39,"e'":40,"^e'":41,"_f'":40,"f'":41,"^f'":42,"_g'":42,"g'":43,"^g'":44,"_a'":44,"a'":45,"^a'":46,"_b'":46,"b'":47,"^b'":48,"_c''":47,"c''":48,"^c''":49,"_d''":49,"d''":50,"^d''":51,"_e''":51,"e''":52,"^e''":53,"_f''":52,"f''":53,"^f''":54,"_g''":54,"g''":55,"^g''":56,"_a''":56,"a''":57,"^a''":58,"_b''":58,"b''":59,"=C,":0,"=D,":2,"=E,":4,"=F,":5,"=G,":7,"=A,":9,"=B,":11,"=C":12,"=D":14,"=E":16,"=F":17,"=G":19,"=A":21,"=B":23,"=c":24,"=d":26,"=e":28,"=f":29,"=g":31,"=a":33,"=b":35,"=c'":36,"=d'":38,"=e'":40,"=f'":41,"=g'":43,"=a'":45,"=b'":47,"=c''":48,"=d''":50,"=e''":52,"=f''":53,"=g''":55,"=a''":57,"=b''":59,"C'":24,"^C'":25,"_D'":25,"D'":26,"^D'":27,"_E'":27,"E'":28,"F'":29,"^F'":30,"_G'":30,"G'":31,"^G'":32,"_A'":32,"A'":33,"^A'":34,"_B'":34,"B'":35,"C''":36,"^C''":37,"_D''":37,"D''":38,"^D''":39,"_E''":39,"E''":40,"F''":41,"^F''":42,"_G''":42,"G''":43,"A''":45,"B''":47,"=C'":24,"=D'":26,"=E'":28,"=F'":29,"=G'":31,"=A'":33,"=B'":35,"=C''":36,"=D''":38,"=E''":40,"=F''":41,"=G''":43,"=A''":45,"=B''":47}[e],c=0;switch(a){case"G":c=5;break;case"G#":c=4;break;case"A":c=3;break;case"Bb":c=2;break;case"B":c=1;break;case"C":c=0;break;case"C#":c=-1;break;case"D":c=-2;break;case"Eb":c=-3;break;case"E":c=-4;break;case"F":c=-5;break;case"F#":c=-6}if(s+=c,"1"==n?s+=12:"-1"==n?s-=12:"2"==n?s+=24:"-2"==n?s-=24:"3"==n?s+=36:"-3"==n&&(s-=36),s<0||0!=s&&!s)return"x";var l=t[s];if("x"!=l){if(!l)return"x";gHarmonicaStacking||gHarmonicaTabColors?-1!=l.indexOf("-")?(l=l.replace("-",""),l+=";-"):r&&(l=l+=";+"):r&&-1==l.indexOf("-")&&(l="+"+l)}return l}function i(e){var r=e.search(/[A-G]/i);if(-1==r)return n("Failed to find basename for value!"),e;var t=e.substr(r,1).toUpperCase();return"="==e.substr(0,1)?(a.accidentalFlats=a.accidentalFlats.replace(t,""),a.accidentalSharps=a.accidentalSharps.replace(t,""),a.accidentalNaturals+=t,e.substr(1)):"_"==e.substr(0,1)?(a.accidentalFlats+=t,a.accidentalSharps=a.accidentalSharps.replace(t,""),a.accidentalNaturals=a.accidentalNaturals.replace(t,""),e):"^"==e.substr(0,1)?(a.accidentalFlats=a.accidentalFlats.replace(t,""),a.accidentalNaturals=a.accidentalNaturals.replace(t,""),a.accidentalSharps+=t,e):-1!=a.accidentalNaturals.search(t)?e:-1!=a.sharps.search(t)||-1!=a.accidentalSharps.search(t)?"^"+e:-1!=a.flats.search(t)||-1!=a.accidentalFlats.search(t)?"_"+e:e}function o(e){return e.split("\n").filter(e=>!/^%%vskip 15$|^%%annotationfont|^%%text\s\w{1,2}\sHarp/.test(e)).join("\n")}return function e(a){var n,t=gInjectTab_FontFamily,s=gInjectTab_TabFontSize,c=gInjectTab_StaffSep,l=parseInt(gInjectTab_TabLocation),i=gInjectTab_StripChords,_=gHarmonicaPlusSign;gHarmonicaTabColors&&(_=!0);var u=(n=a).split(/^X:.*$/gm).length-1,d=FindPreTuneHeader(a);clearGetTuneByIndexCache();for(var f=0;f<u;++f){var g=getTuneByIndex(f);if(isSectionHeader(g)||isMultiVoiceTune(g)){d+="\n",d+=g,d+="\n\n";continue}g=o(g),g=StripTabOne(g),(0==l||1==l&&i)&&(g=StripChordsOne(g)),g=r(g,gHarmonicaKey,gHarmonicaOctave,_),g=InjectStringBelowTuneHeaderConditional(g,"%%staffsep "+c),g=InjectStringAboveTuneHeaderConditional(g,"%%annotationfont "+t+" "+s);var h="%%text "+gHarmonicaKey+" Harp";switch(0==gHarmonicaOctave?h="%%text "+gHarmonicaKey+" Harp":"-1"==gHarmonicaOctave?h="%%text "+gHarmonicaKey+" Harp / -1 Octave":"1"==gHarmonicaOctave?h="%%text "+gHarmonicaKey+" Harp / +1 Octave":"-2"==gHarmonicaOctave?h="%%text "+gHarmonicaKey+" Harp / -2 Octaves":"2"==gHarmonicaOctave?h="%%text "+gHarmonicaKey+" Harp / +2 Octaves":"-3"==gHarmonicaOctave?h="%%text "+gHarmonicaKey+" Harp / -3 Octaves":"3"==gHarmonicaOctave&&(h="%%text "+gHarmonicaKey+" Harp / +3 Octaves"),gHarmonicaTuning){case"0":h+=" (Standard Richter)\n";break;case"1":h+=" (Paddy Richter)\n";break;case"2":h+=" (Easy Thirds)\n";break;case"3":h+=" (Melody Maker)\n";break;case"4":h+=" (Country - Major 7th)\n";break;case"5":h+=" (Natural Minor)\n";break;case"6":h+=" (Chromatic 12-Hole)\n";break;case"7":h+=" (Chromatic 16-Hole)\n";break;case"8":h+=" ("+gHarmonicaCustom.name+")\n"}g=InjectStringBelowTuneHeaderConditional(g,h),g=(g=InjectStringBelowTuneHeaderConditional(g,"%%vskip 15")).replaceAll("\n\n","\n"),d+=g,d+="\n\n"}return normalizeBlankLines(d)}(e)},CustomTabGenerator=function(e){var a=null;function n(e){}function r(e,r,o){var _=gCustomTab.noteMap;if(n("Got input:"+e),null==(a=function e(a){var r,t,c=null,l=a.match(/^K: *([A-G])([b#])? *(.*?)$/m);if(null==l||l.length<3)return null;if(r=void 0==l[2]?l[1]:l[1]+l[2],n("Got base key of '"+r+"' and extra of '"+(t=(t=(t=l[3].toLowerCase()).replace(/%.*/,"")).trim())+"'"),""==t||-1!=t.search("maj")||-1!=t.search("ion")?(n("Mode: Ionian (major)"),c=s(r,0)):-1!=t.search("mix")?(n("Mode: Mixolydian"),c=s(r,1)):-1!=t.search("dor")?(n("Mode: Dorian"),c=s(r,2)):-1!=t.search("m")&&-1==t.search("mix")||-1!=t.search("min")||-1!=t.search("aeo")?(n("Mode: Aeolian (minor)"),c=s(r,3)):-1!=t.search("phr")?(n("Mode: Phrygian"),c=s(r,4)):-1!=t.search("loc")?(n("Mode: Locrian"),c=s(r,5)):-1!=t.search("lyd")?(n("Mode: Lydian"),c=s(r,-1)):-1!=t.search("exp")?(n("(Accidentals to be explicitly specified)"),c=s("C",0)):(n("Failed to determine key signature mode"),c=null),null==c)return c;var i=t.match(/_./g),o=t.match(/\^./g);for(note in i)c.flats+=i[note][1].toUpperCase();for(note in o)c.sharps+=o[note][1].toUpperCase();return c}(e)))return"ERROR: Unknown or unsupported key signature";var u=function e(r,s,o,_){for(var u,d,f=r,g=/^\w:.*$/mg;u=g.exec(r);)f=c(f,u.index,u[0].length);for(var h=/"[^"]*"/gm;d=h.exec(f);)for(var $=d.index,x=$+d[0].length,p=$;p<x;++p)f=f.substring(0,p)+"*"+f.substring(p+1);for(h=/\[[^\]|]*\]/g;d=h.exec(f);)for(var $=d.index,x=$+d[0].length,p=$;p<x;++p)f=f.substring(0,p)+"*"+f.substring(p+1);for(h=/![^!\n]*!/gm;d=h.exec(f);)for(var $=d.index,x=$+d[0].length,p=$;p<x;++p)f=f.substring(0,p)+"*"+f.substring(p+1);for(h=/^%%begintext((.|\n)*)%%endtext/gm;d=h.exec(f);)for(var $=d.index,x=$+d[0].length,p=$;p<x;++p)f=f.substring(0,p)+"*"+f.substring(p+1);for(h=/^%.*$/gm;d=h.exec(f);)for(var $=d.index,x=$+d[0].length,p=$;p<x;++p)f=f.substring(0,p)+"*"+f.substring(p+1);n("sanitized input:"+(f=f.replaceAll("!","*")));for(var v=/([=^_]?[a-gA-G][',']*['']*|\|)/g,m=[];d=v.exec(f);){var G=d[1];if("|"==G)a.accidentalFlats="",a.accidentalSharps="",a.accidentalNaturals="";else{var A=i(G);n("UnNormalized="+G+" normalized="+A);var F=l(A,s,o,_);m.push(new t(d.index,G,A,F))}}return m}(e,r,o,_);return function e(a,n){for(var r,t=a,s=0,c=parseInt(gInjectTab_TabLocation),l=0;l<n.length;++l){var i=n[l].index+s,o=n[l].glyph;switch(o.length,c){case 0:r='"^'+o+'"';break;case 1:r='"_'+o+'"'}var _=r.length;t=t.substr(0,i)+r+t.substr(i),s+=_}return t}(e,u)}var t=function(e,a,n,r){this.index=e,this.unNormalizedValue=a,this.normalizedValue=n,this.glyph=r};function s(e,a){var r="FCGDAEB",t={sharps:"",flats:""},s=r.indexOf(e[0])-1;if(-2==s)return n("Bad tonic: "+e),null;"b"==e.slice(1)?s-=7:"#"==e.slice(1)&&(s+=7);var c=s-a;return c>7?(n("Too many sharps: "+c),null):c<-7?(n("Too many flats: "+-1*c),null):(c>0?t.sharps=r.slice(0,c):c<0&&(t.flats=r.slice(c)),t.accidentalSharps="",t.accidentalFlats="",t.accidentalNaturals="",t)}function c(e,a,n){for(var r="",t=0;t<n;++t)r+="*";return e.substr(0,a)+r+e.substr(a+n)}function l(e,a,n,r){var t={"C,":0,"^C,":1,"_D,":1,"D,":2,"^D,":3,"_E,":3,"E,":4,"^E,":5,"_F,":4,"F,":5,"^F,":6,"_G,":6,"G,":7,"^G,":8,"_A,":8,"A,":9,"^A,":10,"_B,":10,"B,":11,"^B,":12,_C:11,C:12,"^C":13,_D:13,D:14,"^D":15,_E:15,E:16,"^E":17,_F:16,F:17,"^F":18,_G:18,G:19,"^G":20,_A:20,A:21,"^A":22,_B:22,B:23,"^B":24,_c:23,c:24,"^c":25,_d:25,d:26,"^d":27,_e:27,e:28,"^e":29,_f:28,f:29,"^f":30,_g:30,g:31,"^g":32,_a:32,a:33,"^a":34,_b:34,b:35,"^b":36,"_c'":35,"c'":36,"^c'":37,"_d'":37,"d'":38,"^d'":39,"_e'":39,"e'":40,"^e'":41,"_f'":40,"f'":41,"^f'":42,"_g'":42,"g'":43,"^g'":44,"_a'":44,"a'":45,"^a'":46,"_b'":46,"b'":47,"^b'":48,"_c''":47,"c''":48,"^c''":49,"_d''":49,"d''":50,"^d''":51,"_e''":51,"e''":52,"^e''":53,"_f''":52,"f''":53,"^f''":54,"_g''":54,"g''":55,"^g''":56,"_a''":56,"a''":57,"^a''":58,"_b''":58,"b''":59,"=C,":0,"=D,":2,"=E,":4,"=F,":5,"=G,":7,"=A,":9,"=B,":11,"=C":12,"=D":14,"=E":16,"=F":17,"=G":19,"=A":21,"=B":23,"=c":24,"=d":26,"=e":28,"=f":29,"=g":31,"=a":33,"=b":35,"=c'":36,"=d'":38,"=e'":40,"=f'":41,"=g'":43,"=a'":45,"=b'":47,"=c''":48,"=d''":50,"=e''":52,"=f''":53,"=g''":55,"=a''":57,"=b''":59,"C'":24,"^C'":25,"_D'":25,"D'":26,"^D'":27,"_E'":27,"E'":28,"F'":29,"^F'":30,"_G'":30,"G'":31,"^G'":32,"_A'":32,"A'":33,"^A'":34,"_B'":34,"B'":35,"C''":36,"^C''":37,"_D''":37,"D''":38,"^D''":39,"_E''":39,"E''":40,"F''":41,"^F''":42,"_G''":42,"G''":43,"A''":45,"B''":47,"=C'":24,"=D'":26,"=E'":28,"=F'":29,"=G'":31,"=A'":33,"=B'":35,"=C''":36,"=D''":38,"=E''":40,"=F''":41,"=G''":43,"=A''":45,"=B''":47}[e],s=0;if(s=parseInt(a,10),t+=s,"1"==n?t+=12:"-1"==n?t-=12:"2"==n?t+=24:"-2"==n?t-=24:"3"==n?t+=36:"-3"==n&&(t-=36),t<0||0!=t&&!t)return"x";var c=r[t];return c||"x"}function i(e){var r=e.search(/[A-G]/i);if(-1==r)return n("Failed to find basename for value!"),e;var t=e.substr(r,1).toUpperCase();return"="==e.substr(0,1)?(a.accidentalFlats=a.accidentalFlats.replace(t,""),a.accidentalSharps=a.accidentalSharps.replace(t,""),a.accidentalNaturals+=t,e.substr(1)):"_"==e.substr(0,1)?(a.accidentalFlats+=t,a.accidentalSharps=a.accidentalSharps.replace(t,""),a.accidentalNaturals=a.accidentalNaturals.replace(t,""),e):"^"==e.substr(0,1)?(a.accidentalFlats=a.accidentalFlats.replace(t,""),a.accidentalNaturals=a.accidentalNaturals.replace(t,""),a.accidentalSharps+=t,e):-1!=a.accidentalNaturals.search(t)?e:-1!=a.sharps.search(t)||-1!=a.accidentalSharps.search(t)?"^"+e:-1!=a.flats.search(t)||-1!=a.accidentalFlats.search(t)?"_"+e:e}function o(e){return e.split("\n").filter(e=>!/^%%vskip 15$|^%%text Tab:|^%%annotationfont/.test(e)).join("\n")}return function e(a){var n,t=gInjectTab_FontFamily,s=gInjectTab_TabFontSize,c=gInjectTab_StaffSep,l=parseInt(gInjectTab_TabLocation),i=gInjectTab_StripChords,_=(n=a).split(/^X:.*$/gm).length-1,u=FindPreTuneHeader(a);clearGetTuneByIndexCache();for(var d=0;d<_;++d){var f=getTuneByIndex(d);if(isSectionHeader(f)||isMultiVoiceTune(f)){u+="\n",u+=f,u+="\n\n";continue}f=o(f),f=StripTabOne(f),(0==l||1==l&&i)&&(f=StripChordsOne(f)),f=r(f,gCustomTabKey,gCustomTabOctave),f=InjectStringBelowTuneHeaderConditional(f,"%%staffsep "+c),f=InjectStringAboveTuneHeaderConditional(f,"%%annotationfont "+t+" "+s);var g="%%text Tab: "+gCustomTab.name,h="",$="";-1==gCustomTabKey.indexOf("-")&&(h="+"),-1==gCustomTabOctave.indexOf("-")&&($="+"),f=InjectStringBelowTuneHeaderConditional(f,g="0"!=gCustomTabKey?"0"==gCustomTabOctave?"%%text Tab: "+gCustomTab.name+" / Semitones = "+h+gCustomTabKey:"%%text Tab: "+gCustomTab.name+" / Octave = "+$+gCustomTabOctave+" / Semitones = "+h+gCustomTabKey:"0"==gCustomTabOctave?"%%text Tab: "+gCustomTab.name:"%%text Tab: "+gCustomTab.name+" / Octave = "+$+gCustomTabOctave),f=(f=InjectStringBelowTuneHeaderConditional(f,"%%vskip 15")).replaceAll("\n\n","\n"),u+=f,u+="\n\n"}return normalizeBlankLines(u)}(e)};