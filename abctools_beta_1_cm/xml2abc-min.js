var vertaal,xml2abc_VERSION=118,gGotMicrotonalAccidental=!1;!function(){"use strict";function t(t,e){return Array(t+1).join(e)}function e(t,e){for(var i=[];t;)i.push(e),--t;return i}function i(t,e){for(var i=0,n={};i<t.length;++i)n[t[i]]=e[i];return n}function n(t,e){var i=t.split(/%[ds]/);return i.length>e.length&&e.push(""),e.map(function(t,e){return i[e]+t}).join("")}function s(t,e){h.info(n(t,e))}function r(t,e){return -1!==t.indexOf(e,t.length-e.length)}function a(t){return Object.keys(t).map(function(t){return parseInt(t)})}function o(t,e){var i,n,s=[];if(Array.isArray(t))for(n=0;n<t.length;++n)n in t&&s.push([n,t[n]]);else for(n in t)s.push([n,t[n]]);return i=e?function(t,e){return t[0]-e[0]}:function(t,e){return t[1]-e[1]||e[0]-t[0]},s.sort(i),s}var h,c={"ornaments>trill-mark":"T","ornaments>mordent":"M","ornaments>inverted-mordent":"P","ornaments>turn":"!turn!","ornaments>inverted-turn":"!invertedturn!","technical>up-bow":"u","technical>down-bow":"v","technical>harmonic":"!open!","technical>open-string":"!open!","technical>stopped":"!plus!","technical>snap-pizzicato":"!snap!","technical>thumb-position":"!thumb!","articulations>accent":"!>!","articulations>strong-accent":"!^!","articulations>staccato":".","articulations>staccatissimo":"!wedge!","articulations>scoop":"!slide!",fermata:"!fermata!",arpeggiate:"!arpeggio!","articulations>tenuto":"!tenuto!","articulations>spiccato":"!wedge!","articulations>breath-mark":"!breath!","articulations>detached-legato":"!tenuto!."},l={p:"!p!",pp:"!pp!",ppp:"!ppp!",pppp:"!pppp!",f:"!f!",ff:"!ff!",fff:"!fff!",ffff:"!ffff!",mp:"!mp!",mf:"!mf!",sfz:"!sfz!"},p=["%%beginsvg\n<defs>",'<text id="x" x="-3" y="0">&#xe263;</text>','<text id="x-" x="-3" y="0">&#xe263;</text>','<text id="x+" x="-3" y="0">&#xe263;</text>','<text id="normal" x="-3.7" y="0">&#xe0a3;</text>','<text id="normal-" x="-3.7" y="0">&#xe0a3;</text>','<text id="normal+" x="-3.7" y="0">&#xe0a4;</text>','<g id="circle-x"><text x="-3" y="0">&#xe263;</text><circle r="4" class="stroke"></circle></g>','<g id="circle-x-"><text x="-3" y="0">&#xe263;</text><circle r="4" class="stroke"></circle></g>','<path id="triangle" d="m-4 -3.2l4 6.4 4 -6.4z" class="stroke" style="stroke-width:1.4"></path>','<path id="triangle-" d="m-4 -3.2l4 6.4 4 -6.4z" class="stroke" style="stroke-width:1.4"></path>','<path id="triangle+" d="m-4 -3.2l4 6.4 4 -6.4z" class="stroke" style="fill:#000"></path>','<path id="square" d="m-3.5 3l0 -6.2 7.2 0 0 6.2z" class="stroke" style="stroke-width:1.4"></path>','<path id="square-" d="m-3.5 3l0 -6.2 7.2 0 0 6.2z" class="stroke" style="stroke-width:1.4"></path>','<path id="square+" d="m-3.5 3l0 -6.2 7.2 0 0 6.2z" class="stroke" style="fill:#000"></path>','<path id="diamond" d="m0 -3l4.2 3.2 -4.2 3.2 -4.2 -3.2z" class="stroke" style="stroke-width:1.4"></path>','<path id="diamond-" d="m0 -3l4.2 3.2 -4.2 3.2 -4.2 -3.2z" class="stroke" style="stroke-width:1.4"></path>','<path id="diamond+" d="m0 -3l4.2 3.2 -4.2 3.2 -4.2 -3.2z" class="stroke" style="fill:#000"></path>',"</defs>\n%%endsvg"],f=["%%beginsvg\n",'<style type="text/css">\n',".bf {font-family:sans-serif; font-size:7px}\n","</style>\n","<defs>\n",'<rect id="clr" x="-3" y="-1" width="6" height="5" fill="white"></rect>\n','<rect id="clr2" x="-3" y="-1" width="11" height="5" fill="white"></rect>\n'],d='<g id="kop%s" class="bf"><use xlink:href="#clr"></use><text x="-2" y="3">%s</text></g>\n',u='<g id="kop%s" class="bf"><use xlink:href="#clr2"></use><text x="-2" y="3">%s</text></g>\n';function m(t){this.reset(),this.ixp=t,this.ixm=0,this.mdur=0,this.divs=0,this.mtr=[4,4]}function g(t,e){this.tijd=0,this.dur=t,this.fact=null,this.tup=[""],this.tupabc="",this.beam=0,this.grace=0,this.before=[],this.after="",this.ns=e?[e]:[],this.lyrs={},this.pos=0,this.tab=null,this.ntdec=""}function _(t){this.tijd=0,this.str=t,this.pos=0}function v(){}function b(t){this.tijd=0,this.maxtime=0,this.gMaten=[],this.gLyrics=[],this.vnums={},this.cnt=new v,this.vceCnt=1,this.lastnote=null,this.bpl=t.b,this.cpl=t.n,this.repbra=0,this.nvlt=t.v,this.addstavenum=t.addstavenum}function x(t,e,i,n){this.fnmext=t,this.outlist=[],this.infolist=[],this.title="T:Title",this.key="none",this.clefs={},this.mtr="none",this.tempo=0,this.tempo_units=[1,4],this.pad=e,this.X=i+1,this.denL=n.d,this.volpan=n.m,this.cmpL=[],this.scale="",this.tstep=n.t,this.stemless=0,this.pagewidth="",this.leftmargin="",this.rightmargin="",this.shiftStem=n.s,this.nolbrk=n.x,this.mnum=n.mnum,4==n.p.length&&(this.scale=""!=n.p[0]?parseFloat(n.p[0]):"",this.pagewidth=""!=n.p[1]?parseFloat(n.p[1]):"",this.leftmargin=""!=n.p[2]?parseFloat(n.p[2]):"",this.rightmargin=""!=n.p[3]?parseFloat(n.p[3]):"")}function y(t,e){if(!t.join(""))return["",0];for(var i=[],n=0;n<t.length;++n){var s=t[n];""==s?s=e?"_":"*":r(s,"_")&&!r(s,"\\_")?(s=s.replace("_",""),e=1):e=0,i.push(s)}return[i.join(" "),e]}function w(t,e){for(var i,n=t,s=e;e;)i=t%e,t=e,e=i;return[n/t,s/t]}function k(t,e,i){if(0==t.dur)return"";if(n=(c=w(i*t.dur,4*e))[0],r=c[1],t.fact&&(n=(c=w(n*(a=t.fact[0]),r*(o=t.fact[1])))[0],r=c[1]),r>64){var n,r,a,o,h,c,l=n/r,p=Math.floor(l);l-p<.1*l&&(n=p,r=1),c=w(Math.round(64*n/r)||1,64),s("denominator too small: %d/%d rounded to %d/%d",[n,r,c[0],c[1]]),n=c[0],r=c[1]}return 1==n?1==r?"":2==r?"/":"/"+r:1==r?""+n:n+"/"+r}function O(t){var e=t.match(/([_^]*)([A-Ga-g])([',]*)/);if(!e)return -1;var i,n,s=e[1],r=e[2],a=e[3];return i=r.toUpperCase(),n=60+[0,2,4,5,7,9,11]["CDEFGAB".indexOf(i)]+(i!=r?12:0),s&&(n+=("^"==s[0]?1:-1)*s.length),a&&(n+=("'"==a[0]?12:-12)*a.length),n}function j(t,e,i){var s,r,a,o,h,c,l,p,f,d=0,u=e[t],m=u.tup.indexOf("start");m>-1&&u.tup.splice(m,1);var g=t;for(a=i[0],o=i[1],r=[(h=u.fact[0])/a,(c=u.fact[1])/o];t<e.length;){if((u=e[t])instanceof _||u.grace){t+=1;continue}if(u.tup.indexOf("start")>-1?(t=(f=j(t,e,r))[0],d+=l=f[1]):u.fact&&(d+=1),(m=u.tup.indexOf("stop"))>-1){u.tup.splice(m,1);break}if(!u.fact){t=s;break}s=t,t+=1}var v=[r[0],r[1],d];return p="3,2,3"==v.toString()?"(3":n("(%d:%d:%d",v),e[g].tupabc=p+e[g].tupabc,[t,d]}function M(t){t=t.filter(function(t){return t instanceof g});for(var e=0;e<t.length-1;){var i=t[e],n=t[e+1];!i.fact&&!n.fact&&i.dur>0&&n.beam&&(3*i.dur==n.dur?(n.dur=2*n.dur/3,i.dur=2*i.dur,i.after="<"+i.after,e+=1):3*n.dur==i.dur&&(i.dur=2*i.dur/3,n.dur=2*n.dur,i.after=">"+i.after,e+=1)),e+=1}}function S(t,e,i,n,s){for(var a,o=0;o<t.length;){var h=t[o];h instanceof g&&h.fact&&!h.grace&&(o=(a=j(o,t,[1,1]))[0]),o+=1}for(var c,l,p=[],f=0;f<t.length;++f){if((h=t[f])instanceof g){var d=k(h,e,s),u=h.ns.length>1,m=h.ns.filter(function(t){return r(t,"-")});m=m.map(function(t){return t.slice(0,-1)});var _="";u&&m.length==h.ns.length&&(h.ns=m,_="-"),l=h.tupabc+h.before.join(""),u&&(l+="["),l+=h.ns.join(""),u&&(l+="]"+_),r(l,"-")&&(l=l.slice(0,-1),_="-"),l+=d+_,l+=h.after,c=h.beam}else h.str instanceof Array&&(h.str=h.str[0]),l=h.str,c=1;c?p.push(l):p.push(" "+l)}for(p=p.join("");p.indexOf("!ped!!ped!")>=0;)p=p.replace(/!ped!!ped!/g,"!ped!");for(;p.indexOf("!ped-up!!ped-up!")>=0;)p=p.replace(/!ped-up!!ped-up!/g,"!ped-up!");for(;p.indexOf("!8va(!!8va)!")>=0;)p=p.replace(/!8va\(!!8va\)!/g,"");return p}function D(t,e){t.map(function(t,e){t.pos=e}),t.sort(function(t,e){return t.tijd-e.tijd||t.pos-e.pos});for(var i=0,n=[],r=[],a=0;a<t.length;++a){var o=t[a];if(o.tijd>i&&B(o.tijd-i,e)&&(n.push(new g(o.tijd-i,"x")),r.push(n.length-1)),o instanceof _){o.tijd<i&&(o.tijd=i),n.push(o),i=o.tijd;continue}if(o.tijd<i){if("z"==o.ns[0])continue;var h=n[n.length-1];if(h.tijd<=o.tijd){if("z"==h.ns[0])h.dur=o.tijd-h.tijd,0==h.dur&&n.pop(),s("overlap in part %d, measure %d: rest shortened",[e.ixp+1,e.ixm+1]);else{if(h.ns=h.ns.concat(o.ns),s("overlap in part %d, measure %d: added chord",[e.ixp+1,e.ixm+1]),o.dur=o.tijd+o.dur-i,o.dur<=0)continue;o.tijd=i}}else{s("overlapping notes in one voice! part %d, measure %d, note %s discarded",[e.ixp+1,e.ixm+1,o instanceof g?o.ns:o.str]);continue}}if(n.push(o),o instanceof g){var c=o.ns[0];if("x"==c||"z"==c)r.push(n.length-1);else if(r.length){if(o.beam&&!o.grace)for(var l=0;l<r.length;++l)n[r[l]].beam=o.beam;r=[]}}i=o.tijd+o.dur}return 0==i&&s("empty measure in part %d, measure %d, it should contain at least a rest to advance the time!",[e.ixp+1,e.ixm+1]),n}function A(t){var e,i,n,s;if(0==t.length)return[];for(n=0,e=[];n<t.length;++n){if(1==(i=t[n]).length)e.push(""+i[0]);else{for(e.push("("),s=0;s<i.length;++s)e.push(""+i[s]);e.push(")")}e.push("|")}return e.splice(-1,1),t.length>1&&(e=["{"].concat(e).concat(["}"])),e}function C(t,e,i,n,s,r){var a,o;"name_tuple"==t[0]?(a=n.shift(),e[0]&&(t[1]=e[0]+":"+t[1],t[2]=e[1]+":"+t[2]),s.push(t),r.push.apply(r,A(a))):2==t.length&&"name_tuple"==t[0][0]?(a=n.shift(),(o=["name_tuple","",""])[1]=t[0][1]+":"+t[1][2],o[2]=t[0][2]+":"+t[1][3],s.push(o),r.push.apply(r,A(a))):function t(e,i,n,s,r){var a,o,h,c,l,p;for(a=(p=e[e.length-1])[0],o=p[1],h=p[2],c=p[3],o="yes"==o||i,r.push("brace"==a?"{":"["),l=0;l<e.length-1;++l)C(e[l],[h,c],o,n,s,r),o&&r.push("|");o&&r.splice(-1,1),r.push("brace"==a?"}":"]")}(t,i,n,s,r)}function I(t,e,i){for(var n,s,r=0,a=9007199254740992,o=[4,8,16];o.length;){var h=o.shift(),c=0;for(n=0;n<e.length;++n){var l=e[n][t];for(s=0;s<l.length;++s){var p=l[s];p instanceof _||0==p.dur||(c+=k(p,i[n],h).length)}}c<a&&(r=h,a=c)}return r}function E(t){for(var e="",i=t.children(),n=0;n<i.length;++n){var s=i[n];switch(s.tagName){case"elision":e+="~";break;case"text":e+=$(s).text().replace(/_/g,"\\_").replace(/-/g,"\\-").replace(/ /g,"~")}}if(!e)return e;var r=t.find("syllabic").text();return("begin"==r||"middle"==r)&&(e+="-"),t.find("extend").length&&(e+="_"),e}function L(t,e,i,n){if(0!=i){var s,r,a,o=e[i][n],h=t[i][n],c=t[i-1][n];for(s in c)r=c[s][1],!(s in h)&&r&&(a=T(o))&&(h[s]=[a,0])}}function T(t){for(var e=[],i=0;i<t.length;++i){var n=t[i];if(n instanceof g&&!n.grace){if("z"==n.ns[0]||"x"==n.ns[0])break;e.push("_")}}return e.join(" ")}function F(e,i){var n=e;return i>4&&(n=e.toLowerCase()),i>5&&(n+=t(i-5,"'")),i<4&&(n+=t(4-i,",")),n}function B(t,e){return t>e.divs/16?1:(s("MuseScore bug: incorrect duration, smaller then 1/64! in measure %d, part %d",[e.ixm,e.ixp]),0)}function N(t){this.slurBuf={},this.dirStk={},this.ingrace=0,this.msc=new b(t),this.unfold=t.u,this.ctf=t.c,this.gStfMap=[],this.midiMap=[],this.drumInst={},this.drumNotes={},this.instMid=[],this.midDflt=[-1,-1,-1,-91],this.msralts={},this.curalts={},this.stfMap={},this.vce2stf={},this.clefMap={},this.curClef={},this.stemDir={},this.clefOct={},this.curStf={},this.nolbrk=t.x,this.doPageFmt=1==t.p.length,this.tstep=t.t,this.dirtov1=t.v1,this.ped=!t.noped,this.wstems=t.stm,this.pedVce=null,this.repeat_str={},this.tabVceMap={},this.koppen={},this.note_alts=["=C,^C,=D,^D,=E,=F,^F,=G,^G,=A,^A,=B".split(","),"^B,_D,^^C,_E,_F,^E,_G,^^F,_A,^^G,_B,_C".split(","),"__D,^^B,__E,__F,^^D,__G,^^E,__A,_/A,__B,__C,^^A".split(",")],this.step_map={C:0,D:2,E:4,F:5,G:7,A:9,B:11}}m.prototype.reset=function(){this.attr="",this.lline="",this.rline="|",this.lnum=""},v.prototype.inc=function(t,e){this.counters[t][e]=(this.counters[t][e]||0)+1},v.prototype.clear=function(t){var n=Object.keys(t),s=e(n.length,0);this.counters={note:i(n,s),nopr:i(n,s),nopt:i(n,s)}},v.prototype.getv=function(t,e){return this.counters[t][e]},v.prototype.prcnt=function(t){for(var e in this.counters.note)0!=this.getv("nopr",e)&&s("part %d, voice %d has %d skipped non printable notes",[t,e,this.getv("nopr",e)]),0!=this.getv("nopt",e)&&s("part %d, voice %d has %d notes without pitch",[t,e,this.getv("nopt",e)]),0==this.getv("note",e)&&s("part %d, skipped empty voice %d",[t,e])},b.prototype.initVoices=function(t){for(var e in this.vtimes={},this.voices={},this.lyrics={},this.vnums)this.vtimes[e]=0,this.voices[e]=[],this.lyrics[e]=[];t&&this.cnt.clear(this.vnums)},b.prototype.incTime=function(t){this.tijd+=t,this.tijd<0&&(this.tijd=0),this.tijd>this.maxtime&&(this.maxtime=this.tijd)},b.prototype.appendElemCv=function(t,e){for(var i in t)this.appendElem(i,e)},b.prototype.insertElem=function(t,e){var i=new _(e);i.tijd=0,this.voices[t].unshift(i)},b.prototype.appendObj=function(t,e,i){e.tijd=this.tijd,this.voices[t].push(e),this.incTime(i),this.tijd>this.vtimes[t]&&(this.vtimes[t]=this.tijd)},b.prototype.appendElemT=function(t,e,i){var n=new _(e);n.tijd=i,this.voices[t].push(n)},b.prototype.appendElem=function(t,e,i){this.appendObj(t,new _(e),0),i&&this.cnt.inc("note",t)},b.prototype.appendNote=function(t,e,i){e.ns.push(e.ntdec+i),this.appendObj(t,e,parseInt(e.dur)),this.lastnote=e,"z"==i||"x"==i||(this.cnt.inc("note",t),e.grace||this.lyrics[t].push(e.lyrs))},b.prototype.getLastRec=function(t){if(this.gMaten.length){var e=this.gMaten[this.gMaten.length-1][t];return e[e.length-1]}return null},b.prototype.getLastMelis=function(t,e){if(this.gLyrics.length){var i=this.gLyrics[this.gLyrics.length-1][t];if(e in i)return i[e][1]}return 0},b.prototype.addChord=function(t,e){for(var i=0;i<t.before.length;i++){var n=t.before[i];0>this.lastnote.before.indexOf(n)&&this.lastnote.before.push(n)}this.lastnote.ns.push(t.ntdec+e)},b.prototype.addBar=function(t,e){for(var i in e.mdur&&this.maxtime>e.mdur&&s("measure %d in part %d longer than metre",[e.ixm+1,e.ixp+1]),this.tijd=this.maxtime,this.vnums){if(e.lline||e.lnum){var n=this.getLastRec(i);if(n){var r=n.str;e.lline&&(r=(r+e.lline).replace(/:\|:/g,"::").replace(/\|\|/g,"|")),3==this.nvlt?e.ixp+parseInt(i)==Math.min.apply(null,a(this.vnums))&&(r+=e.lnum):4==this.nvlt?parseInt(i)==Math.min.apply(null,a(this.vnums))&&(r+=e.lnum):e.lnum&&(r+=e.lnum,this.repbra=1),n.str=r}else e.lline&&this.insertElem(i,"|:")}t&&(n=this.getLastRec(i))&&(n.str+=t),e.attr&&this.insertElem(i,""+e.attr),this.appendElem(i," "+e.rline),this.voices[i]=D(this.voices[i],e);for(var o=this.lyrics[i],h={},c=o.reduce(function(t,e){return t.concat(a(e))},[]),l=Math.max.apply(null,c.concat([0])),p=l;p>0;--p){var f=o.map(function(t){return t[p]||""}),d=this.getLastMelis(i,p);h[p]=y(f,d)}this.lyrics[i]=h,M(this.voices[i])}this.gMaten.push(this.voices),this.gLyrics.push(this.lyrics),this.tijd=this.maxtime=0,this.initVoices()},b.prototype.outVoices=function(t,i){var n,s,r,c,l,p,f,d,u,m,g,_,v,b;for(d in l={},f=Math.min.apply(null,a(this.vnums)||[1]),this.vnums)if(0!=this.cnt.getv("note",d)){p=h.denL?h.denL:I(d,this.gMaten,t),h.cmpL.push(p);var x=[],y={};for(u=0;u<this.gMaten.length;++u)for(r in m=this.gMaten[u][d],x.push(S(m,t[u],u,i,p)),L(this.gLyrics,this.gMaten,u,d),g=this.gLyrics[u][d])if(_=(b=g[r])[0],r in y){for(;y[r].length<u;)y[r].push("");y[r].push(_)}else y[r]=e(u,"").concat([_]);for(r in y)c=y[r],v=x.length-c.length,y[r]=c.concat(e(v,""));h.add("V:"+this.vceCnt),this.repbra&&(1==this.nvlt&&this.vceCnt>1&&h.add("I:repbra 0"),2==this.nvlt&&parseInt(d)>f&&h.add("I:repbra 0")),this.cpl>0?this.bpl=0:0==this.bpl&&(this.cpl=100);for(var w=0;x.length;){for(var k=1,O=x[0];k<x.length&&(!(this.cpl>0)||!(O.length+x[k].length>=this.cpl))&&(!(this.bpl>0)||!(k>=this.bpl));)O+=x[k],k+=1;for(w+=k,this.addstavenum?h.add(O+" %"+w):h.add(O),x.splice(0,k),n=o(y,1),s=0;s<n.length;++s)r=(b=n[s])[0],c=b[1],h.add("w: "+c.slice(0,k).join("|")+"|"),c.splice(0,k)}l[d]=this.vceCnt,this.vceCnt+=1}return this.gMaten=[],this.gLyrics=[],this.cnt.prcnt(i+1),l},x.prototype.add=function(t){this.outlist.push(t+"\n")},x.prototype.info=function(t,e){this.infolist.push((void 0===e||e?"-- ":"")+t)},x.prototype.mkHeader=function(t,e,i,r,a){var h,c,l,p,m,g,_,v,b,x,y,w,k,j,M,S,D,A,I,E,L,T,F,B,N,V,q,z,G,U=[],P=[],K=t.slice();for(k=0;k<e.length;++k){I=e[k];try{C(I,["",""],"",t,U,P)}catch(R){s("lousy musicxml: error in part-list",[])}}for(k=0,E=P.join(" "),L={};k<K.length&&k<U.length;++k)T=K[k],F=(V=U[k])[1],B=V[2],0!=T.length&&(N=T[0][0],h=F.replace(/\n/g,"\\n").replace(/\.:/g,".").replace(/^:|:$/g,""),c=B.replace(/\n/g,"\\n").replace(/\.:/g,".").replace(/^:|:$/g,""),L[N]=(h?'nm="'+h+'"':"")+(c?' snm="'+c+'"':""));for(A=this.mnum>-1?"%%measurenb "+this.mnum+"\n":"",l=[n("X:%d\n%s\n%s",[this.X,this.title,A])],""!==this.scale&&l.push("%%scale "+this.scale+"\n"),""!==this.pagewidth&&l.push("%%pagewidth "+this.pagewidth+"cm\n"),""!==this.leftmargin&&l.push("%%leftmargin "+this.leftmargin+"cm\n"),""!==this.rightmargin&&l.push("%%rightmargin "+this.rightmargin+"cm\n"),E&&P.length>1&&l.push("%%score "+E+"\n"),p=this.tempo?n("Q:%d/%d=%s\n",[this.tempo_units[0],this.tempo_units[1],this.tempo]):"",m=[],k=0;k<this.cmpL.length;++k)m[I=this.cmpL[k]]=(m[I]||0)+1;g=(m=o(m))[m.length-1][0],g=this.denL?this.denL:g,l.push(n("L:1/%d\n%sM:%s\n",[g,p,this.mtr])),this.nolbrk?l.push(n("K:%s\n",[this.key])):l.push(n("I:linebreak $\nK:%s\n",[this.key])),l.push("%%stretchlast true\n"),this.stemless&&l.push("U:s=!stemless!\n");var X=Object.keys(r).sort();for(k=0;k<X.length;++k)l=l.concat(r[X[k]]);for(_ in this.dojef=0,this.clefs){for(b=(V=i[_-1])[0],x=V[1],y=V[2],w=V[3],q=V.slice(4),v=this.clefs[_],q.length&&0>v.indexOf("perc")&&(v=(v+" map=perc").trim()),l.push(n("V:%d %s %s\n",[_,v,L[_]||""])),(_ in r)&&(l.push(n("%%voicemap tab%d\n",[_])),l.push("K:none\nM:none\n%%clef none\n%%staffscale 1.6\n%%flatbeams true\n%%stemdir down\n")),v.indexOf("perc")>-1&&l.push("K:none\n"),this.volpan>1?(b>0&&b!=_&&l.push("%%MIDI channel "+b+"\n"),x>0&&l.push("%%MIDI program "+(x-1)+"\n"),y>=0&&l.push("%%MIDI control 7 "+y+"\n"),w>=0&&l.push("%%MIDI control 10 "+w+"\n")):this.volpan>0&&(q.length&&b>0&&l.push("%%MIDI channel "+b+"\n"),x>0&&l.push("%%MIDI program "+(x-1)+"\n")),k=0;k<q.length;++k)j=q[k].nt,S=q[k].step,M=q[k].midi,(D=q[k].nhd)||(D="normal"),(O(j)!=M||j!=S)&&(this.volpan>0&&l.push("%%MIDI drummap "+j+" "+M+"\n"),l.push("I:percmap "+j+" "+S+" "+M+" "+D+"\n"),this.dojef=this.tstep);g!=this.cmpL[_-1]&&l.push("L:1/"+this.cmpL[_-1]+"\n")}if(this.outlist=l.concat(this.outlist),(G=Object.keys(a).sort()).length){z=[];var H=this.shiftStem?d.replace("-2","-5"):d,Q=this.shiftStem?u.replace("-2","-5"):u,W=this.shiftStem?f.map(function(t){return t.replace("-3","-6")}):f;G.forEach(function(t){z.push(t.length>1?n(Q,[t,t]):n(H,[t,t]))}),this.outlist=W.concat(z,"</defs>\n%%endsvg\n",this.outlist)}},x.prototype.writeall=function(){var t=h.outlist.join("");return this.dojef&&(t=function t(e){var i,n,s,r,a={diamond:1,triangle:1,square:1,normal:1},o=p,h="default",c={default:[]},l={default:[]};for(n=0,i=e.split("\n");n<i.length;++n){if((s=i[n]).indexOf("I:percmap")>=0){var f=(s=s.split(" ").map(function(t){return t.trim()}))[4];f in a&&(f=f+"+,"+f),s="%%map perc"+h+" "+s[1]+" print="+s[2]+" midi="+s[3]+" heads="+f,c[h].push(s)}s.indexOf("%%MIDI")>=0&&l[h].push(s),s.indexOf("V:")>=0&&(r=s.match(/V:\s*(\S+)/))&&!((h=r[1])in c)&&(c[h]=[],l[h]=[])}var d=Object.keys(c).sort();for(n=0;n<d.length;++n)o=o.concat(c[d[n]]);for(n=0,h="default";n<i.length;++n)!((s=i[n]).indexOf("I:percmap")>=0)&&!(s.indexOf("%%MIDI")>=0)&&(s.indexOf("V:")>=0||s.indexOf("K:")>=0?((r=s.match(/V:\s*(\S+)/))&&(h=r[1]),o.push(s),h in l&&l[h].length&&(o=o.concat(l[h]),delete l[h]),s.indexOf("perc")>=0&&-1==s.indexOf("map=")&&(s+=" map=perc"),s.indexOf("map=perc")>=0&&c[h].length>0&&o.push("%%voicemap perc"+h),s.indexOf("map=off")>=0&&o.push("%%voicemap")):o.push(s));return o.join("\n")}(t)),gGotMicrotonalAccidental&&(t=function t(e,i){let n=e.split("\n"),s=[],r=/^X:\d+/;for(let a=0;a<n.length;a++)r.test(n[a])?(s.push(n[a]),s.push(i)):s.push(n[a]);return s.join("\n")}(t,"% Injected for microtonal accidental annotations\n%%annotationfont Palatino 9")),[t,this.infolist.join("\n")]},N.prototype.matchSlur=function(t,e,i,n,r,a){if(-1!=["start","stop"].indexOf(t)){if(e||(e="1"),e in this.slurBuf){var o=this.slurBuf[e],h=o[0],c=o[1],l=o[2],p=o[3];t!=h?(i!=c||"start"!=h||p&&a||(l.before.unshift("("),n.after+=")"),delete this.slurBuf[e]):(s("double slur numbers %s-%s in part %d, measure %d, voice %d note %s, first discarded",[t,e,this.msr.ixp+1,this.msr.ixm+1,i,n.ns]),this.slurBuf[e]=[t,i,n,r])}else this.slurBuf[e]=[t,i,n,r]}},N.prototype.doNotations=function(e,i,s){for(var r=Object.keys(c).sort(),a=0;a<r.length;++a){var o=r[a],h=c[o];i.find(o).length&&e.before.push(h)}var l=i.find("ornaments>tremolo");if(l.length){var p=l.attr("type"),f=t(parseInt(l.text()),"/");"single"==p?e.before.unshift("!"+f+"!"):(e.fact=null,this.tstep?"stop"==p&&e.before.unshift("!trem"+l.text()+"!"):"start"==p&&e.before.unshift("!"+f+"-!"))}var d=i.find("technical>fingering");s||d.each(function(){e.before.push("!"+$(this).text()+"!")});var u=i.find("technical>string");if(u.length&&s){if(this.tstep){var m=i.find("technical>fret");m.length&&(e.tab=[u.eq(0).text(),m.eq(0).text()])}else u.each(function(){var t="!"+$(this).text()+"!";0>e.ntdec.indexOf(t)&&(e.ntdec+=t)})}var g=i.find("ornaments>wavy-line");for(var f of g.toArray())switch($(f).attr("type")){case"start":e.before.unshift("!trill(!");break;case"stop":e.after+="!trill)!"}var _=i.find("glissando");if(0==_.length&&(_=i.find("slide")),_.length){var v="wavy"==_.attr("line-type")?"~":"-";"start"==_.attr("type")?e.before.unshift(n("!%s(!",[v])):"stop"==_.attr("type")&&e.before.unshift(n("!%s)!",[v]))}},N.prototype.tabnote=function(t,e,i,n,r){var a,o,h,c,l,p,f,d,u,m,g;for((d=this.step_map[e]+parseInt(t||"0"))>11&&(i+=1,d-=12),d<0&&(i-=1,d+=12),l=r.tab[0],f=r.tab[1],g=0;g<4&&(u=this.note_alts[g%3][d],m=i,["^B","^^B"].indexOf(u)>-1&&(m-=1),["_C","__C"].indexOf(u)>-1&&(m+=1),(u.indexOf("/")>-1||3==g)&&(m=9),a=F(u,m),c=(o=this.tabmap[[n,a]]||["",""])[0],p=o[1],c);++g){if(l==c)return a;3==g&&(s(h="rejected: voice %d note %s string %s fret %s remains: string %s fret %s",[n,a,l,f,c,p]),r.tab=[c,p])}return this.tabmap[[n,a]]=r.tab,a},N.prototype.ntAbc=function(t,e,i,n,r,a){e+=this.clefOct[this.curStf[n]]||0;var o,h=i.find("accidental").text(),c=!1;if("other"==h){if("accidentalLowerOneUndecimalQuartertone"==(o=i.find("accidental").attr("smufl")))h="quarter-flat";else if("accidentalRaiseOneUndecimalQuartertone"==o)h="quarter-sharp";else if("accidentalDoubleFlatOneArrowDown"==o)h="flat-flat-down";else if("accidentalFlatOneArrowDown"==o)h="flat-down";else if("accidentalNaturalOneArrowDown"==o)h="natural-down";else if("accidentalSharpOneArrowDown"==o)h="sharp-down";else if("accidentalDoubleSharpOneArrowDown"==o)h="double-sharp-down";else if("accidentalDoubleFlatOneArrowUp"==o)h="flat-flat-up";else if("accidentalFlatOneArrowUp"==o)h="flat-up";else if("accidentalNaturalOneArrowUp"==o)h="natural-up";else if("accidentalSharpOneArrowUp"==o)h="sharp-up";else if("accidentalDoubleSharpOneArrowUp"==o)h="double-sharp-up";else{c=!0,gGotMicrotonalAccidental=!0;var l=!0;switch(o){case"accidentalDoubleFlatTwoArrowsDown":o="♭♭↓↓";break;case"accidentalFlatTwoArrowsDown":o="♭↓↓";break;case"accidentalNaturalTwoArrowsDown":o="♮↓↓";break;case"accidentalSharpTwoArrowsDown":o="♯↓↓";break;case"accidentalDoubleSharpTwoArrowsDown":o="♯♯↓↓";break;case"accidentalDoubleFlatTwoArrowsUp":o="♭♭↑↑";break;case"accidentalFlatTwoArrowsUp":o="♭↑↑";break;case"accidentalNaturalTwoArrowsUp":o="♮↑↑";break;case"accidentalSharpTwoArrowsUp":o="♯↑↑";break;case"accidentalDoubleSharpTwoArrowsUp":o="♯♯↑↑";break;case"accidentalDoubleFlatThreeArrowsDown":o="♭♭↓↓↓";break;case"accidentalFlatThreeArrowsDown":o="♭↓↓↓";break;case"accidentalNaturalThreeArrowsDown":o="♮↓↓↓";break;case"accidentalSharpThreeArrowsDown":o="♯↓↓↓";break;case"accidentalDoubleSharpThreeArrowsDown":o="♯♯↓↓↓";break;case"accidentalDoubleFlatThreeArrowsUp":o="♭♭↑↑↑";break;case"accidentalFlatThreeArrowsUp":o="♭↑↑↑";break;case"accidentalNaturalThreeArrowsUp":o="♮↑↑↑";break;case"accidentalSharpThreeArrowsUp":o="♯↑↑↑";break;case"accidentalDoubleSharpThreeArrowsUp":o="♯♯↑↑↑";break;default:l=!1}l||(o=-1!=o.toLowerCase().indexOf("raise")||-1!=o.toLowerCase().indexOf("sharp")?"♯?":-1!=o.toLowerCase().indexOf("lower")||-1!=o.toLowerCase().indexOf("flat")?"♭?":-1!=o.toLowerCase().indexOf("natural")?"♮?":"?")}}var p=i.find("pitch>alter").text();if(r.tab)return this.tabnote(p,t,e,n,r);a&&this.tstep&&s("no string notation found for note %s in voice %d",[["__","_","","^","^^"][parseInt(p||"0")+2]+F(t,e),n]);var f=F(t,e);!p&&this.msralts[t]&&(p=0);var d=f+"#"+n;if(!p&&d in this.curalts&&(p=0),""===h&&""===p)return f;if(""!=h)p=c?o:({"quarter-flat":-3,"double-flat":-2,"flat-flat":-2,flat:-1,natural:0,sharp:1,"sharp-sharp":2,"double-sharp":2,"quarter-sharp":3})[h];else{if(p=parseFloat(p),d in this.curalts){if(p==this.curalts[d])return f}else if(p==(this.msralts[t]||0))return f;if(i.find("tie").add(i.find("notations>tied")).get().some(function(t){return"stop"==$(t).attr("type")}))return f;s("accidental %d added in part %d, measure %d, voice %d note %s",[p,this.msr.ixp+1,this.msr.ixm+1,n+1,f])}if(this.curalts[d]=p,c)f='"_'+o+'"'+f;else if(void 0==p){var u=!0;switch(gGotMicrotonalAccidental=!0,h){case"natural-sharp":h="♮♯";break;case"natural-flat":h="♮♭";break;case"three-quarters-flat":h="♭;3/4";break;case"three-quarters-sharp":h="♯;3/4";break;case"sharp-down":h="↓♯";break;case"sharp-up":h="♯↑";break;case"natural-down":h="♮↓";break;case"natural-up":h="↑♮";break;case"flat-down":h="↓♭";break;case"flat-up":h="↑♭";break;case"double-sharp-down":h="↓♯♯";break;case"double-sharp-up":h="♯♯↑";break;case"flat-flat-down":h="↓♭♭";break;case"flat-flat-up":h="♭♭↑";break;case"arrow-down":h="↓";break;case"arrow-up":h="↑";break;case"triple-sharp":h="♯♯♯";break;case"triple-flat":h="♭♭♭";break;case"slash-quarter-sharp":h="♯/4";break;case"slash-quarter-flat":h="♭/4";break;case"slash-sharp":h="/♯";break;case"slash-flat":h="/♭";break;case"double-slash-flat":h="//♭";break;case"double-slash-sharp":h="//♯";break;case"sharp-1":h="♯1";break;case"sharp-2":h="♯2";break;case"sharp-3":h="♯3";break;case"sharp-4":h="♯4";break;case"sharp-5":h="♯5";break;case"flat-1":h="♭1";break;case"flat-2":h="♭2";break;case"flat-3":h="♭3";break;case"flat-4":h="♭4";break;case"flat-5":h="♭5";break;case"sori":h="sori";break;case"koron":h="koron";break;default:u=!1}u||(h=-1!=h.toLowerCase().indexOf("raise")||-1!=h.toLowerCase().indexOf("sharp")?"♯?":-1!=h.toLowerCase().indexOf("lower")||-1!=h.toLowerCase().indexOf("flat")?"♭?":-1!=h.toLowerCase().indexOf("natural")?"♮?":"?"),f='"_'+h+'"'+f}else f=["_/","__","_","=","^","^^","^/"][p+3]+f;return f},N.prototype.doNote=function(e){var i,s=new g(0,null),r=parseInt(e.find("voice").text()||"1");this.isSib&&(r+=100*(e.find("staff").text()||"1"));var a=e.find("chord").length>0,o=e.find("pitch>step").text()||e.find("unpitched>display-step").text(),c=e.find("pitch>octave").text()||e.find("unpitched>display-octave").text(),l=e.find("rest").length>0,p=e.find("time-modification>actual-notes").text();if(p){var f=e.find("time-modification>normal-notes").text();s.fact=[parseInt(p),parseInt(f)]}s.tup=e.find("notations>tuplet").map(function(){return $(this).attr("type")}).get();var d=e.find("duration").text(),u=e.find("grace");s.grace=u.length>0,s.before=[""],s.after="",s.grace&&!this.ingrace&&(this.ingrace=1,s.before=["{"],"yes"==u.attr("slash")&&s.before.push("/"));var m=!s.grace&&this.ingrace;if(m&&(this.ingrace=0,this.msc.lastnote.after+="}"),(!d||s.grace)&&(d=0),!l&&"no"==e.attr("print-object")){if(a)return;l=1}s.dur=parseInt(d),l||o&&c||(this.msc.cnt.inc("nopt",r),c=5,o="E");var _=0==(this.curClef&&this.curClef[this.curStf[r]]||"").indexOf("tab"),v=e.find("notations");v.length&&this.doNotations(s,v,_);var b=e.find("stem");if(!l&&b.length&&"none"==b.text()&&(!_||r in this.hasStems||this.tstep)&&(s.before.push("s"),h.stemless=1),(b=e.find("accidental")).length&&"yes"==b.attr("parentheses")&&(s.ntdec+="!courtesy!"),i=l?"no"==e.attr("print-object")||_?"x":"z":this.ntAbc(o,parseInt(c),e,r,s,_),e.find("unpitched").length){var x=this.curClef[this.curStf[r]],y=function e(i,n,s,r){var a,o=0;if(s.indexOf("stafflines=1")>=0&&(o+=4),!r&&s.indexOf("bass")>=0&&(o+=12),o){var h="CDEFGAB".split("");i=h[(a=h.indexOf(i)+o)%7],n+=Math.floor(a/7)}return n>4&&(i=i.toLowerCase()),n>5&&(i+=t(n-5,"'")),n<4&&(i+=t(4-n,",")),i}(o,parseInt(c),x,this.tstep),w=e.find("instrument"),k=w.length?w.attr("id"):"dummyId",j=this.drumInst[k]||O(i),M=e.find("notehead"),S=M.text().replace(" ","-");"x"==S&&(i="^"+i.replace(/\^/g,"").replace(/_/g,"")),("circle-x"==S||"diamond"==S||"triangle"==S)&&(i="_"+i.replace(/\^/g,"").replace(/_/g,"")),"yes"==M.attr("filled")&&(S+="+"),"no"==M.attr("filled")&&(S+="-"),this.drumNotes[r+";"+i]=[y,j,S]}var D=e.find("tie").add(e.find("notations>tied")).get();D.some(function(t){return"start"==$(t).attr("type")})&&(i+="-"),D=e.find("beam").map(function(){return $(this).text()}).get(),s.beam=D.indexOf("continue")>-1||D.indexOf("end")>-1||s.grace,D=e.find("lyric");for(var A=0,C=0;C<D.length;++C){var I=$(D[C]),L=parseInt((I.attr("number")||"1").replace(/^.*verse/,""));0==L?L=A+1:A=L,s.lyrs[L]=E(I)}var T=e.find("stem").text();if(this.wstems&&("up"==T||"down"==T)&&T!=this.stemDir[r]&&(this.stemDir[r]=T,this.msc.appendElem(r,n("[I:stemdir %s]",[T]))),a)this.msc.addChord(s,i);else{var F=parseInt(e.find("staff").text()||"1");if(this.curStf[r]!=F){var B=F-this.curStf[r];this.curStf[r]=F,this.msc.appendElem(r,"[I:staff "+(B>0?"+":"")+B+"]")}this.msc.appendNote(r,s,i)}for(C=0,D=e.find("notations>slur");C<D.length;++C){var N=$(D[C]);this.matchSlur(N.attr("type"),N.attr("number"),r,this.msc.lastnote,s.grace,m)}},N.prototype.doAttr=function(t){if(f={C1:"alto1",C2:"alto2",C3:"alto",C4:"tenor",F4:"bass",F3:"bass3",G2:"treble",TAB:"tab",percussion:"perc"},(d=t.find("divisions").text())&&(this.msr.divs=parseInt(d)),u=parseInt(t.find("transpose>chromatic").text()||"0"),m=t.find("key>fifths").first().text(),g=0==this.msc.tijd&&0==this.msr.ixm,m){var s,r,a,o,c,l,p;_=(T=(s=parseInt(m),r=t.find("key>mode").first().text()||"major",p={maj:8,ion:8,m:11,min:11,aeo:11,mix:9,dor:10,phr:12,lyd:7,loc:13,non:8},o=(l=["Fb","Cb","Gb","Db","Ab","Eb","Bb","F","C","G","D","A","E","B","F#","C#","G#","D#","A#","E#","B#"])[p[r=r.slice(0,3).toLowerCase()]+s]+(8!=p[r]?r:""),a=["F","C","G","D","A","E","B"],[o,c=s>=0?i(a.slice(0,s),e(s,1)):i(a.slice(s),e(-s,-1))]))[0],this.msralts=T[1],g&&!u&&"none"==h.key?h.key=_:_==h.key&&g||(this.msr.attr+="[K:"+_+"]")}(v=t.find("time>beats").text())&&(x=v+"/"+(b=t.find("time>beat-type").text()),g?h.mtr=x:this.msr.attr+="[M:"+x+"]",this.msr.mtr=[parseInt(v),parseInt(b)]),this.msr.mdur=this.msr.divs*this.msr.mtr[0]*4/this.msr.mtr[1];var f,d,u,m,g,_,v,b,x,y,w,k,O,j,M,S,D,A,C,I,E,L,T,F,B,N=this;for(t.find("measure-style").each(function(){var t,e,i,s,r,a,o;t=parseInt($(this).attr("number")||"1"),e=N.stfMap[t],$(this).find("measure-repeat").each(function(){"start"==(i=$(this).attr("type"))?(N.repeat_str[t]=[N.msr.ixm,$(this).text()],e.forEach(function(e){N.msc.insertElem(e,N.repeat_str[t])})):"stop"==i&&(s=N.repeat_str[t][0],a=N.repeat_str[t][1],r=N.msr.ixm-s,a?(o=a+" ",r/=parseInt(a)):o="",N.repeat_str[t][0]=n("[I:repeat %s%d]",[o,r]),delete N.repeat_str[t])})}),(y=t.find("transpose>octave-change").text()||"")&&(u+=12*parseInt(y)),E=t.find("clef"),I=0;I<E.length;I++){k=parseInt((w=$(E[I])).attr("number")||"1"),j="percussion"!=(O=w.find("sign").text())&&"TAB"!=O&&w.find("line").text()||"",M=f[O+j]||"",M+=({"-2":"-15","-1":"-8",1:"+8",2:"+15"})[S=w.find("clef-octave-change").text()||"0"]||"",this.clefOct[k]=-parseInt(S),u&&(M+=" transpose="+u);var V=t.find("staff-details");if(V.length&&(V.attr("number")||1)==k){(F=V.find("staff-lines").text())&&(M+=" stafflines="+(B="3"==F&&"TAB"==O?"|||":F),this.stafflines=parseInt(F));var q=V.find("staff-tuning"),z=[];q.each(function(){z.push($(this).find("tuning-step").text()+$(this).find("tuning-octave").text())}),z.length&&(M+=n(" strings=%s",[z.join(",")]));var G=V.find("capo").text();G&&(M+=n(" capo=%s",[G]))}if(this.curClef[k]=M,g)this.clefMap[k]=M;else for(L=0,D=this.stfMap[k];L<D.length;++L)A=D[L],k!=this.curStf[A]&&(C=k-this.curStf[A],this.curStf[A]=k,O=C>0?"+":"",this.msc.appendElem(A,"[I:staff "+O+C+"]")),this.msc.appendElem(A,"[K:"+M+"]")}},N.prototype.findVoice=function(t,e){var i,n,s,r,a,o,h;if(i=parseInt((s=e.eq(t)).find("staff").text()||"1"),n=(h=this.stfMap[i]).length?h[0]:1,this.dirtov1)return{sn:i,v:n,v1:n};for(r=t+1;r<e.length;++r){if("note"==(s=e.eq(r))[0].tagName)return a=parseInt(s.find("staff").text()||"1"),o=parseInt(s.find("voice").text()||"1"),this.isSib&&(o+=100*a),{sn:a=this.vce2stf[o],v:o,v1:n};if("backup"==s[0].tagName)break}return{sn:i,v:n,v1:n}},N.prototype.doDirection=function(t,e,i){function r(t,e,i,n,s){e&&(i=e.indexOf("!8v")>=0?t.stfMap[s]:[i]).forEach(function(i){null!=n?t.msc.appendElemT(i,e.replace("(",")").replace("ped","ped-up"),n):t.msc.appendElem(i,e)})}function a(t,e,i,n){var a,o,h,l;if(l={down:"!8va(!",up:"!8vb(!",crescendo:"!<(!",diminuendo:"!>(!",start:"!ped!"},u=c.attr("type")||"",a=e+(c.attr("number")||"1"),u in l)h=l[u],a in t.dirStk?(o=t.dirStk[a],delete t.dirStk[a],"stop"==o.type?r(t,h,i,o.tijd,n):(s("%s direction %s has no stop in part %d, measure %d, voice %d",[e,o.type,t.msr.ixp+1,t.msr.ixm+1,i+1]),t.dirStk[a]={type:u,vs:i})):t.dirStk[a]={type:u,vs:i};else if("stop"==u)a in t.dirStk?(o=t.dirStk[a],delete t.dirStk[a],u=o.type,i=o.vs,"stop"==u?(s("%s direction %s has double stop in part %d, measure %d, voice %d",[e,u,t.msr.ixp+1,t.msr.ixm+1,i+1]),h=""):h=l[o.type].replace("(",")").replace("ped","ped-up")):(t.dirStk[a]={type:"stop",tijd:t.msc.tijd},h="");else throw"wrong direction type";r(t,h,i,null,n)}var o,c,p,f,d,u,m,g,_,v,b,x,y,k,O,j,M,S,D,A,C,I="";o=t.attr("placement"),S=(m=this.findVoice(e,i)).sn,d=m.v,D=m.v1;var E="",L={dacapo:"D.C.",dalsegno:"D.S.",tocoda:"dacoda",fine:"fine",coda:"O",segno:"S"};if((c=t.find("sound")).length){if((b=c.find("midi-instrument")).length){for(k in x=c.find("midi-instrument>midi-program").text(),y=c.find("midi-instrument>midi-channel").text(),this.vceInst)this.vceInst[k]==b.attr("id")&&(d=k);O=x?"program":"channel",(j=(x?x-1:y)+"")&&h.volpan>0&&this.msc.appendElem(d,"[I:MIDI= "+O+" "+j+"]")}for(A in(p=c.attr("tempo"))&&(p=parseFloat(p).toFixed(0),C=[1,4]),L)if(c.attr(A)){E=L[A];break}}for(var T=t.children("direction-type"),F=0;F<T.length;++F){f=$(T[F]);var B={whole:[1,1],half:[1,2],quarter:[1,4],eighth:[1,8]},N=f.find("metronome");N.length&&(C=(c=N.find("beat-unit").text()||"")in B?B[c]:B.quarter,N.find("beat-unit-dot").length&&(C=w(3*C[0],2*C[1])),(A=N.find("per-minute").text().match(/[.\d]+/))&&(p=A[0])),(c=f.find("wedge")).length&&a(this,"wedge",d),0==(M=f.find("words")).length&&(M=f.find("rehearsal"));for(var V=0;V<M.length;++V){if(E){this.msc.appendElem(d,n("!%s!",[E]),1);break}g="below"==o?"_":"^";var q=$(M[V]);0>parseFloat(q.attr("default-y")||"0")&&(g="_"),I+=q.text().replace(/"/g,'\\"').replace(/\n/g,"\\n")}for(_ in I=I.trim(),l)v=l[_],f.find("dynamics>"+_).length&&this.msc.appendElem(d,v,1);f.find("coda").length&&this.msc.appendElem(d,"O",1),f.find("segno").length&&this.msc.appendElem(d,"S",1),(c=f.find("octave-shift")).length&&a(this,"octave-shift",d,S),(c=f.find("pedal")).length&&this.ped&&(this.pedVce||(this.pedVce=d),a(this,"pedal",this.pedVce)),"diatonic fretting"==f.find("other-direction").text()&&(this.diafret=1)}p&&(p=parseFloat(p).toFixed(0),0==this.msc.tijd&&0==this.msr.ixm?(h.tempo=p,h.tempo_units=C):this.msc.appendElem(D,n("[Q:%d/%d=%s]",[C[0],C[1],p]))),I&&this.msc.appendElem(d,'"'+g+I+'"',1)},N.prototype.doHarmony=function(t,e,i){var n,s,r,a,o,h,c,l,p,f,d,u,m,g,_;for(n=this.findVoice(e,i).v,s={major:"",minor:"m",augmented:"+",diminished:"dim",dominant:"7","half-diminished":"m7b5"},r={major:"maj",dominant:"",minor:"m",diminished:"dim",augmented:"+",suspended:"sus"},a={second:"2",fourth:"4",seventh:"7",sixth:"6",ninth:"9","11th":"11","13th":"13"},o={1:"#",0:"","-1":"b"},h=t.find("root>root-step","").text(),c=o[t.find("root>root-alter").text()]||"",l="",((p=t.find("kind").text())in s)?p=s[p]:p.indexOf("-")>-1?(f=(_=p.split("-"))[0],d=_[1],0==(p=(r[f]||"")+(a[d]||"")).indexOf("sus")&&(l=p,p="")):"none"==p&&(p=t.find("kind").attr("text")),u=t.find("degree"),e=0;e<u.length;++e)p+=(o[(g=$(u[e])).find("degree-alter").text()]||"")+g.find("degree-value").text();p=p.replace("79","9").replace("713","13").replace("maj6","6"),m=t.find("bass>bass-step").text()+(o[t.find("bass>bass-alter").text()]||""),this.msc.appendElem(n,' "'+h+c+p+l+(m&&"/"+m)+'"',1)},N.prototype.doBarline=function(t){var e=t.find("repeat"),i=0;if(e.length&&(i=e.attr("direction")),this.unfold)return i?"forward"==i?1:2:0;if("right"==(t.attr("location")||"right")){var n=t.find("bar-style").text();"light-light"==n?this.msr.rline="||":"light-heavy"==n&&(this.msr.rline="|]")}i&&("forward"==i?this.msr.lline=":":this.msr.rline=":|");var s=t.find("ending");if(s.length){if("start"==s.attr("type")){var r=(s.attr("number")||"1").replace(/\./g,"").replace(/ /g,"");/^[\d,]+$/.test(r)||(r='"'+r.trim()+'"'),this.msr.lnum=r}else"|"==this.msr.rline&&(this.msr.rline="||")}return 0},N.prototype.doPrint=function(t){if("yes"==t.attr("new-system")||"yes"==t.attr("new-page"))return this.nolbrk?"":"$"},N.prototype.doPartList=function(t){var e,i,s,r,a,o,h,c,l,p,f,d,u,m,g;for(e=0,a=t.find("part-list>score-part");e<a.length;++e){for(i=0,r=a[e],o={},h=$(r).find("midi-instrument");i<h.length;++i){for(s=0,c=$(h[i]),p=["midi-channel","midi-program","volume","pan"],l=[];s<p.length;++s)f=p[s],l.push(c.find(f).text()||this.midDflt[s]);(d=1*l[3])>=-90&&d<=90&&(d=(d+90)/180*127),o[c.attr("id")]=[parseInt(l[0]),parseInt(l[1]),1.27*parseFloat(l[2]),d],(g=c.find("midi-unpitched").text())&&(this.drumInst[c.attr("id")]=g-1)}this.instMid.push(o)}return function t(e,i,n){var s,r,a,o,h,c,l,p,f,d,u,m,g,_;if(0==e.length)return[[],[]];if("part-group"!=(s=e.shift())[0].tagName)return p=(_=t(e,i,n))[0],m=_[1],[[g=["name_tuple",s.find("part-name").text()||"",s.find("part-abbreviation").text()||""]].concat(p),m];if(r=s.attr("number"),"start"!=(a=s.attr("type")))return d=n.pop(),e.length&&"stop"==e[0].attr("type")&&r!=d&&(_=i[d],i[d]=i[r],i[r]=_),[[u=i[r]],e];for(h in o=[],{"group-symbol":0,"group-barline":0,"group-name":0,"group-abbreviation":0})o.push(s.find(h).text()||"");return i[r]=o,n.push(r),c=(_=t(e,i,n))[0],p=(_=t(l=_[1],i,n))[0],f=_[1],[[c].concat(p),f]}(l=function t(e){function i(t){return $(n('<part-group number="%d" type="%s"></part-group>',[t,"stop"]),f)}var s,r,a,o,h,c,l,p,f=e[0];for(s=[],r=[],l=e.children(),c=0;c<l.length;c++)"part-group"==(a=$(l[c]))[0].tagName?(o=a.attr("number"),h=a.attr("type"),p=r.indexOf(o),"start"==h?p>-1?(s.push(i(o)),s.push(a)):(s.push(a),r.push(o)):p>-1&&(r.splice(p,1),s.push(a))):s.push(a);for(c=r.length-1;c>=0;--c)o=r[c],s.push(i(o));return s}(u=t.find("part-list")),{},[])[0]},N.prototype.mkTitle=function(t){var e,i,n,r,a,o,c,l,p,f,d=[],u=[],m=[];for(r=0,e=t.find("work>work-title").text().trim(),i=t.find("movement-title").text().trim(),n=t.find("identification>creator");r<n.length;++r)o=(a=$(n[r])).text(),c=a.attr("type"),o&&(o=o.split("\n").map(function(t){return t.trim()}),"composer"==c?d.push.apply(d,o):("lyricist"==c||"transcriber"==c)&&u.push.apply(u,o));for(r=0,n=t.find("identification>rights");r<n.length;++r)(o=$(n[r]).text())&&(o=o.split("\n").map(function(t){return t.trim()}),u.push.apply(u,o));for(r=0,n=t.find("credit");r<n.length;++r){for(f=0,l="",p=$(n[r]).find("credit-words");f<p.length;++f)l+=$(p[f]).text();m.push(l.replace(/\s*[\r\n]\s*/g," "))}m=function t(n){var s,r,a=[];function o(t,e){return t&&e.indexOf(t)>-1}function h(t){return o(t,s)}for(r=0;r<m.length;++r)s=m[r],!(n<6&&(o(s,e)||o(s,i))||n<5&&(o(s,d)||o(s,u))||n<4&&(o(e,s)||o(i,s))||n<3&&(d.some(h)||u.some(h)))&&(n<2&&/^[\d\W]*$/.test(s)||a.push(s));return 0==n&&e+i&&(a=""),a}(this.ctf),e&&(e="T:"+e.replace(/\n/g,"\nT:")+"\n"),i&&(e+="T:"+i.replace(/\n/g,"\nT:")+"\n"),m.length&&(e+=m.map(function(t){return"T:"+t}).join("\n")+"\n"),d.length&&(e+=d.map(function(t){return"C:"+t}).join("\n")+"\n"),u.length&&(e+=u.map(function(t){return"Z:"+t}).join("\n")+"\n"),e&&(e=e.replaceAll("  "," ")),e&&(h.title=e.substr(0,e.length-1)),this.isSib=t.find("identification>encoding>software").text().indexOf("Sibelius")>=0,this.isSib&&s("Sibelius MusicXMl is unreliable",[])},N.prototype.doDefaults=function(t){var e,i,n,s,r,a,o,c,l,p;this.doPageFmt&&(e=t.find("defaults")).length&&(l=(i=e.find("scaling>millimeters").text())/(n=e.find("scaling>tenths").text())/10,s=e.find("page-layout>page-width").text()*l,r=(p=e.find("page-layout>page-margins").first()).find("left-margin").text(),a=p.find("right-margin").text(),c=(o=10*l)/.2117,!h.scale&&c&&(h.scale=c.toFixed(2)),!h.pagewidth&&s&&(h.pagewidth=s.toFixed(2)),h.leftmargin||""==r||(h.leftmargin=(r*l).toFixed(2)),h.rightmargin||""==a||(h.rightmargin=(a*l).toFixed(2)))},N.prototype.locStaffMap=function(t){var e={};this.vceInst={},this.msc.vnums={},this.hasStems={},this.stfMap={},this.clefMap={};for(var i=t.find("measure>note"),n=0;n<i.length;n++){var s=$(i[n]),r=parseInt(s.find("voice").text()||"1");this.isSib&&(r+=100*(s.find("staff").text()||"1")),this.msc.vnums[r]=1;var a=parseInt(s.find("staff").text()||"1");if(this.stfMap[a]=[],r in e){var o=e[r];o[a]=(o[a]||0)+1}else{var h={};h[a]=1,e[r]=h}(h=s.find("instrument")).length&&(this.vceInst[r]=$(h).attr("id")),h=s.find("stem"),0==s.find("rest").length&&(0==h.length||"none"!=h.text())&&(this.hasStems[r]=1)}for(r in e){var c=[],l=e[r];for(a in l)c.push([l[a],a]);c.sort(function(t,e){return t[0]-e[0]});var p=c[c.length-1][1];this.stfMap[p].push(r),this.vce2stf[r]=p,this.curStf[r]=p}},N.prototype.addStaffMap=function(t){var e,i,n,s,r,a,o,c,l,p=[],f=Object.keys(this.stfMap).sort();for(i=0;i<f.length;++i){for(a=f[i],r=this.stfMap[a],o=[],c=[],e=0;e<r.length;++e)(n=r[e])in t&&(o.push(t[n]),c.push(void 0==this.hasStems[n]));if(o.length)for(p.push(o),s=(a in this.clefMap)?this.clefMap[a]:"treble",e=0;e<o.length;++e)n=o[e],l="",0==s.indexOf("tab")&&(c[e]&&0>s.indexOf("nostems")&&(l=" nostems"),this.diafret&&0>s.indexOf("diafret")&&(l+=" diafret")),h.clefs[n]=s+l}this.gStfMap.push(p)},N.prototype.addMidiMap=function(t,e){var i,s=this.instMid[t],r=Object.keys(s);i=r.length?s[r[0]]:this.midDflt;var a,o,h,c,l,p=[],f=this;for(a in e)l=(r=Object.keys(this.drumNotes).sort().filter(function(t){return t.split(";")[0]==a})).map(function(t){return{nt:t.split(";")[1],step:f.drumNotes[t][0],midi:f.drumNotes[t][1],nhd:f.drumNotes[t][2]}}),o=e[a],(h=this.vceInst[a]||"")in s?p.push([o,s[h].concat(l)]):p.push([o,i.concat(l)]);p.sort(function(t,e){return t[0]-e[0]}),p.forEach(function(t){f.midiMap.push(t[1])});var d,u,m,g,_=["E","G","B","d","f","a","c'","e'"],v="0,1-,1,1+,2,3,3,4,4,5,6,6+,7,8-,8,8+,9,10,10,11,11,12,13,13+,14".split(",");for(c=0,r=Object.keys(this.tabmap).sort();c<r.length;++c)a=(p=(d=r[c]).match(/(\d+),(.*)/))[1],g=p[2],u=this.tabmap[d][0],m=this.tabmap[d][1],this.diafret&&(m=v[parseInt(m)]),o=e[a],u=this.stafflines-parseInt(u),(p=this.tabVceMap[o]||[]).push(n("%%map tab%d %s print=%s heads=kop%s\n",[o,g,_[u],m])),this.tabVceMap[o]=p,this.koppen[m]=1},N.prototype.parse=function(t){var e={},i=$(t);this.mkTitle(i),this.doDefaults(i);for(var r=this.doPartList(i),a=i.find("part"),o=0;o<a.length;++o){var c=a.eq(o),l=c.find("measure");this.locStaffMap(c),this.drumNotes={},this.clefOct={},this.curClef={},this.stemDir={},this.tabmap={},this.diafret=0,this.stafflines=5,this.msc.initVoices(1);var p=0,f=0,d=[];for(this.msr=new m(o);this.msr.ixm<l.length;){var u=l.eq(this.msr.ixm),g=0,_="";this.msr.reset(),this.curalts={};for(var v=u.children(),b=0;b<v.length;b++){var x=(i=v.eq(b))[0];switch(x.tagName){case"note":this.doNote(i);break;case"attributes":this.doAttr(i);break;case"direction":this.doDirection(i,b,v);break;case"sound":this.doDirection(u,b,v);break;case"harmony":this.doHarmony(i,b,v);break;case"barline":g=this.doBarline(i);break;case"backup":var y=parseInt(i.find("duration").text());B(y,this.msr)&&this.msc.incTime(-y);break;case"forward":B(y=parseInt(i.find("duration").text()),this.msr)&&this.msc.incTime(y);break;case"print":_=this.doPrint(i)}}this.msc.addBar(_,this.msr),d.push(this.msr.divs),1==g?(f=this.msr.ixm,this.msr.ixm+=1):2==g?p<1?(this.msr.ixm=f,p+=1):(p=0,this.msr.ixm+=1):this.msr.ixm+=1}for(var w in this.repeat_str){var k=this.repeat_str[w];k[0]=n("[I:repeat %s %d]",[k[1],1])}var O=this.msc.outVoices(d,o);for(w in this.addStaffMap(O),this.addMidiMap(o,O),O)e[w]=O[w]}Object.keys(e).length?h.mkHeader(this.gStfMap,r,this.midiMap,this.tabVceMap,this.koppen):s("nothing written, %s has no notes ...",[h.fnmext])},vertaal=function(t,e){gGotMicrotonalAccidental=!1;var i={u:0,b:0,n:0,c:0,v:0,d:0,m:0,x:0,t:0,v1:0,noped:0,stm:0,mnum:-1,p:"f",s:0,addstavenum:1};for(var n in e)i[n]=e[n];i.p=i.p?i.p.split(","):[],h=new x(".abc","",0,i);var r=new N(i);try{r.parse(t)}catch(a){s("** exception occurred: %s",[a])}return h.writeall()}}(),"undefined"!=typeof exports&&(exports.vertaal=vertaal,exports.xml2abc_VERSION=xml2abc_VERSION);